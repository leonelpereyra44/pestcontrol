<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Control - Sistema de Control de Plagas</title>
    <link rel="stylesheet" href="../css/ver-control.css">
</head>
<body>
    <div class="page-wrapper">
        <div class="container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-container">
                <div class="loading-spinner"></div>
                <p class="loading-text">Cargando informaci√≥n del control...</p>
            </div>

            <!-- Content (hidden initially) -->
            <div id="controlContent" style="display: none;">
                <!-- Header -->
                <div class="header">
                    <!-- Mobile header -->
                    <div class="header-content-mobile">
                        <a href="controles.html" class="btn-back-mobile" aria-label="Volver">
                            ‚Üê
                        </a>
                        <div class="header-title-mobile">
                            <h1 id="controlTitleMobile">üìã Control de Plagas</h1>
                            <p class="header-subtitle" id="controlSubtitleMobile"></p>
                        </div>
                        <button class="btn-menu-mobile" id="menuToggle" aria-label="Men√∫ de acciones">
                            ‚ãÆ
                        </button>
                    </div>
                    
                    <!-- Desktop header -->
                    <div class="header-title">
                        <h1 id="controlTitle">üìã Control de Plagas</h1>
                        <p class="header-subtitle" id="controlSubtitle"></p>
                    </div>
                    <div class="header-actions">
                        <a href="controles.html" class="btn btn-secondary">‚Üê Volver</a>
                        <button class="btn btn-primary" onclick="editarControl()">‚úèÔ∏è Editar</button>
                        <button class="btn btn-success" onclick="generarPDF()">üìÑ Generar PDF</button>
                        <button class="btn btn-danger" onclick="eliminarControl()">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
                
                <!-- Men√∫ mobile (desplegable) -->
                <div class="mobile-menu" id="mobileMenu">
                    <button class="mobile-menu-item" onclick="editarControl(); closeMobileMenu()">
                        <span class="mobile-menu-icon">‚úèÔ∏è</span>
                        <span class="mobile-menu-text">Editar Control</span>
                    </button>
                    <button class="mobile-menu-item" onclick="generarPDF(); closeMobileMenu()">
                        <span class="mobile-menu-icon">üìÑ</span>
                        <span class="mobile-menu-text">Generar PDF</span>
                    </button>
                    <button class="mobile-menu-item mobile-menu-item-danger" onclick="eliminarControl(); closeMobileMenu()">
                        <span class="mobile-menu-icon">üóëÔ∏è</span>
                        <span class="mobile-menu-text">Eliminar Control</span>
                    </button>
                </div>
                <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>

                <!-- Informaci√≥n General -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìã Informaci√≥n General</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-grid" id="infoGeneral"></div>
                    </div>
                </div>

                <!-- Productos Utilizados -->
                <div class="card">
                    <div class="card-header">
                        <h2>üß™ Productos Utilizados</h2>
                    </div>
                    <div class="card-body">
                        <div id="productosContainer"></div>
                    </div>
                </div>

                <!-- Puntos de Control -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìç Puntos de Control Revisados</h2>
                    </div>
                    <div class="card-body">
                        <div id="puntosContainer"></div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìù Observaciones Generales</h2>
                    </div>
                    <div class="card-body">
                        <div id="observacionesContainer"></div>
                    </div>
                </div>

                <!-- Firma del T√©cnico -->
                <div class="card">
                    <div class="card-header">
                        <h2>‚úçÔ∏è Firma del T√©cnico</h2>
                    </div>
                    <div class="card-body">
                        <div id="selloContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../ts/auth.js"></script>
    
    <script>
        // Usar el cliente de Supabase del auth.js
        const supabase = window.supabaseClient;
        let controlData = null;
        let workerProfile = null;

        // Obtener ID del control desde URL
        const urlParams = new URLSearchParams(window.location.search);
        const controlId = urlParams.get('id');

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Iniciando visualizaci√≥n del control...');
                
                // Verificar que tenemos un ID
                if (!controlId) {
                    alert('‚ùå ID de control no especificado');
                    window.location.href = 'controles.html';
                    return;
                }

                // Esperar a que auth.js se inicialice
                await new Promise(resolve => setTimeout(resolve, 500));

                // Verificar autenticaci√≥n
                if (!window.authUtils) {
                    alert('‚ùå Sistema de autenticaci√≥n no disponible');
                    window.location.href = 'login.html';
                    return;
                }

                workerProfile = await window.authUtils.getWorkerProfile();
                
                if (!workerProfile) {
                    alert('‚ùå Debes iniciar sesi√≥n primero');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('‚úÖ Usuario autenticado:', workerProfile);

                // Cargar datos del control
                await cargarControl();

            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                alert('Error al cargar el control: ' + error.message);
                window.location.href = 'controles.html';
            }
        });

        /**
         * Cargar informaci√≥n completa del control
         */
        async function cargarControl() {
            try {
                console.log('üì• Cargando control ID:', controlId);

                // Obtener control principal con informaci√≥n relacionada
                const { data: control, error: controlError } = await supabase
                    .from('controles')
                    .select(`
                        *,
                        cliente:clientes!controles_cliente_id_fkey(cliente_id, nombre),
                        planta:plantas!controles_planta_id_fkey(planta_id, nombre),
                        tecnico:worker!controles_tecnico_id_fkey(worker_id, nombre, puesto)
                    `)
                    .eq('control_id', controlId)
                    .eq('empresa_id', workerProfile.empresa_id)
                    .single();

                if (controlError) throw controlError;
                if (!control) throw new Error('Control no encontrado');

                controlData = control;
                console.log('‚úÖ Control cargado:', control);

                // Cargar productos
                const { data: productos, error: prodError } = await supabase
                    .from('control_productos')
                    .select(`
                        *,
                        producto:productos!control_productos_producto_id_fkey(
                            producto_id, 
                            nombre, 
                            unidad_medida,
                            tipo_producto,
                            principio_activo,
                            laboratorio,
                            certificado
                        )
                    `)
                    .eq('control_id', controlId);

                if (prodError) throw prodError;

                // Cargar puntos
                const { data: puntos, error: puntosError } = await supabase
                    .from('control_puntos')
                    .select('*')
                    .eq('control_id', controlId)
                    .order('numero_punto', { ascending: true });

                if (puntosError) throw puntosError;

                console.log('‚úÖ Productos:', productos?.length || 0);
                console.log('‚úÖ Puntos:', puntos?.length || 0);

                // Guardar productos y puntos en controlData para el PDF
                controlData.productos = productos || [];
                controlData.puntos = puntos || [];

                // Renderizar todo
                await renderizarControl(control, productos, puntos);

                // Ocultar loading y mostrar contenido
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('controlContent').style.display = 'block';

            } catch (error) {
                console.error('‚ùå Error cargando control:', error);
                throw error;
            }
        }

        /**
         * Renderizar informaci√≥n del control
         */
        async function renderizarControl(control, productos, puntos) {
            // T√≠tulo (Desktop)
            const tituloTexto = `üìã Control #${control.control_id.split('-')[0]}`;
            const subtituloTexto = `Control de ${control.tipo_control} - ${formatearFecha(control.fecha_control)}`;
            
            document.getElementById('controlTitle').textContent = tituloTexto;
            document.getElementById('controlSubtitle').textContent = subtituloTexto;
            
            // T√≠tulo (Mobile)
            document.getElementById('controlTitleMobile').textContent = tituloTexto;
            document.getElementById('controlSubtitleMobile').textContent = subtituloTexto;

            // Informaci√≥n general
            const infoGeneral = document.getElementById('infoGeneral');
            infoGeneral.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Cliente</span>
                    <span class="info-value">${control.cliente?.nombre || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Planta</span>
                    <span class="info-value ${!control.planta ? 'empty' : ''}">${control.planta?.nombre || 'Sin planta espec√≠fica'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">T√©cnico Responsable</span>
                    <span class="info-value">${control.tecnico?.nombre || 'N/A'}${control.tecnico?.puesto ? ' - ' + control.tecnico.puesto : ''}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Fecha del Control</span>
                    <span class="info-value">${formatearFecha(control.fecha_control)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Tipo de Control</span>
                    <span class="info-value">
                        <span class="badge badge-${control.tipo_control}">${formatearTipoControl(control.tipo_control)}</span>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Estado</span>
                    <span class="info-value">
                        <span class="badge badge-${control.estado}">${formatearEstado(control.estado)}</span>
                    </span>
                </div>
            `;

            // Productos
            renderizarProductos(productos);

            // Puntos
            renderizarPuntos(puntos);

            // Observaciones
            renderizarObservaciones(control.observaciones);

            // Sello
            await renderizarSello(control.firma_tecnico);
        }

        /**
         * Renderizar tabla de productos
         */
        function renderizarProductos(productos) {
            const container = document.getElementById('productosContainer');
            
            if (!productos || productos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p class="empty-state-message">No se utilizaron productos en este control</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Unidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productos.map(p => `
                                <tr>
                                    <td><strong>${p.producto?.nombre || 'Producto desconocido'}</strong></td>
                                    <td>${p.cantidad_usada}</td>
                                    <td>${p.unidad || p.producto?.unidad_medida || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        /**
         * Renderizar tabla de puntos agrupados por tipo de plaga
         */
        function renderizarPuntos(puntos) {
            const container = document.getElementById('puntosContainer');
            
            if (!puntos || puntos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <p class="empty-state-message">No se revisaron puntos de control espec√≠ficos</p>
                    </div>
                `;
                return;
            }

            // Agrupar por tipo de plaga (normalizado a min√∫sculas)
            const grupos = {
                'roedores': [],
                'voladores': [],
                'rastreros': []
            };
            
            puntos.forEach(punto => {
                const tipoPlaga = punto.tipo_plaga.toLowerCase();
                
                // Parsear descripcion_actividad si existe
                let datosAdicionales = {};
                if (punto.descripcion_actividad) {
                    try {
                        datosAdicionales = JSON.parse(punto.descripcion_actividad);
                    } catch (e) {
                        console.warn('Error parseando descripcion_actividad:', e);
                    }
                }
                
                // Combinar datos del punto con datos adicionales
                const puntoCompleto = {
                    ...punto,
                    ...datosAdicionales
                };
                
                if (grupos[tipoPlaga]) {
                    grupos[tipoPlaga].push(puntoCompleto);
                }
            });
            
            // Ordenar cada grupo por n√∫mero de punto
            Object.keys(grupos).forEach(tipo => {
                grupos[tipo].sort((a, b) => {
                    const numA = typeof a.numero_punto === 'number' ? a.numero_punto : parseInt(a.numero_punto) || 0;
                    const numB = typeof b.numero_punto === 'number' ? b.numero_punto : parseInt(b.numero_punto) || 0;
                    return numA - numB;
                });
            });
            
            // Configuraci√≥n de tipos
            const tiposConfig = {
                'roedores': { icono: 'üê≠', nombre: 'Roedores' },
                'voladores': { icono: 'ü¶ü', nombre: 'Voladores' },
                'rastreros': { icono: 'üêú', nombre: 'Rastreros' }
            };
            
            let html = '';
            
            Object.keys(grupos).forEach(tipoPlaga => {
                if (grupos[tipoPlaga].length > 0) {
                    const config = tiposConfig[tipoPlaga];
                    
                    html += `<div class="grupo-puntos-control">
                        <h3 class="grupo-titulo-control">${config.icono} ${config.nombre} (${grupos[tipoPlaga].length} puntos)</h3>
                        <div class="table-container">`;
                    
                    // Tabla espec√≠fica por tipo de plaga
                    if (tipoPlaga === 'roedores') {
                        html += `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Caja N¬∞</th>
                                        <th>Vivos</th>
                                        <th>Muertos</th>
                                        <th>Tipo Trampa</th>
                                        <th>M. Fecal</th>
                                        <th>Consumo</th>
                                        <th>Reposici√≥n</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${grupos[tipoPlaga].map(p => `
                                        <tr>
                                            <td><strong>${p.caja_n || p.numero_punto}</strong></td>
                                            <td>${p.vivos ? p.vivos.toUpperCase() : '-'}</td>
                                            <td>${p.muertos ? p.muertos.toUpperCase() : '-'}</td>
                                            <td>${p.tipo_trampa || p.tipo_dispositivo || '-'}</td>
                                            <td>${p.materia_fecal ? p.materia_fecal.toUpperCase() : '-'}</td>
                                            <td>${p.consumo ? p.consumo.toUpperCase() : '-'}</td>
                                            <td>${p.reposicion ? p.reposicion.toUpperCase() : '-'}</td>
                                            <td>${p.observaciones || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else if (tipoPlaga === 'voladores') {
                        html += `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Caja UV N¬∞</th>
                                        <th>Densidad</th>
                                        <th>Reposici√≥n</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${grupos[tipoPlaga].map(p => `
                                        <tr>
                                            <td><strong>${p.caja_uv || p.numero_punto}</strong></td>
                                            <td><span class="badge badge-${p.densidad || p.estado}">${p.densidad ? p.densidad.toUpperCase() : (p.estado || '-')}</span></td>
                                            <td>${p.reposicion ? p.reposicion.toUpperCase() : '-'}</td>
                                            <td>${p.observaciones || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else if (tipoPlaga === 'rastreros') {
                        html += `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ubicaci√≥n</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${grupos[tipoPlaga].map(p => `
                                        <tr>
                                            <td><strong>${p.ubicacion || p.numero_punto}</strong></td>
                                            <td>${p.observaciones || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                    
                    html += `
                        </div>
                    </div>`;
                }
            });
            
            container.innerHTML = html;
        }

        /**
         * Renderizar observaciones
         */
        function renderizarObservaciones(observaciones) {
            const container = document.getElementById('observacionesContainer');
            
            if (!observaciones || observaciones.trim() === '') {
                container.innerHTML = `
                    <div class="observaciones-text empty">
                        Sin observaciones registradas
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="observaciones-text">${observaciones}</div>
                `;
            }
        }

        /**
         * Renderizar sello del t√©cnico
         */
        async function renderizarSello(selloPath) {
            const container = document.getElementById('selloContainer');
            
            console.log('üîñ renderizarSello() llamado con:', selloPath);
            
            if (!selloPath) {
                console.log('‚ö†Ô∏è No hay sello para mostrar');
                container.innerHTML = `
                    <div class="sello-container">
                        <div class="sello-placeholder">
                            <p>üë§ Sin firma/sello del t√©cnico</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            try {
                // Limpiar el path (eliminar prefix 'workers/' si existe)
                let cleanPath = selloPath;
                if (cleanPath.startsWith('workers/')) {
                    cleanPath = cleanPath.substring(8);
                }
                
                console.log('üìÇ Path limpio:', cleanPath);
                
                // Obtener URL firmada desde storage
                const { data: urlData, error: urlError } = await supabase.storage
                    .from('workers')
                    .createSignedUrl(cleanPath, 3600);
                
                if (urlError) {
                    console.error('‚ùå Error generando URL firmada:', urlError);
                    container.innerHTML = `
                        <div class="sello-container">
                            <div class="sello-placeholder">
                                <p>‚ö†Ô∏è Error al cargar el sello</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                console.log('‚úÖ URL firmada generada:', urlData.signedUrl);
                
                container.innerHTML = `
                    <div class="sello-container">
                        <img src="${urlData.signedUrl}" alt="Firma del t√©cnico" class="sello-img" onload="console.log('‚úÖ Imagen cargada correctamente')" onerror="console.error('‚ùå Error al cargar imagen')">
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Error en renderizarSello:', error);
                container.innerHTML = `
                    <div class="sello-container">
                        <div class="sello-placeholder">
                            <p>‚ö†Ô∏è Error al cargar el sello</p>
                        </div>
                    </div>
                `;
            }
        }

        /**
         * Formatear fecha
         */
        function formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        /**
         * Formatear tipo de control
         */
        function formatearTipoControl(tipo) {
            const tipos = {
                'preventivo': 'Preventivo',
                'correctivo': 'Correctivo',
                'especial': 'Especial'
            };
            return tipos[tipo] || tipo;
        }

        /**
         * Formatear estado
         */
        function formatearEstado(estado) {
            const estados = {
                'completado': 'Completado',
                'pendiente': 'Pendiente',
                'en_progreso': 'En Progreso'
            };
            return estados[estado] || estado;
        }

        /**
         * Formatear tipo de plaga
         */
        function formatearTipoPlaga(tipo) {
            const tipos = {
                'roedores': 'Roedores',
                'voladores': 'Voladores',
                'rastreros': 'Rastreros'
            };
            return tipos[tipo] || tipo;
        }

        /**
         * Formatear estado de punto
         */
        function formatearEstadoPunto(estado) {
            const estados = {
                'ok': 'OK',
                'con_actividad': 'Con Actividad',
                'faltante': 'Faltante',
                'reemplazado': 'Reemplazado'
            };
            return estados[estado] || estado;
        }

        /**
         * Editar control
         */
        function editarControl() {
            window.location.href = `nuevo-control.html?id=${controlId}`;
        }

        /**
         * Generar PDF del control
         */
        async function generarPDF() {
            if (!controlData) {
                alert('No hay datos del control para generar PDF');
                return;
            }

            try {
                console.log('Iniciando generaci√≥n de PDF...');
                
                // Mostrar estado de carga
                const btnGenerarPDF = event.target;
                const btnTextoOriginal = btnGenerarPDF ? btnGenerarPDF.innerHTML : null;
                if (btnGenerarPDF) {
                    btnGenerarPDF.disabled = true;
                    btnGenerarPDF.innerHTML = 'Generando PDF...';
                }

                // ===== CARGAR LOGO DE LA EMPRESA =====
                let logoBase64 = '';
                try {
                    const { data: files, error: filesError } = await supabase.storage
                        .from('empresas')
                        .list(`${workerProfile.empresa_id}/logo`);

                    if (!filesError && files && files.length > 0) {
                        const logoFile = files[0];
                        const logoPath = `${workerProfile.empresa_id}/logo/${logoFile.name}`;
                        
                        const { data: signedUrlData, error: urlError } = await supabase.storage
                            .from('empresas')
                            .createSignedUrl(logoPath, 60);

                        if (!urlError && signedUrlData?.signedUrl) {
                            logoBase64 = await urlToBase64(signedUrlData.signedUrl);
                            console.log('Logo cargado');
                        }
                    }
                } catch (error) {
                    console.warn('No se pudo cargar logo:', error);
                }

                // ===== CARGAR FIRMA DEL T√âCNICO =====
                let firmaBase64 = '';
                if (controlData.firma_tecnico) {
                    try {
                        let storagePath = controlData.firma_tecnico;
                        if (storagePath.startsWith('workers/')) {
                            storagePath = storagePath.replace('workers/', '');
                        }

                        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
                            .from('workers')
                            .createSignedUrl(storagePath, 60);

                        if (!signedUrlError && signedUrlData?.signedUrl) {
                            firmaBase64 = await urlToBase64(signedUrlData.signedUrl);
                            console.log('Firma cargada');
                        }
                    } catch (error) {
                        console.error('Error cargando firma:', error);
                    }
                }

                // ===== GENERAR HTML COMPLETO =====
                const htmlContent = generarHTMLParaPDF(logoBase64, firmaBase64, controlData);

                // ===== CONVERTIR HTML A PDF =====
                const element = document.createElement('div');
                element.innerHTML = htmlContent;
                element.style.width = '210mm'; // A4 width
                element.style.backgroundColor = 'white';
                element.style.padding = '0';
                document.body.appendChild(element);

                // Usar html2canvas para capturar el HTML
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                document.body.removeChild(element);

                // Crear PDF con jsPDF
                const { jsPDF } = window.jspdf;
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                let position = 0;
                const pageHeight = 297; // A4 height in mm

                // Si el contenido es m√°s alto que una p√°gina, dividir en m√∫ltiples p√°ginas
                if (imgHeight > pageHeight) {
                    let heightLeft = imgHeight;
                    
                    while (heightLeft > 0) {
                        const sourceY = position > 0 ? (position * canvas.width) / imgWidth : 0;
                        const sourceHeight = Math.min((pageHeight * canvas.width) / imgWidth, canvas.height - sourceY);
                        
                        if (position > 0) {
                            pdf.addPage();
                        }
                        
                        pdf.addImage(
                            canvas.toDataURL('image/png'),
                            'PNG',
                            0,
                            position === 0 ? 0 : -position,
                            imgWidth,
                            imgHeight
                        );
                        
                        heightLeft -= pageHeight;
                        position += pageHeight;
                    }
                } else {
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                }

                // Guardar PDF
                const fecha = controlData.fecha_control.replace(/-/g, '');
                const cliente = (controlData.cliente?.nombre || 'Control').substring(0, 15).replace(/\s+/g, '_');
                const nombreArchivo = `MIP_SanAgustin_${cliente}_${fecha}.pdf`;
                pdf.save(nombreArchivo);

                console.log('PDF generado exitosamente:', nombreArchivo);

                // Restaurar bot√≥n
                if (btnGenerarPDF && btnTextoOriginal) {
                    btnGenerarPDF.disabled = false;
                    btnGenerarPDF.innerHTML = btnTextoOriginal;
                }

            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF: ' + error.message);
                
                const btnGenerarPDF = event.target;
                if (btnGenerarPDF) {
                    btnGenerarPDF.disabled = false;
                    btnGenerarPDF.innerHTML = 'Generar PDF';
                }
            }
        }

        /**
         * Generar HTML para PDF (similar a la app actual)
         */
        function generarHTMLParaPDF(logoBase64, firmaBase64, controlData) {
            let html = `
                <div style="margin: 40px; padding: 20px; font-family: Arial, sans-serif;">
                    <!-- ENCABEZADO CON LOGO -->
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 30px;">
                        ${logoBase64 ? `<img src="${logoBase64}" alt="Logo" style="width: 100px; height: auto; margin-right: 15px;"/>` : ''}
                        <h1 style="margin: 0; color: black; font-size: 24px;">Planilla de M.I.P SAN AGUSTIN</h1>
                    </div>
            `;

            // ===== TABLA EMPRESA =====
            html += `
                <h2 style="text-align: left; color: #333; font-size: 16px; margin-top: 20px;">Empresa</h2>
                <table style="width: 90%; margin: 0 auto; border-collapse: collapse; font-size: 12px; margin-bottom: 20px;">
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Cliente</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Planta</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Fecha</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${controlData.cliente?.nombre || 'N/A'}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${controlData.planta?.nombre || 'N/A'}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${formatearFecha(controlData.fecha_control)}</td>
                    </tr>
                </table>
            `;

            // ===== TABLA PRODUCTOS =====
            if (controlData.productos && controlData.productos.length > 0) {
                html += `
                    <h2 style="text-align: left; color: #333; font-size: 16px; margin-top: 20px;">Productos</h2>
                    <table style="width: 90%; margin: 0 auto; border-collapse: collapse; font-size: 12px; margin-bottom: 20px;">
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Producto</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Tipo</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">PrincipioActivo</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Laboratorio</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Certificado</th>
                        </tr>
                `;
                
                controlData.productos.forEach(producto => {
                    html += `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${producto.producto?.nombre || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${producto.producto?.tipo_producto || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${producto.producto?.principio_activo || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${producto.producto?.laboratorio || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${producto.producto?.certificado || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== TABLA ROEDORES =====
            const roedores = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'roedores') : [];
            if (roedores.length > 0) {
                html += `
                    <h2 style="text-align: left; color: #333; font-size: 16px; margin-top: 20px;">Roedores</h2>
                    <table style="width: 90%; margin: 0 auto; border-collapse: collapse; font-size: 11px; margin-bottom: 20px;">
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">Caja</th>
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">Vivos</th>
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">Muertos</th>
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">TipoTrampa</th>
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">MateriaFecal</th>
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">ConsumoCebos</th>
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">Reposici√≥n</th>
                            <th style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">Observaciones</th>
                        </tr>
                `;
                
                roedores.forEach(punto => {
                    let datosAdicionales = {};
                    if (punto.descripcion_actividad) {
                        try {
                            datosAdicionales = JSON.parse(punto.descripcion_actividad);
                        } catch (e) {}
                    }
                    const p = { ...punto, ...datosAdicionales };
                    
                    html += `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.caja_n || p.numero_punto || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.vivos || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.muertos || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.tipo_trampa || p.tipo_dispositivo || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.materia_fecal || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.consumo || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.reposicion || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${p.observaciones || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== TABLA VOLADORES =====
            const voladores = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'voladores') : [];
            if (voladores.length > 0) {
                html += `
                    <h2 style="text-align: left; color: #333; font-size: 16px; margin-top: 20px;">Voladores</h2>
                    <table style="width: 90%; margin: 0 auto; border-collapse: collapse; font-size: 12px; margin-bottom: 20px;">
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">UV</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Densidad</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Reposici√≥n</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Observaciones</th>
                        </tr>
                `;
                
                voladores.forEach(punto => {
                    let datosAdicionales = {};
                    if (punto.descripcion_actividad) {
                        try {
                            datosAdicionales = JSON.parse(punto.descripcion_actividad);
                        } catch (e) {}
                    }
                    const p = { ...punto, ...datosAdicionales };
                    const densidad = `Moscas: ${p.moscas || '-'}, Mosquitos: ${p.mosquitos || '-'}`;
                    
                    html += `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.caja_uv_n || p.numero_punto || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${densidad}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.reposicion || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.observaciones || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== TABLA RASTREROS =====
            const rastreros = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'rastreros') : [];
            if (rastreros.length > 0) {
                html += `
                    <h2 style="text-align: left; color: #333; font-size: 16px; margin-top: 20px;">Rastreros</h2>
                    <table style="width: 90%; margin: 0 auto; border-collapse: collapse; font-size: 12px; margin-bottom: 20px;">
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">√Årea</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Plaga</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Nivel</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Producto</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">Observaciones</th>
                        </tr>
                `;
                
                rastreros.forEach(punto => {
                    let datosAdicionales = {};
                    if (punto.descripcion_actividad) {
                        try {
                            datosAdicionales = JSON.parse(punto.descripcion_actividad);
                        } catch (e) {}
                    }
                    const p = { ...punto, ...datosAdicionales };
                    
                    html += `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.area || p.numero_punto || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.nombre_plaga || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.nivel_infestacion || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.producto_aplicado_nombre || '-'}</td>
                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${p.observaciones || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== OBSERVACIONES =====
            if (controlData.observaciones) {
                html += `
                    <h2 style="text-align: left; color: #333; font-size: 16px; margin-top: 20px;">Observaciones</h2>
                    <table style="width: 90%; margin: 0 auto; border-collapse: collapse; font-size: 12px; margin-bottom: 20px;">
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">observaciones</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 12px; text-align: left;">${controlData.observaciones}</td>
                        </tr>
                    </table>
                `;
            }

            // ===== LEYENDA R.P. y N.A. =====
            html += `
                <div style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 90%; margin-left: auto; margin-right: auto; background-color: #f9f9f9;">
                    <ul style="font-size: 12px; padding-left: 20px; color: #333; list-style-type: none; margin: 0;">
                        <li><strong>R.P</strong>: Refuerzo Provisorio</li>
                        <li><strong>N.A</strong>: No Aplica</li>
                    </ul>
                </div>
            `;

            // ===== FIRMA =====
            if (firmaBase64) {
                html += `
                    <div style="text-align: center; margin-top: 30px; margin-bottom: 20px;">
                        <img src="${firmaBase64}" alt="Firma" style="width: 200px; height: auto;" />
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">Firmado por: ${controlData.tecnico?.nombre || 'T√©cnico'}</p>
                    </div>
                `;
            }

            html += `</div>`;
            
            return html;
        }
                    const { data: files, error: filesError } = await supabase.storage
                        .from('empresas')
                        .list(`${workerProfile.empresa_id}/logo`);

                    if (!filesError && files && files.length > 0) {
                        const logoFile = files[0];
                        const logoPath = `${workerProfile.empresa_id}/logo/${logoFile.name}`;
                        
                        const { data: signedUrlData, error: urlError } = await supabase.storage
                            .from('empresas')
                            .createSignedUrl(logoPath, 60);

                        if (!urlError && signedUrlData?.signedUrl) {
                            logoImg = await urlToBase64(signedUrlData.signedUrl);
                            console.log('Logo de empresa cargado');
                        }
                    }
                } catch (error) {
                    console.warn('No se pudo cargar logo de empresa:', error);
                }

                // ===== ENCABEZADO CON LOGO =====
                if (logoImg) {
                    // Logo desde storage
                    doc.addImage(logoImg, 'PNG', margin, 10, 20, 20);
                }
                
                // T√≠tulo principal
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Planilla de M.I.P SAN AGUSTIN', 40, 20);
                
                currentY = 35;

                // ===== INFORMACI√ìN DE LA EMPRESA (TABLA) =====
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Empresa', margin, currentY);
                currentY += 6;

                // Tabla de empresa
                doc.setFontSize(9);
                const empresaHeaders = ['Cliente', 'Planta', 'Fecha'];
                const empresaData = [
                    controlData.cliente?.nombre || 'N/A',
                    controlData.planta?.nombre || 'N/A',
                    formatearFecha(controlData.fecha_control)
                ];

                // Encabezados
                doc.setFillColor(220, 220, 220);
                const colWidth = contentWidth / 3;
                empresaHeaders.forEach((header, i) => {
                    doc.rect(margin + (i * colWidth), currentY - 5, colWidth, 8, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.text(header, margin + (i * colWidth) + 2, currentY);
                });
                currentY += 8;

                // Datos
                doc.setFont('helvetica', 'normal');
                empresaData.forEach((data, i) => {
                    doc.rect(margin + (i * colWidth), currentY - 5, colWidth, 8, 'S');
                    doc.text(data, margin + (i * colWidth) + 2, currentY);
                });
                currentY += 12;

                // ===== PRODUCTOS =====
                console.log('Verificando productos para PDF...');
                if (controlData.productos && controlData.productos.length > 0) {
                    console.log('Generando tabla de productos:', controlData.productos.length);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Productos', margin, currentY);
                    currentY += 6;

                    // Tabla de productos (5 columnas)
                    doc.setFontSize(8);
                    const productoHeaders = ['Producto', 'Tipo', 'PrincipioActivo', 'Laboratorio', 'Certificado'];
                    const colWidths = [45, 25, 35, 30, 45]; // Total = 180
                    
                    // Encabezados
                    doc.setFillColor(220, 220, 220);
                    let xPos = margin;
                    productoHeaders.forEach((header, i) => {
                        doc.rect(xPos, currentY - 5, colWidths[i], 7, 'F');
                        doc.setFont('helvetica', 'bold');
                        doc.text(header, xPos + 2, currentY);
                        xPos += colWidths[i];
                    });
                    currentY += 7;

                    // Datos de productos
                    doc.setFont('helvetica', 'normal');
                    controlData.productos.forEach((producto, index) => {
                        if (currentY > pageHeight - 20) {
                            doc.addPage();
                            currentY = margin;
                        }

                        xPos = margin;
                        const rowData = [
                            producto.producto?.nombre || 'N/A',
                            producto.producto?.tipo_producto || '-',
                            producto.producto?.principio_activo || '-',
                            producto.producto?.laboratorio || '-',
                            producto.producto?.certificado || '-'
                        ];

                        // Alternar color de fondo
                        if (index % 2 === 0) {
                            doc.setFillColor(245, 245, 245);
                            doc.rect(margin, currentY - 5, contentWidth, 7, 'F');
                        }

                        rowData.forEach((data, i) => {
                            doc.rect(xPos, currentY - 5, colWidths[i], 7, 'S');
                            const textoCortado = data.length > 18 ? data.substring(0, 15) + '...' : data;
                            doc.text(textoCortado, xPos + 2, currentY);
                            xPos += colWidths[i];
                        });
                        currentY += 7;
                    });

                    currentY += 5;
                } else {
                    console.log('No hay productos para mostrar en PDF');
                }

                // ===== ROEDORES =====
                console.log('Verificando puntos para PDF...');
                const roedores = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'roedores') : [];
                console.log('Roedores encontrados:', roedores.length);
                if (roedores.length > 0) {
                    if (currentY > pageHeight - 40) {
                        doc.addPage();
                        currentY = margin;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Roedores', margin, currentY);
                    currentY += 6;

                    // Tabla de roedores (8 columnas)
                    doc.setFontSize(7);
                    const roedoresHeaders = ['Caja', 'Vivos', 'Muertos', 'TipoTrampa', 'MateriaFecal', 'ConsumoCebos', 'Reposici√≥n', 'Observaciones'];
                    const roedoresWidths = [15, 15, 18, 25, 25, 28, 22, 32]; // Total = 180
                    
                    // Encabezados
                    doc.setFillColor(220, 220, 220);
                    let xPos = margin;
                    roedoresHeaders.forEach((header, i) => {
                        doc.rect(xPos, currentY - 4, roedoresWidths[i], 6, 'F');
                        doc.setFont('helvetica', 'bold');
                        doc.text(header, xPos + 1, currentY);
                        xPos += roedoresWidths[i];
                    });
                    currentY += 6;

                    // Datos de roedores
                    doc.setFont('helvetica', 'normal');
                    roedores.forEach((punto, index) => {
                        if (currentY > pageHeight - 15) {
                            doc.addPage();
                            currentY = margin;
                        }

                        let datosAdicionales = {};
                        if (punto.descripcion_actividad) {
                            try {
                                datosAdicionales = JSON.parse(punto.descripcion_actividad);
                            } catch (e) {}
                        }
                        const puntoCompleto = { ...punto, ...datosAdicionales };

                        xPos = margin;
                        const rowData = [
                            (puntoCompleto.caja_n || puntoCompleto.numero_punto || '-').toString(),
                            (puntoCompleto.vivos || '-').toString(),
                            (puntoCompleto.muertos || '-').toString(),
                            (puntoCompleto.tipo_trampa || puntoCompleto.tipo_dispositivo || '-').toString(),
                            (puntoCompleto.materia_fecal || '-').toString(),
                            (puntoCompleto.consumo || '-').toString(),
                            (puntoCompleto.reposicion || '-').toString(),
                            (puntoCompleto.observaciones || '-').toString()
                        ];

                        // Alternar color
                        if (index % 2 === 0) {
                            doc.setFillColor(245, 245, 245);
                            doc.rect(margin, currentY - 4, contentWidth, 6, 'F');
                        }

                        rowData.forEach((data, i) => {
                            doc.rect(xPos, currentY - 4, roedoresWidths[i], 6, 'S');
                            let textoCortado = data;
                            if (i === 7) { // Observaciones
                                textoCortado = data.length > 15 ? data.substring(0, 12) + '...' : data;
                            } else if (i === 3) { // TipoTrampa
                                textoCortado = data.length > 12 ? data.substring(0, 9) + '...' : data;
                            }
                            doc.text(textoCortado, xPos + 1, currentY);
                            xPos += roedoresWidths[i];
                        });
                        currentY += 6;
                    });

                    currentY += 5;
                } else {
                    console.log('No hay roedores para mostrar en PDF');
                }

                // ===== VOLADORES =====
                const voladores = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'voladores') : [];
                console.log('Voladores encontrados:', voladores.length);
                if (voladores.length > 0) {
                    if (currentY > pageHeight - 40) {
                        doc.addPage();
                        currentY = margin;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Voladores', margin, currentY);
                    currentY += 6;

                    // Tabla de voladores (4 columnas)
                    doc.setFontSize(8);
                    const voladoresHeaders = ['UV', 'Densidad', 'Reposici√≥n', 'Observaciones'];
                    const voladoresWidths = [30, 50, 50, 50]; // Total = 180
                    
                    // Encabezados
                    doc.setFillColor(220, 220, 220);
                    let xPos = margin;
                    voladoresHeaders.forEach((header, i) => {
                        doc.rect(xPos, currentY - 5, voladoresWidths[i], 7, 'F');
                        doc.setFont('helvetica', 'bold');
                        doc.text(header, xPos + 2, currentY);
                        xPos += voladoresWidths[i];
                    });
                    currentY += 7;

                    // Datos de voladores
                    doc.setFont('helvetica', 'normal');
                    voladores.forEach((punto, index) => {
                        if (currentY > pageHeight - 15) {
                            doc.addPage();
                            currentY = margin;
                        }

                        let datosAdicionales = {};
                        if (punto.descripcion_actividad) {
                            try {
                                datosAdicionales = JSON.parse(punto.descripcion_actividad);
                            } catch (e) {}
                        }
                        const puntoCompleto = { ...punto, ...datosAdicionales };

                        xPos = margin;
                        
                        // Construir densidad
                        const moscas = puntoCompleto.moscas || '-';
                        const mosquitos = puntoCompleto.mosquitos || '-';
                        const densidad = `M: ${moscas} | Mq: ${mosquitos}`;
                        
                        const rowData = [
                            (puntoCompleto.caja_uv_n || puntoCompleto.numero_punto || '-').toString(),
                            densidad,
                            (puntoCompleto.reposicion || '-').toString(),
                            (puntoCompleto.observaciones || '-').toString()
                        ];

                        // Alternar color
                        if (index % 2 === 0) {
                            doc.setFillColor(245, 245, 245);
                            doc.rect(margin, currentY - 5, contentWidth, 7, 'F');
                        }

                        rowData.forEach((data, i) => {
                            doc.rect(xPos, currentY - 5, voladoresWidths[i], 7, 'S');
                            const textoCortado = data.length > 25 ? data.substring(0, 22) + '...' : data;
                            doc.text(textoCortado, xPos + 2, currentY);
                            xPos += voladoresWidths[i];
                        });
                        currentY += 7;
                    });

                    currentY += 5;
                } else {
                    console.log('No hay voladores para mostrar en PDF');
                }

                // ===== RASTREROS =====
                const rastreros = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'rastreros') : [];
                console.log('Rastreros encontrados:', rastreros.length);
                if (rastreros.length > 0) {
                    if (currentY > pageHeight - 40) {
                        doc.addPage();
                        currentY = margin;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Rastreros', margin, currentY);
                    currentY += 6;

                    // Tabla de rastreros (5 columnas)
                    doc.setFontSize(7);
                    const rastrerosHeaders = ['Area', 'Plaga', 'Nivel', 'Producto', 'Observaciones'];
                    const rastrerosWidths = [25, 35, 30, 45, 45]; // Total = 180
                    
                    // Encabezados
                    doc.setFillColor(220, 220, 220);
                    let xPos = margin;
                    rastrerosHeaders.forEach((header, i) => {
                        doc.rect(xPos, currentY - 5, rastrerosWidths[i], 7, 'F');
                        doc.setFont('helvetica', 'bold');
                        doc.text(header, xPos + 2, currentY);
                        xPos += rastrerosWidths[i];
                    });
                    currentY += 7;

                    // Datos de rastreros
                    doc.setFont('helvetica', 'normal');
                    rastreros.forEach((punto, index) => {
                        if (currentY > pageHeight - 15) {
                            doc.addPage();
                            currentY = margin;
                        }

                        let datosAdicionales = {};
                        if (punto.descripcion_actividad) {
                            try {
                                datosAdicionales = JSON.parse(punto.descripcion_actividad);
                            } catch (e) {}
                        }
                        const puntoCompleto = { ...punto, ...datosAdicionales };

                        xPos = margin;
                        const rowData = [
                            (puntoCompleto.area || puntoCompleto.numero_punto || '-').toString(),
                            (puntoCompleto.nombre_plaga || '-').toString(),
                            (puntoCompleto.nivel_infestacion || '-').toString(),
                            (puntoCompleto.producto_aplicado_nombre || '-').toString(),
                            (puntoCompleto.observaciones || '-').toString()
                        ];

                        // Alternar color
                        if (index % 2 === 0) {
                            doc.setFillColor(245, 245, 245);
                            doc.rect(margin, currentY - 5, contentWidth, 7, 'F');
                        }

                        rowData.forEach((data, i) => {
                            doc.rect(xPos, currentY - 5, rastrerosWidths[i], 7, 'S');
                            const textoCortado = data.length > 20 ? data.substring(0, 17) + '...' : data;
                            doc.text(textoCortado, xPos + 2, currentY);
                            xPos += rastrerosWidths[i];
                        });
                        currentY += 7;
                    });

                    currentY += 5;
                } else {
                    console.log('No hay rastreros para mostrar en PDF');
                }

                // ===== OBSERVACIONES =====
                if (controlData.observaciones) {
                    if (currentY > pageHeight - 30) {
                        doc.addPage();
                        currentY = margin;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Observaciones', margin, currentY);
                    currentY += 6;

                    // Tabla de observaciones
                    doc.setFillColor(220, 220, 220);
                    doc.rect(margin, currentY - 5, contentWidth, 7, 'F');
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('observaciones', margin + 2, currentY);
                    currentY += 7;

                    // Contenido
                    doc.setFont('helvetica', 'normal');
                    doc.rect(margin, currentY - 5, contentWidth, 15, 'S');
                    const lineasObs = doc.splitTextToSize(controlData.observaciones, contentWidth - 4);
                    doc.text(lineasObs, margin + 2, currentY);
                    currentY += 20;

                    // Leyenda R.P. y N.A.
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('R.P.', margin + 2, currentY);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Refuerzo Provisorio', margin + 12, currentY);
                    currentY += 4;
                    doc.setFont('helvetica', 'bold');
                    doc.text('N.A.', margin + 2, currentY);
                    doc.setFont('helvetica', 'normal');
                    doc.text('No Aplica', margin + 12, currentY);
                    currentY += 10;
                }

                // ===== FIRMA/SELLO DEL T√âCNICO =====
                if (controlData.firma_tecnico) {
                    if (currentY > pageHeight - 60) {
                        doc.addPage();
                        currentY = margin + 10;
                    }

                    try {
                        // Limpiar path y generar URL firmada
                        let storagePath = controlData.firma_tecnico;
                        if (storagePath.startsWith('workers/')) {
                            storagePath = storagePath.replace('workers/', '');
                        }

                        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
                            .from('workers')
                            .createSignedUrl(storagePath, 60);

                        if (signedUrlError) throw signedUrlError;

                        if (signedUrlData?.signedUrl) {
                            // Cargar imagen como base64
                            const imgData = await urlToBase64(signedUrlData.signedUrl);
                            
                            // Centrar imagen
                            const imgWidth = 50;
                            const imgHeight = 30;
                            const imgX = (pageWidth - imgWidth) / 2;
                            doc.addImage(imgData, 'PNG', imgX, currentY, imgWidth, imgHeight);
                            currentY += imgHeight + 3;

                            // Texto centrado
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'italic');
                            const firmaTexto = `Firmado por: ${controlData.tecnico?.nombre || 'T√©cnico'}`;
                            const textWidth = doc.getTextWidth(firmaTexto);
                            doc.text(firmaTexto, (pageWidth - textWidth) / 2, currentY);
                        }
                    } catch (error) {
                        console.error('Error al agregar sello al PDF:', error);
                    }
                }

                // ===== PIE DE P√ÅGINA =====
                const totalPages = doc.internal.pages.length - 1;
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(128, 128, 128);
                    doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }

                // Guardar PDF
                const fecha = controlData.fecha_control.replace(/-/g, '');
                const cliente = controlData.cliente?.nombre.substring(0, 10) || 'Control';
                const nombreArchivo = `MIP_SanAgustin_${cliente}_${fecha}.pdf`;
                doc.save(nombreArchivo);

                console.log('PDF generado exitosamente:', nombreArchivo);

                // Restaurar bot√≥n
                if (btnGenerarPDF && btnTextoOriginal) {
                    btnGenerarPDF.disabled = false;
                    btnGenerarPDF.innerHTML = btnTextoOriginal;
                }

            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Por favor, intenta nuevamente.');
                
                // Restaurar bot√≥n en caso de error
                const btnGenerarPDF = event.target;
                if (btnGenerarPDF) {
                    btnGenerarPDF.disabled = false;
                    btnGenerarPDF.innerHTML = 'Generar PDF';
                }
            }
        }

        /**
         * Convertir URL de imagen a Base64 para incluir en PDF
         */
        async function urlToBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                img.onerror = function(error) {
                    console.error('Error al cargar imagen para PDF:', error);
                    reject(error);
                };
                img.src = url;
            });
        }

        /**
         * Eliminar control
         */
        async function eliminarControl() {
            if (!confirm('‚ö†Ô∏è ¬øEst√° seguro de que desea eliminar este control?\n\nEsta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Eliminando control...');

                // Eliminar control (los productos y puntos se eliminar√°n autom√°ticamente por CASCADE)
                const { error } = await supabase
                    .from('controles')
                    .delete()
                    .eq('control_id', controlId)
                    .eq('empresa_id', workerProfile.empresa_id);

                if (error) throw error;

                alert('‚úÖ Control eliminado exitosamente');
                window.location.href = 'controles.html';

            } catch (error) {
                console.error('‚ùå Error eliminando control:', error);
                alert('Error al eliminar control: ' + error.message);
            }
        }
        
        /**
         * Controlar men√∫ mobile
         */
        const menuToggle = document.getElementById('menuToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
        
        if (menuToggle) {
            menuToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                mobileMenu.classList.toggle('active');
                mobileMenuOverlay.classList.toggle('active');
                document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
            });
        }
        
        function closeMobileMenu() {
            mobileMenu.classList.remove('active');
            mobileMenuOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    </script>
</body>
</html>
