<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Control de Plagas</title>
    <!-- Sistema de componentes -->
    <link rel="stylesheet" href="../css/nuevo-control.css">
</head>
<body>
    <div class="page-wrapper">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <a href="controles.html" class="btn-back-mobile" aria-label="Volver">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                        <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
                <div class="header-title">
                    <h1 id="pageTitle">Nuevo Control de Plagas</h1>
                    <p class="current-step-text">Paso <span id="currentStepNumber">1</span> de 5: <span id="currentStepName">Informaci√≥n General</span></p>
                </div>
                <button class="wizard-toggle" id="wizardToggle" aria-label="Men√∫ de navegaci√≥n">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                        <path d="M3 10H17M3 5H17M3 15H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <a href="controles.html" class="btn btn-secondary btn-back-header">
                ‚Üê Volver
            </a>
        </div>
        
        <!-- Wizard Steps (Collapsible) -->
        <div class="wizard-steps" id="wizardSteps">
            <div class="wizard-overlay" id="wizardOverlay"></div>
            <div class="wizard-menu" id="wizardMenu">
                <div class="wizard-drag-handle" aria-hidden="true"></div>
                <div class="wizard-menu-header">
                    <h3>Pasos del Control</h3>
                    <button class="wizard-close" id="wizardClose">‚úï</button>
                </div>
                <div class="wizard-step" data-step="1">
                    <span class="wizard-step-number">1</span>
                    <span class="wizard-step-title">Informaci√≥n General</span>
                    <span class="wizard-step-status">‚úì</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <span class="wizard-step-number">2</span>
                    <span class="wizard-step-title">Productos</span>
                    <span class="wizard-step-status"></span>
                </div>
                <div class="wizard-step" data-step="3">
                    <span class="wizard-step-number">3</span>
                    <span class="wizard-step-title">Puntos de Control</span>
                    <span class="wizard-step-status"></span>
                </div>
                <div class="wizard-step" data-step="4">
                    <span class="wizard-step-number">4</span>
                    <span class="wizard-step-title">Observaciones</span>
                    <span class="wizard-step-status"></span>
                </div>
                <div class="wizard-step" data-step="5">
                    <span class="wizard-step-number">5</span>
                    <span class="wizard-step-title">Sello</span>
                    <span class="wizard-step-status"></span>
                </div>
            </div>
        </div>
        
        <!-- Step 1: Informaci√≥n General -->
        <div class="step-content active" data-step="1">
            <h2>Informaci√≥n General del Control</h2>
            
            <div class="form-row">
                <div class="form-group required">
                    <label for="clienteId">Cliente</label>
                    <select id="clienteId" class="form-control" required>
                        <option value="">Seleccione un cliente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="plantaId">Planta</label>
                    <select id="plantaId" class="form-control">
                        <option value="">Sin planta espec√≠fica</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group required">
                    <label for="tecnicoId">T√©cnico Responsable</label>
                    <select id="tecnicoId" class="form-control" required>
                        <option value="">Seleccione un t√©cnico</option>
                    </select>
                </div>
                
                <div class="form-group required">
                    <label for="fechaControl">Fecha del Control</label>
                    <input type="date" id="fechaControl" class="form-control" required>
                </div>
            </div>
            
            <!-- Preview del sello del t√©cnico -->
            <div id="selloPreviewContainer" class="sello-preview-card hidden">
                <div class="sello-preview-header">
                    <h3>Sello del T√©cnico Seleccionado</h3>
                </div>
                <div class="sello-preview-content">
                    <div id="selloPreviewPlaceholder" class="sello-placeholder">
                        Seleccione un t√©cnico para ver su sello
                    </div>
                    <img id="selloPreviewImg" class="hidden" alt="Sello del t√©cnico">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group required">
                    <label for="tipoControl">Tipo de Control</label>
                    <select id="tipoControl" class="form-control" required>
                        <option value="">Seleccione tipo</option>
                        <option value="preventivo">Preventivo</option>
                        <option value="correctivo">Correctivo</option>
                        <option value="especial">Especial</option>
                    </select>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success btn-lg" id="btnComenzarControl" onclick="comenzarControl()">
                    üöÄ Comenzar Control
                </button>
            </div>
        </div>
        
        <!-- Step 2: Productos -->
        <div class="step-content" data-step="2">
            <h2>Productos Utilizados</h2>
            
            <div class="alert alert-info">
                <p>üí° Agregue los productos que utiliz√≥ en este control. Puede dejar esta secci√≥n vac√≠a si no aplic√≥ productos.</p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="productoSelect">Producto</label>
                    <select id="productoSelect" class="form-control">
                        <option value="">Seleccione un producto</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cantidadProducto">Cantidad</label>
                    <input type="number" id="cantidadProducto" class="form-control" step="0.01" min="0.01">
                </div>
                
                <div class="form-group">
                    <label for="unidadProducto">Unidad</label>
                    <input type="text" id="unidadProducto" class="form-control" readonly>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="agregarProducto()">
                + Agregar Producto
            </button>
            
            <div id="productosAgregados">
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <p class="empty-state-message">No se han agregado productos</p>
                </div>
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-secondary" onclick="wizard.prevStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary btn-lg" onclick="wizard.nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 3: Puntos de Control -->
        <div class="step-content" data-step="3">
            <!-- Ocultos en mobile por CSS para ahorrar espacio visual -->
            <h2 class="ocultar-mobile">üìç Puntos de Control por Tipo de Plaga</h2>
            
            <div class="alert alert-info ocultar-mobile">
                <p>üí° Puede dejar secciones vac√≠as si no aplican.</p>
            </div>
            
            <!-- Tabs de Navegaci√≥n -->
            <div class="tabs-container tabs-centradas-mobile">
                <button class="tab-button active" data-tab="roedores" onclick="cambiarTab('roedores')">
                    üê≠ Roedores
                </button>
                <button class="tab-button" data-tab="voladores" onclick="cambiarTab('voladores')">
                    ü¶ü Voladores
                </button>
                <button class="tab-button" data-tab="rastreros" onclick="cambiarTab('rastreros')">
                    üêú Rastreros
                </button>
            </div>
            
            <!-- Secci√≥n Roedores -->
            <div class="tab-content active" id="tab-roedores">
                <h3>üê≠ Control de Roedores</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cajaNRoedores">Caja N¬∞ *</label>
                        <input type="number" id="cajaNRoedores" class="form-control" placeholder="N√∫mero de caja" inputmode="numeric" pattern="[0-9]*" min="0" step="1" autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="vivosRoedores">Vivos *</label>
                        <select id="vivosRoedores" class="form-control">
                            <option value="">Seleccione</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                            <option value="na">N.A</option>
                            <option value="rp">R.P</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="muertosRoedores">Muertos *</label>
                        <select id="muertosRoedores" class="form-control">
                            <option value="">Seleccione</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                            <option value="na">N.A</option>
                            <option value="rp">R.P</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoTrampaRoedores">Tipo de Trampa *</label>
                        <select id="tipoTrampaRoedores" class="form-control">
                            <option value="">Seleccione</option>
                            <option value="pega">Pega</option>
                            <option value="trampa">Trampa</option>
                            <option value="cebo">Cebo</option>
                            <option value="otra">Otra</option>
                            <option value="na">N.A</option>
                            <option value="rp">R.P</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="materiaFecalRoedores">Materia Fecal *</label>
                        <select id="materiaFecalRoedores" class="form-control">
                            <option value="">Seleccione</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                            <option value="na">N.A</option>
                            <option value="rp">R.P</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="consumoRoedores">Consumo *</label>
                        <select id="consumoRoedores" class="form-control">
                            <option value="">Seleccione</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                            <option value="na">N.A</option>
                            <option value="rp">R.P</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="reposicionRoedores">Reposici√≥n *</label>
                        <select id="reposicionRoedores" class="form-control">
                            <option value="">Seleccione</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                            <option value="na">N.A</option>
                            <option value="rp">R.P</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacionesRoedores">Observaciones</label>
                        <input type="text" id="observacionesRoedores" class="form-control" placeholder="Observaciones del punto">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="agregarPunto('roedores')">
                    + Agregar Punto de Roedores
                </button>
                
                <div id="puntosAgregadosRoedores" style="margin-top: 20px;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üê≠</div>
                        <p class="empty-state-message">No se han agregado puntos de roedores</p>
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n Voladores -->
            <div class="tab-content" id="tab-voladores">
                <h3>ü¶ü Control de Voladores</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cajaUVVoladores">Caja UV N¬∞ *</label>
                        <input type="number" id="cajaUVVoladores" class="form-control" placeholder="N√∫mero de caja UV" inputmode="numeric" pattern="[0-9]*" min="0" step="1" autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="densidadVoladores">Densidad *</label>
                        <select id="densidadVoladores" class="form-control">
                            <option value="">Seleccione densidad</option>
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                            <option value="na">N.A</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="reposicionVoladores">Reposici√≥n</label>
                        <select id="reposicionVoladores" class="form-control">
                            <option value="">Seleccione reposici√≥n</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                            <option value="na">N.A</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacionesVoladores">Observaciones</label>
                        <input type="text" id="observacionesVoladores" class="form-control" placeholder="Observaciones del punto">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="agregarPunto('voladores')">
                    + Agregar Punto de Voladores
                </button>
                
                <div id="puntosAgregadosVoladores" style="margin-top: 20px;">
                    <div class="empty-state">
                        <div class="empty-state-icon">ü¶ü</div>
                        <p class="empty-state-message">No se han agregado puntos de voladores</p>
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n Rastreros -->
            <div class="tab-content" id="tab-rastreros">
                <h3>üêú Control de Rastreros</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ubicacionRastreros">Ubicaci√≥n *</label>
                        <input type="text" id="ubicacionRastreros" class="form-control" placeholder="Descripci√≥n de la ubicaci√≥n">
                    </div>
                    
                    <div class="form-group">
                        <label for="observacionesRastreros">Observaciones</label>
                        <input type="text" id="observacionesRastreros" class="form-control" placeholder="Observaciones del punto">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="agregarPunto('rastreros')">
                    + Agregar Punto de Rastreros
                </button>
                
                <div id="puntosAgregadosRastreros" style="margin-top: 20px;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üêú</div>
                        <p class="empty-state-message">No se han agregado puntos de rastreros</p>
                    </div>
                </div>
            </div>
            
            <!-- Bot√≥n para ver lista completa -->
            <div style="margin-top: 24px; text-align: center; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="mostrarListaPuntos()">
                    üìã Ver Todos los Puntos
                </button>
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-secondary" onclick="wizard.prevStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary btn-lg" onclick="wizard.nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 4: Observaciones -->
        <div class="step-content" data-step="4">
            <h2>Observaciones Generales</h2>
            
            <div class="form-group">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" class="form-control" rows="8" placeholder="Ingrese observaciones generales del control, hallazgos importantes, recomendaciones, etc."></textarea>
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-secondary" onclick="wizard.prevStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary btn-lg" onclick="wizard.nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 5: Sello -->
        <div class="step-content" data-step="5">
            <h2>Sello del T√©cnico</h2>
            
            <div class="alert alert-info">
                <p>üìå El sello se carga autom√°ticamente seg√∫n el t√©cnico responsable seleccionado en el Paso 1.</p>
            </div>
            
            <div class="sello-container">
                <div id="selloTecnicoPlaceholder" class="sello-placeholder">
                    <p>üë§ Seleccione un t√©cnico para ver su sello</p>
                </div>
                <img id="selloTecnicoImg" class="hidden" alt="Sello del t√©cnico">
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success btn-lg" onclick="completarControl()">
                    <span id="btnCompletarText">‚úÖ Completar Control</span>
                </button>
            </div>
        </div>
        </div>
    </div>
    </div> <!-- Cierre page-wrapper -->
    
    <!-- Modal para ver lista de puntos -->
    <div class="modal-overlay" id="modalListaPuntos">
        <div class="modal-content modal-lista-puntos">
            <div class="modal-header">
                <h3>üìç Lista de Puntos de Control</h3>
                <button class="modal-close" onclick="cerrarModalPuntos()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="listaPuntosModal">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalPuntos()">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Toast para notificaciones -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../ts/config.js"></script>
    <script src="../ts/auth.js"></script>
    
    <!-- M√≥dulos -->
    <script src="../js/controles/indexeddb-manager.js"></script>
    <script src="../js/controles/data-loader.js"></script>
    <script src="../js/controles/sello-manager.js"></script>
    <script src="../js/controles/wizard-manager.js"></script>
    <script src="../js/controles/productos-manager.js"></script>
    <script src="../js/controles/puntos-manager.js"></script>
    <script src="../js/controles/control-manager.js"></script>
    
    <!-- Script Principal -->
    <script>
        // Usar el cliente de Supabase del auth.js
        const supabase = window.supabaseClient;
        
        // Variables globales
        let workerProfile = null;
        let dataLoader = null;
        let wizard = null;
        let productosManager = null;
        let puntosManager = null;
        let controlManager = null;
        let selloManager = null;
        let dbManager = null; // IndexedDB Manager
        let localControlId = null; // ID del control local (IndexedDB)
        let editMode = false; // Modo edici√≥n (Supabase)
        let currentControlId = null; // ID del control que se est√° editando (Supabase)
        let draftMode = false; // Modo borrador (IndexedDB)
        let currentControlData = null; // Datos del control actual (para borradores)
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Esperar a que auth.js se inicialice completamente
                await new Promise(resolve => setTimeout(resolve, 500));
                
                console.log('üöÄ Iniciando aplicaci√≥n...');
                
                // Verificar que authUtils est√© disponible
                if (!window.authUtils) {
                    console.error('‚ùå authUtils no est√° disponible');
                    alert('Error: Sistema de autenticaci√≥n no disponible');
                    return;
                }
                
                console.log('‚úÖ Dependencias cargadas correctamente');
                
                // Verificar autenticaci√≥n
                workerProfile = await window.authUtils.getWorkerProfile();
                
                if (!workerProfile) {
                    console.warn('‚ö†Ô∏è Usuario no autenticado');
                    alert('‚ùå Debes iniciar sesi√≥n primero');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('‚úÖ Usuario autenticado:', workerProfile);
                
                // Inicializar IndexedDB
                dbManager = new IndexedDBManager();
                await dbManager.init();
                console.log('‚úÖ IndexedDB inicializada');
                
                // Detectar modo edici√≥n (Supabase) o draft (IndexedDB)
                const urlParams = new URLSearchParams(window.location.search);
                currentControlId = urlParams.get('id'); // ID de Supabase
                const draftId = urlParams.get('draft'); // ID de IndexedDB
                
                editMode = !!currentControlId;
                draftMode = !!draftId;
                
                if (editMode) {
                    console.log('üìù Modo edici√≥n - Control ID:', currentControlId);
                    document.getElementById('pageTitle').textContent = '‚úèÔ∏è Editar Control de Plagas';
                    document.getElementById('btnCompletarText').textContent = 'üíæ Actualizar Control';
                } else if (draftMode) {
                    console.log('üìÑ Modo borrador - Draft ID:', draftId);
                    localControlId = parseInt(draftId);
                    document.getElementById('pageTitle').textContent = 'üìÑ Continuar Control';
                }
                
                // Inicializar managers
                dataLoader = new DataLoader(supabase, workerProfile);
                selloManager = new SelloManager(supabase);
                wizard = new WizardManager();
                // Enforce numeric-only for Caja N (roedores) and Caja UV (voladores) and show numeric keyboard
                const enforcers = [
                    document.getElementById('cajaNRoedores'),
                    document.getElementById('cajaUVVoladores')
                ];
                enforcers.forEach(el => {
                    if (!el) return;
                    // sanitize on input
                    el.addEventListener('input', () => {
                        // Keep only digits
                        const digits = el.value.replace(/\D+/g, '');
                        if (el.value !== digits) el.value = digits;
                    });
                    // On blur: normalize to remove leading zeros (e.g., '0012' -> '12', '000' -> '0')
                    el.addEventListener('blur', () => {
                        const digits = (el.value || '').replace(/\D+/g, '');
                        if (digits === '') {
                            el.value = '';
                            return;
                        }
                        const normalized = String(parseInt(digits, 10));
                        el.value = isNaN(Number(normalized)) ? '' : normalized;
                    });
                });
                productosManager = new ProductosManager();
                puntosManager = new PuntosManager();
                controlManager = new ControlManager(supabase, workerProfile);
                
                console.log('‚úÖ Managers inicializados');
                
                // Cargar datos iniciales
                await inicializarFormulario();
                
                // Si estamos en modo edici√≥n (Supabase), cargar datos del control
                if (editMode) {
                    await cargarControlExistente(currentControlId);
                }
                // Si estamos en modo borrador (IndexedDB), cargar datos del draft
                else if (draftMode) {
                    await cargarControlDraft(localControlId);
                }
                
                // Configurar event listeners
                configurarEventListeners();
                
                console.log('‚úÖ Aplicaci√≥n lista');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                alert('Error al iniciar la aplicaci√≥n: ' + error.message);
            }
        });
        
        /**
         * Inicializar formulario con datos
         */
        async function inicializarFormulario() {
            try {
                // Cargar clientes
                const clientes = await dataLoader.cargarClientes();
                llenarSelect('clienteId', clientes, 'cliente_id', 'nombre');
                
                // Cargar t√©cnicos
                const tecnicos = await dataLoader.cargarTecnicos();
                llenarSelect('tecnicoId', tecnicos, 'worker_id', (t) => `${t.nombre}${t.puesto ? ' - ' + t.puesto : ''}`);
                
                // Cargar productos
                const productos = await dataLoader.cargarProductos();
                llenarSelect('productoSelect', productos, 'producto_id', (p) => `${p.nombre} (${p.tipo_producto || 'N/A'})`);
                
                // Establecer fecha actual
                document.getElementById('fechaControl').valueAsDate = new Date();
                
                console.log('‚úÖ Formulario inicializado');
                
            } catch (error) {
                console.error('‚ùå Error inicializando formulario:', error);
                throw error;
            }
        }
        
        /**
         * Cargar datos de control existente para edici√≥n
         */
        async function cargarControlExistente(controlId) {
            try {
                console.log('üì• Cargando control existente:', controlId);
                
                // Activar modo edici√≥n
                editMode = true;
                console.log('‚úÖ Modo edici√≥n activado');
                
                // 1. Cargar datos del control
                const { data: control, error: controlError } = await supabase
                    .from('controles')
                    .select(`
                        *,
                        cliente:clientes!controles_cliente_id_fkey(cliente_id, nombre),
                        planta:plantas!controles_planta_id_fkey(planta_id, nombre),
                        tecnico:worker!controles_tecnico_id_fkey(worker_id, nombre, puesto)
                    `)
                    .eq('control_id', controlId)
                    .single();
                
                if (controlError) throw controlError;
                if (!control) throw new Error('Control no encontrado');
                
                console.log('‚úÖ Control cargado:', control);
                
                // 2. Pre-llenar formulario (DESPU√âS de que dataLoader haya cargado los selects)
                // Esperar a que los selects est√©n poblados verificando que tengan opciones
                let intentos = 0;
                while (intentos < 20) { // M√°ximo 2 segundos (20 x 100ms)
                    const clienteSelect = document.getElementById('clienteId');
                    const tecnicoSelect = document.getElementById('tecnicoId');
                    
                    if (clienteSelect.options.length > 1 && tecnicoSelect.options.length > 1) {
                        console.log('‚úÖ Selects poblados, procediendo a llenar formulario');
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    intentos++;
                }
                
                if (intentos >= 20) {
                    console.warn('‚ö†Ô∏è Timeout esperando que los selects se pueblen');
                }
                
                // Asignar valores b√°sicos
                document.getElementById('clienteId').value = control.cliente_id;
                document.getElementById('fechaControl').value = control.fecha_control.split('T')[0]; // Formato YYYY-MM-DD
                document.getElementById('tipoControl').value = control.tipo_control;
                document.getElementById('observaciones').value = control.observaciones || '';
                document.getElementById('tecnicoId').value = control.tecnico_id;
                
                console.log('üìù Valores asignados al formulario:', {
                    cliente_id: control.cliente_id,
                    fecha: control.fecha_control.split('T')[0],
                    tipo: control.tipo_control,
                    tecnico: control.tecnico_id,
                    clienteSelect_value: document.getElementById('clienteId').value,
                    tecnicoSelect_value: document.getElementById('tecnicoId').value
                });
                
                // Cargar plantas del cliente seleccionado
                if (control.cliente_id) {
                    const plantas = await dataLoader.cargarPlantas(control.cliente_id);
                    llenarSelect('plantaId', plantas, 'planta_id', 'nombre', true);
                    if (control.planta_id) {
                        document.getElementById('plantaId').value = control.planta_id;
                    }
                }
                
                console.log('‚úÖ Formulario pre-llenado completamente');
                
                // Cargar sello del t√©cnico
                if (control.firma_tecnico) {
                    // Si el control tiene un sello guardado, usarlo
                    console.log('üîñ Cargando sello guardado del control:', control.firma_tecnico);
                    
                    // Guardar la URL del sello
                    selloManager.selloUrl = control.firma_tecnico;
                    
                    // Extraer solo el path (puede venir con o sin prefijo del bucket)
                    let selloPath = control.firma_tecnico;
                    if (selloPath.startsWith('workers/')) {
                        selloPath = selloPath.substring(8); // Eliminar 'workers/'
                    }
                    
                    console.log('üìÇ Path del sello:', selloPath);
                    
                    // Obtener URL firmada para mostrar
                    const { data: urlData, error: urlError } = await supabase.storage
                        .from('workers')
                        .createSignedUrl(selloPath, 3600);
                    
                    if (urlError) {
                        console.error('‚ùå Error generando URL firmada:', urlError);
                        console.log('‚ÑπÔ∏è Intentando cargar sello del t√©cnico seleccionado...');
                        // Si falla, intentar cargar el sello actual del t√©cnico
                        await selloManager.cargarSello(control.tecnico_id);
                    } else if (urlData) {
                        console.log('‚úÖ URL firmada generada correctamente');
                        selloManager.mostrarImagen(urlData.signedUrl);
                    }
                } else if (control.tecnico_id) {
                    // Si no hay sello guardado, cargar el sello actual del t√©cnico
                    console.log('üîñ Cargando sello actual del t√©cnico:', control.tecnico_id);
                    await selloManager.cargarSello(control.tecnico_id);
                }
                
                // 3. Cargar productos
                const { data: productos, error: prodError } = await supabase
                    .from('control_productos')
                    .select(`
                        *,
                        producto:productos!control_productos_producto_id_fkey(
                            producto_id,
                            nombre,
                            tipo_producto,
                            unidad_medida
                        )
                    `)
                    .eq('control_id', controlId);
                
                if (prodError) throw prodError;
                
                if (productos && productos.length > 0) {
                    console.log(`üì¶ Cargando ${productos.length} productos...`);
                    productos.forEach(p => {
                        productosManager.agregar({
                            producto_id: p.producto_id,
                            nombre: p.producto?.nombre,
                            tipo: p.producto?.tipo_producto,
                            cantidad: p.cantidad_usada,
                            unidad: p.unidad
                        });
                    });
                }
                
                // 4. Cargar puntos de control
                const { data: puntos, error: puntosError } = await supabase
                    .from('control_puntos')
                    .select('*')
                    .eq('control_id', controlId)
                    .order('numero_punto', { ascending: true });
                
                if (puntosError) throw puntosError;
                
                if (puntos && puntos.length > 0) {
                    console.log(`üìç Cargando ${puntos.length} puntos...`);
                    
                    // Agregar puntos directamente al array sin renderizar cada uno
                    puntos.forEach(p => {
                        // Parsear descripcion_actividad si existe
                        let datosAdicionales = {};
                        if (p.descripcion_actividad) {
                            try {
                                datosAdicionales = JSON.parse(p.descripcion_actividad);
                            } catch (e) {
                                console.warn('Error parseando descripcion_actividad:', e);
                            }
                        }
                        
                        const puntoCompleto = {
                            numero: p.numero_punto,
                            tipo_plaga: p.tipo_plaga,
                            tipo_dispositivo: p.tipo_dispositivo,
                            ubicacion: p.ubicacion,
                            estado: p.estado,
                            accion_realizada: p.accion_realizada,
                            actividad_detectada: p.estado === 'con_actividad',
                            ...datosAdicionales // Expandir los datos adicionales
                        };
                        
                        // Agregar directamente al array sin llamar a agregar() para evitar validaci√≥n de duplicados en carga
                        puntosManager.puntos.push(puntoCompleto);
                    });
                    
                    // Actualizar la vista de cada tipo de plaga (sin renderizar el listado general)
                    const tiposPlagas = [...new Set(puntos.map(p => p.tipo_plaga))];
                    tiposPlagas.forEach(tipo => {
                        if (tipo) {
                            actualizarVistaPuntos(tipo);
                        }
                    });
                    
                    console.log(`‚úÖ ${puntos.length} puntos cargados y mostrados en tablas espec√≠ficas`);
                }
                
                // Ocultar bot√≥n "Comenzar Control" en modo edici√≥n
                const btnComenzar = document.getElementById('btnComenzarControl');
                if (btnComenzar) {
                    btnComenzar.style.display = 'none';
                }
                
                console.log('‚úÖ Control cargado completamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando control:', error);
                alert('Error al cargar el control: ' + error.message);
                window.location.href = 'controles.html';
            }
        }
        
        /**
         * Cargar datos de control desde IndexedDB (modo borrador)
         */
        async function cargarControlDraft(localId) {
            try {
                console.log('üì• Cargando control draft desde IndexedDB:', localId);
                
                // 1. Cargar datos del control
                const control = await dbManager.obtenerControl(localId);
                
                if (!control) {
                    throw new Error('Control draft no encontrado en IndexedDB');
                }
                
                console.log('‚úÖ Control draft cargado:', control);
                
                // Guardar datos del control actual
                currentControlData = control;
                
                // 2. Pre-llenar formulario
                document.getElementById('clienteId').value = control.cliente_id;
                document.getElementById('fechaControl').value = control.fecha_control;
                document.getElementById('tipoControl').value = control.tipo_control;
                document.getElementById('observaciones').value = control.observaciones || '';
                
                // Cargar plantas del cliente seleccionado
                if (control.cliente_id) {
                    const plantas = await dataLoader.cargarPlantas(control.cliente_id);
                    llenarSelect('plantaId', plantas, 'planta_id', 'nombre', true);
                    if (control.planta_id) {
                        document.getElementById('plantaId').value = control.planta_id;
                    }
                }
                
                // Seleccionar t√©cnico
                document.getElementById('tecnicoId').value = control.tecnico_id;
                
                // Cargar sello del t√©cnico
                if (control.tecnico_id) {
                    await selloManager.cargarSello(control.tecnico_id);
                }
                
                // 3. Cargar productos
                const productos = await dbManager.obtenerProductos(localId);
                
                if (productos && productos.length > 0) {
                    console.log(`üì¶ Cargando ${productos.length} productos desde draft...`);
                    productos.forEach(p => {
                        productosManager.agregar({
                            producto_id: p.producto_id,
                            nombre: p.nombre,
                            tipo: p.tipo_producto || p.tipo,
                            cantidad: p.cantidad,
                            unidad: p.unidad
                        });
                    });
                }
                
                // 4. Cargar puntos de control
                const puntos = await dbManager.obtenerPuntos(localId);
                
                if (puntos && puntos.length > 0) {
                    console.log(`üìç Cargando ${puntos.length} puntos desde draft...`);
                    puntos.forEach(p => {
                        console.log('üìä Punto desde IndexedDB:', p);
                        // Usar spread operator para mantener TODOS los campos
                        puntosManager.agregar({
                            ...p, // Copia TODOS los campos del punto (incluidos los espec√≠ficos)
                            numero: p.numero,
                            tipo_plaga: p.tipo_plaga
                        });
                    });
                    
                    // Actualizar la vista de cada tipo de plaga
                    const tiposPlagas = [...new Set(puntos.map(p => p.tipo_plaga))];
                    tiposPlagas.forEach(tipo => {
                        if (tipo) {
                            actualizarVistaPuntos(tipo);
                        }
                    });
                }
                
                console.log('‚úÖ Control draft cargado completamente');
                
                // Habilitar navegaci√≥n a otros pasos
                document.getElementById('btnComenzarControl').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error cargando control draft:', error);
                alert('Error al cargar el borrador: ' + error.message);
                window.location.href = 'controles.html';
            }
        }
        
        /**
         * Comenzar nuevo control (guardar en IndexedDB)
         */
        async function comenzarControl() {
            try {
                // Validar campos obligatorios (IDs son UUIDs, no integers)
                const clienteId = document.getElementById('clienteId').value;
                const plantaId = document.getElementById('plantaId').value || null;
                const tecnicoId = document.getElementById('tecnicoId').value;
                const fechaControl = document.getElementById('fechaControl').value;
                const tipoControl = document.getElementById('tipoControl').value;
                
                console.log('üìã Valores del formulario:', {
                    clienteId,
                    plantaId,
                    tecnicoId,
                    fechaControl,
                    tipoControl
                });
                
                if (!clienteId || clienteId === '') {
                    alert('‚ö†Ô∏è Debe seleccionar un cliente');
                    return;
                }
                
                if (!tecnicoId || tecnicoId === '') {
                    alert('‚ö†Ô∏è Debe seleccionar un t√©cnico responsable');
                    return;
                }
                
                if (!fechaControl) {
                    alert('‚ö†Ô∏è Debe seleccionar una fecha');
                    return;
                }
                
                if (!tipoControl) {
                    alert('‚ö†Ô∏è Debe seleccionar un tipo de control');
                    return;
                }
                
                console.log('üöÄ Creando control en IndexedDB...');
                
                // Crear control en IndexedDB
                const controlData = {
                    empresa_id: workerProfile.empresa_id,
                    cliente_id: clienteId,
                    planta_id: plantaId,
                    tecnico_id: tecnicoId,
                    fecha_control: fechaControl,
                    tipo_control: tipoControl,
                    observaciones: null,
                    estado: 'borrador'
                };
                
                localControlId = await dbManager.guardarControl(controlData);
                console.log('‚úÖ Control creado en IndexedDB con ID:', localControlId);
                
                // Guardar datos del control actual
                currentControlData = controlData;
                
                // Cambiar bot√≥n
                document.getElementById('btnComenzarControl').style.display = 'none';
                
                // Mostrar mensaje
                alert('‚úÖ Control iniciado. Puedes continuar agregando productos y puntos.');
                
                // Avanzar al siguiente paso
                wizard.nextStep();
                
            } catch (error) {
                console.error('‚ùå Error creando control:', error);
                alert('Error al crear el control: ' + error.message);
            }
        }
        
        /**
         * Configurar event listeners
         */
        function configurarEventListeners() {
            // Cliente cambia -> cargar plantas
            document.getElementById('clienteId').addEventListener('change', async (e) => {
                const clienteId = e.target.value;
                if (clienteId) {
                    const plantas = await dataLoader.cargarPlantas(clienteId);
                    llenarSelect('plantaId', plantas, 'planta_id', 'nombre', true);
                }
            });
            
            // T√©cnico cambia -> cargar sello
            document.getElementById('tecnicoId').addEventListener('change', async (e) => {
                const tecnicoId = e.target.value;
                if (tecnicoId) {
                    await selloManager.cargarSello(tecnicoId);
                } else {
                    selloManager.limpiar();
                }
            });
            
            // Producto cambia -> actualizar unidad
            document.getElementById('productoSelect').addEventListener('change', (e) => {
                const select = e.target;
                const option = select.options[select.selectedIndex];
                const productos = dataLoader.supabase ? null : []; // Obtener del data loader si es necesario
                
                // Buscar producto seleccionado para obtener unidad
                const productoId = select.value;
                if (productoId) {
                    // Por ahora usar dataset del option
                    const unidad = option.dataset.unidad || '';
                    document.getElementById('unidadProducto').value = unidad;
                }
            });
            
            console.log('‚úÖ Event listeners configurados');
            
            // Control del men√∫ hamburguesa
            const wizardToggle = document.getElementById('wizardToggle');
            const wizardMenu = document.getElementById('wizardMenu');
            const wizardOverlay = document.getElementById('wizardOverlay');
            const wizardClose = document.getElementById('wizardClose');
            
            function abrirMenu() {
                wizardMenu.classList.add('active');
                wizardOverlay.classList.add('active');
                wizardToggle.classList.add('active');
                document.body.classList.add('menu-open');
                document.body.style.overflow = 'hidden';
            }
            
            function cerrarMenu() {
                wizardMenu.classList.remove('active');
                wizardOverlay.classList.remove('active');
                wizardToggle.classList.remove('active');
                document.body.classList.remove('menu-open');
                document.body.style.overflow = '';
            }
            
            wizardToggle.addEventListener('click', () => {
                if (wizardMenu.classList.contains('active')) {
                    cerrarMenu();
                } else {
                    abrirMenu();
                }
            });
            
            wizardClose.addEventListener('click', cerrarMenu);
            wizardOverlay.addEventListener('click', cerrarMenu);
            
            // Cerrar men√∫ al hacer clic en un paso
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.addEventListener('click', () => {
                    cerrarMenu();
                });
            });
        }
        
        /**
         * Llenar un select con opciones
         */
        function llenarSelect(selectId, items, valueKey, textKey, keepFirst = false) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Mantener primera opci√≥n si es necesario
            if (!keepFirst) {
                const firstOption = select.options[0];
                select.innerHTML = '';
                if (firstOption) {
                    select.appendChild(firstOption);
                }
            } else {
                // Limpiar opciones excepto la primera
                while (select.options.length > 1) {
                    select.remove(1);
                }
            }
            
            // Agregar items
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = typeof textKey === 'function' ? textKey(item) : item[textKey];
                
                // Guardar unidad como dataset si es un producto
                if (item.unidad_medida) {
                    option.dataset.unidad = item.unidad_medida;
                }
                
                select.appendChild(option);
            });
        }
        
        /**
         * Agregar producto a la lista
         */
        async function agregarProducto() {
            try {
                const productoSelect = document.getElementById('productoSelect');
                const cantidad = document.getElementById('cantidadProducto').value;
                const unidad = document.getElementById('unidadProducto').value;
                
                if (!productoSelect.value) {
                    alert('‚ö†Ô∏è Seleccione un producto');
                    return;
                }
                
                if (!cantidad || parseFloat(cantidad) <= 0) {
                    alert('‚ö†Ô∏è Ingrese una cantidad v√°lida');
                    return;
                }
                
                // Verificar que existe un control iniciado
                if (!localControlId && !editMode) {
                    alert('‚ö†Ô∏è Debe comenzar el control primero (Paso 1)');
                    wizard.goToStep(1);
                    return;
                }
                
                const producto = {
                    producto_id: productoSelect.value,
                    nombre: productoSelect.options[productoSelect.selectedIndex].text,
                    cantidad: parseFloat(cantidad),
                    unidad: unidad
                };
                
                productosManager.agregar(producto);
                
                // Guardar en IndexedDB si estamos en modo draft
                if (localControlId && !editMode) {
                    await dbManager.sincronizarProductos(localControlId, productosManager.getAll());
                    console.log('‚úÖ Productos guardados en IndexedDB');
                    mostrarToast(`üíæ Producto "${producto.nombre}" guardado en borrador`, 'success', 2000);
                } else if (editMode) {
                    mostrarToast(`‚úÖ Producto agregado (se guardar√° al completar)`, 'info', 2000);
                }
                
                // Limpiar campos
                productoSelect.value = '';
                document.getElementById('cantidadProducto').value = '';
                document.getElementById('unidadProducto').value = '';
                
            } catch (error) {
                console.error('‚ùå Error agregando producto:', error);
                alert('Error: ' + error.message);
            }
        }
        
        /**
         * Agregar punto de control a la lista (con tipo de plaga)
         */
        async function agregarPunto(tipoPlaga) {
            try {
                let punto = {};
                
                // Verificar que existe un control iniciado
                if (!localControlId && !editMode) {
                    alert('‚ö†Ô∏è Debe comenzar el control primero (Paso 1)');
                    wizard.goToStep(1);
                    return;
                }
                
                // Campos espec√≠ficos por tipo de plaga
                if (tipoPlaga === 'voladores') {
                    // Formulario de voladores: Caja UV, Densidad, Reposici√≥n, Observaciones
                    const cajaUV = document.getElementById('cajaUVVoladores').value;
                    const densidad = document.getElementById('densidadVoladores').value;
                    const reposicion = document.getElementById('reposicionVoladores').value;
                    const observaciones = document.getElementById('observacionesVoladores').value;
                    
                    if (!cajaUV || !densidad) {
                        alert('‚ö†Ô∏è Complete los campos obligatorios: Caja UV N¬∞ y Densidad');
                        return;
                    }
                    
                    // Convertir cajaUV a n√∫mero si es posible, sino usar secuencial
                    let numeroPunto = parseInt(cajaUV);
                    if (isNaN(numeroPunto)) {
                        const puntosVoladores = puntosManager.getAll().filter(p => p.tipo_plaga === 'voladores');
                        numeroPunto = puntosVoladores.length + 1;
                    }
                    
                    punto = {
                        numero: numeroPunto,
                        tipo_plaga: 'voladores',
                        tipo_dispositivo: 'Caja UV',
                        ubicacion: null,
                        estado: densidad, // Usar densidad directamente como estado
                        accion_realizada: reposicion ? `Reposici√≥n: ${reposicion}` : null,
                        observaciones: observaciones || null,
                        // Campos adicionales espec√≠ficos
                        caja_uv: cajaUV, // Mantener el valor original como string
                        densidad: densidad, // Tambi√©n en datos adicionales para consistencia
                        reposicion: reposicion
                    };
                    
                } else if (tipoPlaga === 'rastreros') {
                    // Formulario de rastreros: Ubicaci√≥n y Observaciones
                    const ubicacion = document.getElementById('ubicacionRastreros').value;
                    const observaciones = document.getElementById('observacionesRastreros').value;
                    
                    if (!ubicacion) {
                        alert('‚ö†Ô∏è Complete el campo obligatorio: Ubicaci√≥n');
                        return;
                    }
                    
                    // Generar n√∫mero secuencial para rastreros
                    const puntosRastreros = puntosManager.getAll().filter(p => p.tipo_plaga === 'rastreros');
                    const numeroRastrero = puntosRastreros.length + 1;
                    
                    punto = {
                        numero: numeroRastrero, // Usar n√∫mero secuencial
                        tipo_plaga: 'rastreros',
                        tipo_dispositivo: 'Aplicaci√≥n',
                        ubicacion: ubicacion,
                        estado: 'ok',
                        accion_realizada: null,
                        observaciones: observaciones || null
                    };
                    
                } else if (tipoPlaga === 'roedores') {
                    // Formulario de roedores con campos espec√≠ficos
                    const cajaN = document.getElementById('cajaNRoedores').value;
                    const vivos = document.getElementById('vivosRoedores').value;
                    const muertos = document.getElementById('muertosRoedores').value;
                    const tipoTrampa = document.getElementById('tipoTrampaRoedores').value;
                    const materiaFecal = document.getElementById('materiaFecalRoedores').value;
                    const consumo = document.getElementById('consumoRoedores').value;
                    const reposicion = document.getElementById('reposicionRoedores').value;
                    const observaciones = document.getElementById('observacionesRoedores').value;
                    
                    console.log('üìä Valores capturados de roedores:', {
                        cajaN, vivos, muertos, tipoTrampa, materiaFecal, consumo, reposicion, observaciones
                    });
                    
                    if (!cajaN || !vivos || !muertos || !tipoTrampa || !materiaFecal || !consumo || !reposicion) {
                        alert('‚ö†Ô∏è Complete todos los campos obligatorios');
                        return;
                    }
                    
                    // Convertir cajaN a n√∫mero si es posible, sino usar secuencial
                    let numeroPunto = parseInt(cajaN);
                    if (isNaN(numeroPunto)) {
                        const puntosRoedores = puntosManager.getAll().filter(p => p.tipo_plaga === 'roedores');
                        numeroPunto = puntosRoedores.length + 1;
                    }
                    
                    punto = {
                        numero: numeroPunto,
                        tipo_plaga: 'roedores',
                        tipo_dispositivo: tipoTrampa,
                        ubicacion: null,
                        estado: vivos === 'si' || muertos === 'si' ? 'con_actividad' : 'ok',
                        accion_realizada: reposicion === 'si' ? 'Reposici√≥n realizada' : null,
                        observaciones: observaciones || null,
                        // Campos adicionales espec√≠ficos de roedores
                        caja_n: cajaN, // Mantener el valor original como string
                        vivos: vivos,
                        muertos: muertos,
                        tipo_trampa: tipoTrampa,
                        materia_fecal: materiaFecal,
                        consumo: consumo,
                        reposicion: reposicion
                    };
                    
                    console.log('‚úÖ Punto creado para roedores:', punto);
                }
                
                puntosManager.agregar(punto);
                
                // Guardar en IndexedDB si estamos en modo draft
                if (localControlId && !editMode) {
                    await dbManager.sincronizarPuntos(localControlId, puntosManager.getAll());
                    console.log('‚úÖ Puntos guardados en IndexedDB');
                    console.log(`üìä Total de puntos en borrador: ${puntosManager.getAll().length}`);
                    
                    // Mostrar notificaci√≥n
                    const tipoNombre = {
                        'roedores': 'Roedores',
                        'voladores': 'Voladores',
                        'rastreros': 'Rastreros'
                    };
                    mostrarToast(`üíæ Punto de ${tipoNombre[tipoPlaga]} guardado en borrador`, 'success', 2000);
                } else if (editMode) {
                    console.log('‚ÑπÔ∏è Modo edici√≥n - Los puntos se guardar√°n al completar el control');
                    mostrarToast(`‚úÖ Punto agregado (se guardar√° al completar)`, 'info', 2000);
                } else {
                    console.warn('‚ö†Ô∏è No hay control iniciado - Inicie el control en el Paso 1');
                }
                
                // Limpiar campos espec√≠ficos por tipo
                if (tipoPlaga === 'voladores') {
                    document.getElementById('cajaUVVoladores').value = '';
                    document.getElementById('densidadVoladores').value = '';
                    document.getElementById('reposicionVoladores').value = '';
                    document.getElementById('observacionesVoladores').value = '';
                } else if (tipoPlaga === 'rastreros') {
                    document.getElementById('ubicacionRastreros').value = '';
                    document.getElementById('observacionesRastreros').value = '';
                } else if (tipoPlaga === 'roedores') {
                    document.getElementById('cajaNRoedores').value = '';
                    document.getElementById('vivosRoedores').value = '';
                    document.getElementById('muertosRoedores').value = '';
                    document.getElementById('tipoTrampaRoedores').value = '';
                    document.getElementById('materiaFecalRoedores').value = '';
                    document.getElementById('consumoRoedores').value = '';
                    document.getElementById('reposicionRoedores').value = '';
                    document.getElementById('observacionesRoedores').value = '';
                }
                
                // Actualizar la vista de puntos agregados para esta plaga
                actualizarVistaPuntos(tipoPlaga);
                
            } catch (error) {
                console.error('‚ùå Error agregando punto:', error);
                alert('Error: ' + error.message);
            }
        }
        
        /**
         * Capitalizar primera letra
         */
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        /**
         * Actualizar vista de puntos agregados por tipo
         */
        function actualizarVistaPuntos(tipoPlaga) {
            const puntos = puntosManager.getAll().filter(p => p.tipo_plaga === tipoPlaga);
            const container = document.getElementById(`puntosAgregados${capitalize(tipoPlaga)}`);
            
            if (puntos.length === 0) {
                const iconos = {
                    'roedores': 'üê≠',
                    'voladores': 'ü¶ü',
                    'rastreros': 'üêú'
                };
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${iconos[tipoPlaga]}</div>
                        <p class="empty-state-message">No se han agregado puntos de ${tipoPlaga}</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por n√∫mero
            puntos.sort((a, b) => {
                const numA = typeof a.numero === 'number' ? a.numero : parseInt(a.numero) || 0;
                const numB = typeof b.numero === 'number' ? b.numero : parseInt(b.numero) || 0;
                return numA - numB;
            });
            
            // Tabla espec√≠fica para voladores
            if (tipoPlaga === 'voladores') {
                container.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Caja UV N¬∞</th>
                                    <th>Densidad</th>
                                    <th>Reposici√≥n</th>
                                    <th>Observaciones</th>
                                    <th>Eliminar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${puntos.map((p, idx) => {
                                    const allPuntos = puntosManager.getAll();
                                    const globalIdx = allPuntos.findIndex(punto => 
                                        punto.numero === p.numero && 
                                        punto.tipo_plaga === p.tipo_plaga &&
                                        punto.estado === p.estado
                                    );
                                    
                                    return `
                                        <tr>
                                            <td><strong>${p.caja_uv || p.numero}</strong></td>
                                            <td><span class="badge badge-${p.densidad || p.estado}">${p.densidad || p.estado}</span></td>
                                            <td>${p.reposicion || '-'}</td>
                                            <td>${p.observaciones || '-'}</td>
                                            <td>
                                                <button class="btn-icon-sm btn-danger" onclick="eliminarPuntoLocal(${globalIdx})">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (tipoPlaga === 'rastreros') {
                // Tabla espec√≠fica para rastreros
                container.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ubicaci√≥n</th>
                                    <th>Observaciones</th>
                                    <th>Eliminar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${puntos.map((p, idx) => {
                                    const allPuntos = puntosManager.getAll();
                                    const globalIdx = allPuntos.findIndex(punto => 
                                        punto.ubicacion === p.ubicacion && 
                                        punto.tipo_plaga === p.tipo_plaga
                                    );
                                    
                                    return `
                                        <tr>
                                            <td><strong>${p.ubicacion}</strong></td>
                                            <td>${p.observaciones || '-'}</td>
                                            <td>
                                                <button class="btn-icon-sm btn-danger" onclick="eliminarPuntoLocal(${globalIdx})">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (tipoPlaga === 'roedores') {
                // Tabla espec√≠fica para roedores
                console.log('üê≠ Mostrando tabla de roedores. Puntos:', puntos);
                
                container.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Caja N¬∞</th>
                                    <th>Vivos</th>
                                    <th>Muertos</th>
                                    <th>Tipo Trampa</th>
                                    <th>M. Fecal</th>
                                    <th>Consumo</th>
                                    <th>Reposici√≥n</th>
                                    <th>Observ.</th>
                                    <th>Eliminar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${puntos.map((p, idx) => {
                                    console.log('üìä Procesando punto roedor completo:', JSON.stringify(p, null, 2));
                                    console.log('üîç Campos espec√≠ficos:', {
                                        caja_n: p.caja_n,
                                        vivos: p.vivos,
                                        muertos: p.muertos,
                                        tipo_trampa: p.tipo_trampa,
                                        materia_fecal: p.materia_fecal,
                                        consumo: p.consumo,
                                        reposicion: p.reposicion
                                    });
                                    
                                    const allPuntos = puntosManager.getAll();
                                    const globalIdx = allPuntos.findIndex(punto => 
                                        punto.numero === p.numero && 
                                        punto.tipo_plaga === p.tipo_plaga
                                    );
                                    
                                    return `
                                        <tr>
                                            <td><strong>${p.caja_n || p.numero}</strong></td>
                                            <td>${p.vivos ? p.vivos.toUpperCase() : '-'}</td>
                                            <td>${p.muertos ? p.muertos.toUpperCase() : '-'}</td>
                                            <td>${p.tipo_trampa || p.tipo_dispositivo || '-'}</td>
                                            <td>${p.materia_fecal ? p.materia_fecal.toUpperCase() : '-'}</td>
                                            <td>${p.consumo ? p.consumo.toUpperCase() : '-'}</td>
                                            <td>${p.reposicion ? p.reposicion.toUpperCase() : '-'}</td>
                                            <td>${p.observaciones ? p.observaciones.substring(0, 20) + (p.observaciones.length > 20 ? '...' : '') : '-'}</td>
                                            <td>
                                                <button class="btn-icon-sm btn-danger" onclick="eliminarPuntoLocal(${globalIdx})">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }
        
        /**
         * Eliminar punto localmente
         */
        async function eliminarPuntoLocal(index) {
            if (!confirm('¬øEliminar este punto?')) return;
            
            const puntos = puntosManager.getAll();
            const puntoEliminado = puntos[index];
            
            puntosManager.eliminar(index);
            
            // Actualizar IndexedDB si estamos en modo draft
            if (localControlId && !editMode) {
                await dbManager.sincronizarPuntos(localControlId, puntosManager.getAll());
            }
            
            // Actualizar la vista correspondiente
            actualizarVistaPuntos(puntoEliminado.tipo_plaga);
        }
        
        
        
        /**
         * Cambiar tab activo
         */
        function cambiarTab(tipoPlaga) {
            // Desactivar todas las tabs
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activar la tab seleccionada
            document.querySelector(`[data-tab="${tipoPlaga}"]`).classList.add('active');
            document.getElementById(`tab-${tipoPlaga}`).classList.add('active');
            
            // Actualizar vista de puntos
            actualizarVistaPuntos(tipoPlaga);
        }
        
        /**
         * Mostrar modal con lista de puntos
         */
        function mostrarListaPuntos() {
            try {
                console.log('üîç Mostrando lista de puntos...');
                const puntos = puntosManager.getAll();
                console.log('üìä Puntos obtenidos:', puntos);
                
                const modalContent = document.getElementById('listaPuntosModal');
                
                if (!puntos || puntos.length === 0) {
                    console.warn('‚ö†Ô∏è No hay puntos para mostrar');
                    modalContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìç</div>
                            <p class="empty-state-message">No hay puntos de control agregados</p>
                        </div>
                    `;
                } else {
                    console.log(`‚úÖ Procesando ${puntos.length} puntos...`);
                    
                    // Agrupar por tipo de plaga (normalizado a min√∫sculas)
                    const grupos = {
                        'roedores': [],
                        'voladores': [],
                        'rastreros': []
                    };
                    
                    // Clasificar y ordenar puntos
                    puntos.forEach(punto => {
                        console.log('Procesando punto:', punto);
                        const tipoPlaga = punto.tipo_plaga.toLowerCase(); // Normalizar a min√∫sculas
                        if (grupos[tipoPlaga]) {
                            grupos[tipoPlaga].push(punto);
                        } else {
                            console.warn(`‚ö†Ô∏è Tipo de plaga no reconocido: ${punto.tipo_plaga}`);
                        }
                    });
                    
                    console.log('üì¶ Grupos formados:', grupos);
                    
                    // Ordenar cada grupo por n√∫mero de punto
                    Object.keys(grupos).forEach(tipo => {
                        grupos[tipo].sort((a, b) => a.numero - b.numero);
                    });
                    
                    // Generar HTML
                    let html = '';
                    
                    // Configuraci√≥n de tipos con √≠conos y nombres capitalizados
                    const tiposConfig = {
                        'roedores': { icono: 'üê≠', nombre: 'Roedores' },
                        'voladores': { icono: 'ü¶ü', nombre: 'Voladores' },
                        'rastreros': { icono: 'üêú', nombre: 'Rastreros' }
                    };
                    
                    Object.keys(grupos).forEach(tipoPlaga => {
                        if (grupos[tipoPlaga].length > 0) {
                            const config = tiposConfig[tipoPlaga];
                            
                            html += `
                                <div class="grupo-plagas">
                                    <h4 class="grupo-titulo">${config.icono} ${config.nombre} (${grupos[tipoPlaga].length})</h4>
                                    <div class="grupo-puntos">
                                        ${grupos[tipoPlaga].map(punto => {
                                            // Generar contenido espec√≠fico por tipo de plaga
                                            let infoHTML = '';
                                            
                                            if (tipoPlaga === 'roedores') {
                                                // Mostrar campos espec√≠ficos de roedores
                                                infoHTML = `
                                                    <div class="punto-info">
                                                        <div class="punto-info-item">
                                                            <strong>üì¶ Caja N¬∞:</strong> ${punto.caja_n || punto.numero}
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>üëÄ Vivos:</strong> ${punto.vivos ? punto.vivos.toUpperCase() : '-'}
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>üíÄ Muertos:</strong> ${punto.muertos ? punto.muertos.toUpperCase() : '-'}
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>ü™§ Tipo Trampa:</strong> ${punto.tipo_trampa || punto.tipo_dispositivo || '-'}
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>üí© Materia Fecal:</strong> ${punto.materia_fecal ? punto.materia_fecal.toUpperCase() : '-'}
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>üçΩÔ∏è Consumo:</strong> ${punto.consumo ? punto.consumo.toUpperCase() : '-'}
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>üîÑ Reposici√≥n:</strong> ${punto.reposicion ? punto.reposicion.toUpperCase() : '-'}
                                                        </div>
                                                        ${punto.observaciones ? `
                                                            <div class="punto-info-item">
                                                                <strong>ÔøΩ Observaciones:</strong> ${punto.observaciones}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            } else if (tipoPlaga === 'voladores') {
                                                // Mostrar campos espec√≠ficos de voladores
                                                infoHTML = `
                                                    <div class="punto-info">
                                                        <div class="punto-info-item">
                                                            <strong>üí° Caja UV N¬∞:</strong> ${punto.caja_uv || punto.numero}
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>üìä Densidad:</strong> <span class="badge badge-${punto.densidad || punto.estado}">${punto.densidad ? punto.densidad.toUpperCase() : '-'}</span>
                                                        </div>
                                                        <div class="punto-info-item">
                                                            <strong>üîÑ Reposici√≥n:</strong> ${punto.reposicion ? punto.reposicion.toUpperCase() : '-'}
                                                        </div>
                                                        ${punto.observaciones ? `
                                                            <div class="punto-info-item">
                                                                <strong>ÔøΩ Observaciones:</strong> ${punto.observaciones}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            } else if (tipoPlaga === 'rastreros') {
                                                // Mostrar campos espec√≠ficos de rastreros
                                                infoHTML = `
                                                    <div class="punto-info">
                                                        <div class="punto-info-item">
                                                            <strong>üìç Ubicaci√≥n:</strong> ${punto.ubicacion || '-'}
                                                        </div>
                                                        ${punto.observaciones ? `
                                                            <div class="punto-info-item">
                                                                <strong>üìù Observaciones:</strong> ${punto.observaciones}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            }
                                            
                                            // Determinar el estado para roedores
                                            let estadoBadge = '';
                                            if (tipoPlaga === 'roedores') {
                                                const tieneActividad = punto.vivos === 'si' || punto.muertos === 'si';
                                                estadoBadge = `<span class="punto-estado estado-${tieneActividad ? 'con_actividad' : 'ok'}">${tieneActividad ? 'Con Actividad' : 'OK'}</span>`;
                                            } else {
                                                estadoBadge = `<span class="punto-estado estado-${punto.estado}">${formatearEstado(punto.estado)}</span>`;
                                            }
                                            
                                            return `
                                                <div class="punto-card">
                                                    ${infoHTML}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    if (html === '') {
                        console.warn('‚ö†Ô∏è No se gener√≥ HTML (todos los grupos vac√≠os)');
                        modalContent.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìç</div>
                                <p class="empty-state-message">No hay puntos de control v√°lidos</p>
                            </div>
                        `;
                    } else {
                        console.log('‚úÖ HTML generado correctamente');
                        modalContent.innerHTML = html;
                    }
                }
                
                document.getElementById('modalListaPuntos').classList.add('active');
                document.body.style.overflow = 'hidden';
                console.log('‚úÖ Modal abierto');
                
            } catch (error) {
                console.error('‚ùå Error mostrando lista de puntos:', error);
                alert('Error al mostrar la lista: ' + error.message);
            }
        }
        
        /**
         * Cerrar modal de lista de puntos
         */
        function cerrarModalPuntos() {
            document.getElementById('modalListaPuntos').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Cerrar modal al hacer clic fuera del contenido
        document.getElementById('modalListaPuntos')?.addEventListener('click', (e) => {
            if (e.target.id === 'modalListaPuntos') {
                cerrarModalPuntos();
            }
        });
        
        /**
         * Formatear estado para mostrar
         */
        function formatearEstado(estado) {
            const estados = {
                'ok': 'OK',
                'con_actividad': 'Con Actividad',
                'faltante': 'Faltante',
                'reemplazado': 'Reemplazado'
            };
            return estados[estado] || estado;
        }
        
        /**
         * Mostrar notificaci√≥n toast
         */
        function mostrarToast(mensaje, tipo = 'success', duracion = 2000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = mensaje;
            toast.className = `toast ${tipo}`;
            
            // Mostrar toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Ocultar toast despu√©s de la duraci√≥n
            setTimeout(() => {
                toast.classList.remove('show');
            }, duracion);
        }
        
        /**
         * Completar control (subir a Supabase y eliminar de IndexedDB)
         */
        async function completarControl() {
            try {
                // Siempre recopilar datos del formulario (funciona para edici√≥n y nuevos)
                const formData = controlManager.recopilarDatosFormulario();
                console.log('üìã Datos recopilados del formulario:', formData);
                console.log('üîç Valores individuales:', {
                    cliente_id: formData.cliente_id,
                    cliente_id_type: typeof formData.cliente_id,
                    cliente_id_isNaN: isNaN(formData.cliente_id),
                    tecnico_id: formData.tecnico_id,
                    tecnico_id_type: typeof formData.tecnico_id,
                    fecha_control: formData.fecha_control,
                    tipo_control: formData.tipo_control
                });
                
                // Validar que hay datos m√≠nimos
                if (!formData.cliente_id || !formData.tecnico_id || !formData.fecha_control || !formData.tipo_control) {
                    console.error('‚ùå Validaci√≥n fallida. Valores:', {
                        cliente_id: formData.cliente_id,
                        tecnico_id: formData.tecnico_id,
                        fecha_control: formData.fecha_control,
                        tipo_control: formData.tipo_control
                    });
                    alert('‚ö†Ô∏è Complete la informaci√≥n b√°sica del control en el Paso 1');
                    wizard.goToStep(1);
                    return;
                }
                
                console.log(editMode ? 'üíæ Actualizando control en Supabase...' : 'üíæ Completando control y subiendo a Supabase...');
                
                // Obtener productos y puntos
                const productos = productosManager.getAll();
                const puntos = puntosManager.getAll();
                const selloUrl = selloManager.getSelloUrl();
                
                // Confirmar antes de guardar
                const confirmar = confirm(
                    `¬øDesea ${editMode ? 'actualizar' : 'completar'} este control?\n\n` +
                    `Productos: ${productos.length}\n` +
                    `Puntos: ${puntos.length}\n` +
                    `Sello: ${selloUrl ? 'S√≠' : 'No'}\n\n` +
                    (localControlId ? 'El borrador se eliminar√° despu√©s de completar.' : '')
                );
                
                if (!confirmar) return;
                
                // Preparar productos y puntos para Supabase
                const productosPreparados = productos.map(p => ({
                    producto_id: p.producto_id,
                    cantidad_usada: p.cantidad,
                    unidad: p.unidad
                }));
                
                const puntosPreparados = puntos.map(p => {
                    // Campos base para todos los tipos
                    const puntoBase = {
                        numero_punto: p.numero,
                        tipo_plaga: p.tipo_plaga,
                        tipo_dispositivo: p.tipo_dispositivo || null,
                        ubicacion: p.ubicacion || null,
                        estado: p.estado || 'ok',
                        accion_realizada: p.accion_realizada || null
                    };
                    
                    // Preparar informaci√≥n adicional en formato JSON para descripcion_actividad
                    let infoAdicional = {};
                    
                    // Agregar campos espec√≠ficos seg√∫n el tipo de plaga
                    if (p.tipo_plaga.toLowerCase() === 'roedores') {
                        infoAdicional = {
                            caja_n: p.caja_n || p.numero,
                            vivos: p.vivos || null,
                            muertos: p.muertos || null,
                            tipo_trampa: p.tipo_trampa || p.tipo_dispositivo,
                            materia_fecal: p.materia_fecal || null,
                            consumo: p.consumo || null,
                            reposicion: p.reposicion || null,
                            observaciones: p.observaciones || null
                        };
                    } else if (p.tipo_plaga.toLowerCase() === 'voladores') {
                        infoAdicional = {
                            caja_uv: p.caja_uv || p.numero,
                            densidad: p.densidad || null,
                            reposicion: p.reposicion || null,
                            observaciones: p.observaciones || null
                        };
                    } else if (p.tipo_plaga.toLowerCase() === 'rastreros') {
                        infoAdicional = {
                            ubicacion_detalle: p.ubicacion,
                            observaciones: p.observaciones || null
                        };
                    }
                    
                    // Combinar info adicional con observaciones
                    const descripcion = JSON.stringify(infoAdicional);
                    
                    return {
                        ...puntoBase,
                        descripcion_actividad: descripcion,
                        actividad_detectada: p.estado === 'con_actividad' || false
                    };
                });
                
                let control;
                
                if (editMode) {
                    // Modo edici√≥n: actualizar control existente en Supabase
                    control = await controlManager.actualizar(
                        currentControlId,
                        formData,
                        productosPreparados,
                        puntosPreparados,
                        selloUrl
                    );
                    console.log('‚úÖ Control actualizado en Supabase con ID:', control.control_id);
                    alert('‚úÖ Control actualizado exitosamente');
                } else {
                    // Modo nuevo: subir a Supabase
                    control = await controlManager.guardar(
                        formData,
                        productosPreparados,
                        puntosPreparados,
                        selloUrl
                    );
                    console.log('‚úÖ Control completado y subido a Supabase con ID:', control.control_id);
                    
                    // Eliminar draft de IndexedDB si existe
                    if (localControlId) {
                        await dbManager.eliminarControl(localControlId);
                        console.log('‚úÖ Borrador eliminado de IndexedDB');
                    }
                    
                    alert('‚úÖ Control completado exitosamente');
                }
                
                // Redirigir a la lista de controles
                window.location.href = 'controles.html';
                
            } catch (error) {
                console.error('‚ùå Error completando control:', error);
                alert('‚ùå Error al completar control: ' + error.message);
            }
        }
        
        /**
         * Actualizar indicador de paso actual en el header
         */
        function actualizarIndicadorPaso(paso) {
            const stepNames = [
                'Informaci√≥n General',
                'Productos',
                'Puntos de Control',
                'Observaciones',
                'Sello'
            ];
            
            document.getElementById('currentStepNumber').textContent = paso;
            document.getElementById('currentStepName').textContent = stepNames[paso - 1];
        }
        
        // Interceptar cambios de paso del wizard
        const originalIrAPaso = wizard.irAPaso.bind(wizard);
        wizard.irAPaso = function(paso) {
            originalIrAPaso(paso);
            actualizarIndicadorPaso(paso);
        };
    </script>
</body>
</html>
