<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Control de Plagas</title>
    <!-- Sistema de componentes -->
    <link rel="stylesheet" href="../css/nuevo-control.css">
</head>
<body>
    <div class="page-wrapper">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <button class="wizard-toggle" id="wizardToggle" aria-label="Men√∫ de navegaci√≥n">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <div class="header-title">
                    <h1>üìã Nuevo Control de Plagas</h1>
                    <p class="current-step-text">Paso <span id="currentStepNumber">1</span> de 5: <span id="currentStepName">Informaci√≥n General</span></p>
                </div>
            </div>
            <a href="controles.html" class="btn btn-secondary btn-back-header">
                ‚Üê Volver
            </a>
        </div>
        
        <!-- Wizard Steps (Collapsible) -->
        <div class="wizard-steps" id="wizardSteps">
            <div class="wizard-overlay" id="wizardOverlay"></div>
            <div class="wizard-menu" id="wizardMenu">
                <div class="wizard-menu-header">
                    <h3>Pasos del Control</h3>
                    <button class="wizard-close" id="wizardClose">‚úï</button>
                </div>
                <div class="wizard-step" data-step="1">
                    <span class="wizard-step-number">1</span>
                    <span class="wizard-step-title">Informaci√≥n General</span>
                    <span class="wizard-step-status">‚úì</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <span class="wizard-step-number">2</span>
                    <span class="wizard-step-title">Productos</span>
                    <span class="wizard-step-status"></span>
                </div>
                <div class="wizard-step" data-step="3">
                    <span class="wizard-step-number">3</span>
                    <span class="wizard-step-title">Puntos de Control</span>
                    <span class="wizard-step-status"></span>
                </div>
                <div class="wizard-step" data-step="4">
                    <span class="wizard-step-number">4</span>
                    <span class="wizard-step-title">Observaciones</span>
                    <span class="wizard-step-status"></span>
                </div>
                <div class="wizard-step" data-step="5">
                    <span class="wizard-step-number">5</span>
                    <span class="wizard-step-title">Sello</span>
                    <span class="wizard-step-status"></span>
                </div>
            </div>
        </div>
        
        <!-- Step 1: Informaci√≥n General -->
        <div class="step-content active" data-step="1">
            <h2>Informaci√≥n General del Control</h2>
            
            <div class="form-row">
                <div class="form-group required">
                    <label for="clienteId">Cliente</label>
                    <select id="clienteId" class="form-control" required>
                        <option value="">Seleccione un cliente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="plantaId">Planta</label>
                    <select id="plantaId" class="form-control">
                        <option value="">Sin planta espec√≠fica</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group required">
                    <label for="tecnicoId">T√©cnico Responsable</label>
                    <select id="tecnicoId" class="form-control" required>
                        <option value="">Seleccione un t√©cnico</option>
                    </select>
                </div>
                
                <div class="form-group required">
                    <label for="fechaControl">Fecha del Control</label>
                    <input type="date" id="fechaControl" class="form-control" required>
                </div>
            </div>
            
            <!-- Preview del sello del t√©cnico -->
            <div id="selloPreviewContainer" class="sello-preview-card hidden">
                <div class="sello-preview-header">
                    <h3>Sello del T√©cnico Seleccionado</h3>
                </div>
                <div class="sello-preview-content">
                    <div id="selloPreviewPlaceholder" class="sello-placeholder">
                        Seleccione un t√©cnico para ver su sello
                    </div>
                    <img id="selloPreviewImg" class="hidden" alt="Sello del t√©cnico">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group required">
                    <label for="tipoControl">Tipo de Control</label>
                    <select id="tipoControl" class="form-control" required>
                        <option value="">Seleccione tipo</option>
                        <option value="preventivo">Preventivo</option>
                        <option value="correctivo">Correctivo</option>
                        <option value="especial">Especial</option>
                    </select>
                </div>
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-primary btn-lg" onclick="wizard.nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 2: Productos -->
        <div class="step-content" data-step="2">
            <h2>Productos Utilizados</h2>
            
            <div class="alert alert-info">
                <p>üí° Agregue los productos que utiliz√≥ en este control. Puede dejar esta secci√≥n vac√≠a si no aplic√≥ productos.</p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="productoSelect">Producto</label>
                    <select id="productoSelect" class="form-control">
                        <option value="">Seleccione un producto</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cantidadProducto">Cantidad</label>
                    <input type="number" id="cantidadProducto" class="form-control" step="0.01" min="0.01">
                </div>
                
                <div class="form-group">
                    <label for="unidadProducto">Unidad</label>
                    <input type="text" id="unidadProducto" class="form-control" readonly>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="agregarProducto()">
                + Agregar Producto
            </button>
            
            <div id="productosAgregados">
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <p class="empty-state-message">No se han agregado productos</p>
                </div>
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-secondary" onclick="wizard.prevStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary btn-lg" onclick="wizard.nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 3: Puntos de Control -->
        <div class="step-content" data-step="3">
            <h2>Puntos de Control</h2>
            
            <div class="alert alert-info">
                <p>üí° Registre los puntos de control revisados. Puede dejar esta secci√≥n vac√≠a si no revis√≥ puntos espec√≠ficos.</p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="numeroPunto">N√∫mero de Punto *</label>
                    <input type="number" id="numeroPunto" class="form-control" min="1">
                </div>
                
                <div class="form-group">
                    <label for="tipoPlaga">Tipo de Plaga *</label>
                    <select id="tipoPlaga" class="form-control">
                        <option value="">Seleccione tipo</option>
                        <option value="roedores">Roedores</option>
                        <option value="voladores">Voladores</option>
                        <option value="rastreros">Rastreros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tipoDispositivo">Tipo de Dispositivo</label>
                    <input type="text" id="tipoDispositivo" class="form-control" placeholder="Ej: Cebadero, Trampa">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="ubicacionPunto">Ubicaci√≥n</label>
                    <input type="text" id="ubicacionPunto" class="form-control" placeholder="Descripci√≥n de la ubicaci√≥n">
                </div>
                
                <div class="form-group">
                    <label for="estadoPunto">Estado *</label>
                    <select id="estadoPunto" class="form-control">
                        <option value="">Seleccione estado</option>
                        <option value="ok">OK</option>
                        <option value="con_actividad">Con Actividad</option>
                        <option value="faltante">Faltante</option>
                        <option value="reemplazado">Reemplazado</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="accionRealizada">Acci√≥n Realizada</label>
                <textarea id="accionRealizada" class="form-control" rows="3" placeholder="Describa la acci√≥n realizada en este punto"></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="agregarPunto()">
                + Agregar Punto
            </button>
            
            <div id="puntosAgregados">
                <div class="empty-state">
                    <div class="empty-state-icon">üìç</div>
                    <p class="empty-state-message">No se han agregado puntos de control</p>
                </div>
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-secondary" onclick="wizard.prevStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary btn-lg" onclick="wizard.nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
            </div>
        </div>
        
        <!-- Step 4: Observaciones -->
        <div class="step-content" data-step="4">
            <h2>Observaciones Generales</h2>
            
            <div class="form-group">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" class="form-control" rows="8" placeholder="Ingrese observaciones generales del control, hallazgos importantes, recomendaciones, etc."></textarea>
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-secondary" onclick="wizard.prevStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary btn-lg" onclick="wizard.nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 5: Sello -->
        <div class="step-content" data-step="5">
            <h2>Sello del T√©cnico</h2>
            
            <div class="alert alert-info">
                <p>üìå El sello se carga autom√°ticamente seg√∫n el t√©cnico responsable seleccionado en el Paso 1.</p>
            </div>
            
            <div class="sello-container">
                <div id="selloTecnicoPlaceholder" class="sello-placeholder">
                    <p>üë§ Seleccione un t√©cnico para ver su sello</p>
                </div>
                <img id="selloTecnicoImg" class="hidden" alt="Sello del t√©cnico">
            </div>
            
            <div class="wizard-navigation">
                <button class="btn btn-secondary" onclick="wizard.prevStep()">
                    ‚Üê Anterior
                </button>
                <button class="btn btn-success btn-lg" onclick="guardarControl()">
                    üíæ Guardar Control
                </button>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../ts/auth.js"></script>
    
    <!-- M√≥dulos -->
    <script src="../js/controles/data-loader.js"></script>
    <script src="../js/controles/sello-manager.js"></script>
    <script src="../js/controles/wizard-manager.js"></script>
    <script src="../js/controles/productos-manager.js"></script>
    <script src="../js/controles/puntos-manager.js"></script>
    <script src="../js/controles/control-manager.js"></script>
    
    <!-- Script Principal -->
    <script>
        // Usar el cliente de Supabase del auth.js
        const supabase = window.supabaseClient;
        
        // Variables globales
        let workerProfile = null;
        let dataLoader = null;
        let selloManager = null;
        let wizard = null;
        let productosManager = null;
        let puntosManager = null;
        let controlManager = null;
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Esperar a que auth.js se inicialice completamente
                await new Promise(resolve => setTimeout(resolve, 500));
                
                console.log('üöÄ Iniciando aplicaci√≥n...');
                
                // Verificar que authUtils est√© disponible
                if (!window.authUtils) {
                    console.error('‚ùå authUtils no est√° disponible');
                    alert('Error: Sistema de autenticaci√≥n no disponible');
                    return;
                }
                
                console.log('‚úÖ Dependencias cargadas correctamente');
                
                // Verificar autenticaci√≥n
                workerProfile = await window.authUtils.getWorkerProfile();
                
                if (!workerProfile) {
                    console.warn('‚ö†Ô∏è Usuario no autenticado');
                    alert('‚ùå Debes iniciar sesi√≥n primero');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('‚úÖ Usuario autenticado:', workerProfile);
                
                // Inicializar managers
                dataLoader = new DataLoader(supabase, workerProfile);
                selloManager = new SelloManager(supabase);
                wizard = new WizardManager();
                productosManager = new ProductosManager();
                puntosManager = new PuntosManager();
                controlManager = new ControlManager(supabase, workerProfile);
                
                console.log('‚úÖ Managers inicializados');
                
                // Cargar datos iniciales
                await inicializarFormulario();
                
                // Configurar event listeners
                configurarEventListeners();
                
                console.log('‚úÖ Aplicaci√≥n lista');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                alert('Error al iniciar la aplicaci√≥n: ' + error.message);
            }
        });
        
        /**
         * Inicializar formulario con datos
         */
        async function inicializarFormulario() {
            try {
                // Cargar clientes
                const clientes = await dataLoader.cargarClientes();
                llenarSelect('clienteId', clientes, 'cliente_id', 'nombre');
                
                // Cargar t√©cnicos
                const tecnicos = await dataLoader.cargarTecnicos();
                llenarSelect('tecnicoId', tecnicos, 'worker_id', (t) => `${t.nombre}${t.puesto ? ' - ' + t.puesto : ''}`);
                
                // Cargar productos
                const productos = await dataLoader.cargarProductos();
                llenarSelect('productoSelect', productos, 'producto_id', (p) => `${p.nombre} (${p.tipo})`);
                
                // Establecer fecha actual
                document.getElementById('fechaControl').valueAsDate = new Date();
                
                console.log('‚úÖ Formulario inicializado');
                
            } catch (error) {
                console.error('‚ùå Error inicializando formulario:', error);
                throw error;
            }
        }
        
        /**
         * Configurar event listeners
         */
        function configurarEventListeners() {
            // Cliente cambia -> cargar plantas
            document.getElementById('clienteId').addEventListener('change', async (e) => {
                const clienteId = e.target.value;
                if (clienteId) {
                    const plantas = await dataLoader.cargarPlantas(clienteId);
                    llenarSelect('plantaId', plantas, 'planta_id', 'nombre', true);
                }
            });
            
            // T√©cnico cambia -> cargar sello
            document.getElementById('tecnicoId').addEventListener('change', async (e) => {
                const tecnicoId = e.target.value;
                if (tecnicoId) {
                    await selloManager.cargarSello(tecnicoId);
                } else {
                    selloManager.limpiar();
                }
            });
            
            // Producto cambia -> actualizar unidad
            document.getElementById('productoSelect').addEventListener('change', (e) => {
                const select = e.target;
                const option = select.options[select.selectedIndex];
                const productos = dataLoader.supabase ? null : []; // Obtener del data loader si es necesario
                
                // Buscar producto seleccionado para obtener unidad
                const productoId = select.value;
                if (productoId) {
                    // Por ahora usar dataset del option
                    const unidad = option.dataset.unidad || '';
                    document.getElementById('unidadProducto').value = unidad;
                }
            });
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        /**
         * Llenar un select con opciones
         */
        function llenarSelect(selectId, items, valueKey, textKey, keepFirst = false) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Mantener primera opci√≥n si es necesario
            if (!keepFirst) {
                const firstOption = select.options[0];
                select.innerHTML = '';
                if (firstOption) {
                    select.appendChild(firstOption);
                }
            } else {
                // Limpiar opciones excepto la primera
                while (select.options.length > 1) {
                    select.remove(1);
                }
            }
            
            // Agregar items
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = typeof textKey === 'function' ? textKey(item) : item[textKey];
                
                // Guardar unidad como dataset si es un producto
                if (item.unidad_medida) {
                    option.dataset.unidad = item.unidad_medida;
                }
                
                select.appendChild(option);
            });
        }
        
        /**
         * Agregar producto a la lista
         */
        function agregarProducto() {
            try {
                const productoSelect = document.getElementById('productoSelect');
                const cantidad = document.getElementById('cantidadProducto').value;
                const unidad = document.getElementById('unidadProducto').value;
                
                if (!productoSelect.value) {
                    alert('‚ö†Ô∏è Seleccione un producto');
                    return;
                }
                
                if (!cantidad || parseFloat(cantidad) <= 0) {
                    alert('‚ö†Ô∏è Ingrese una cantidad v√°lida');
                    return;
                }
                
                const producto = {
                    producto_id: productoSelect.value,
                    nombre: productoSelect.options[productoSelect.selectedIndex].text,
                    cantidad: parseFloat(cantidad),
                    unidad: unidad
                };
                
                productosManager.agregar(producto);
                
                // Limpiar campos
                productoSelect.value = '';
                document.getElementById('cantidadProducto').value = '';
                document.getElementById('unidadProducto').value = '';
                
            } catch (error) {
                console.error('‚ùå Error agregando producto:', error);
                alert('Error: ' + error.message);
            }
        }
        
        /**
         * Agregar punto de control a la lista
         */
        function agregarPunto() {
            try {
                const numero = document.getElementById('numeroPunto').value;
                const tipoPlaga = document.getElementById('tipoPlaga').value;
                const estado = document.getElementById('estadoPunto').value;
                
                if (!numero || !tipoPlaga || !estado) {
                    alert('‚ö†Ô∏è Complete los campos obligatorios: N√∫mero, Tipo de Plaga y Estado');
                    return;
                }
                
                const punto = {
                    numero: parseInt(numero),
                    tipo_plaga: tipoPlaga,
                    tipo_dispositivo: document.getElementById('tipoDispositivo').value,
                    ubicacion: document.getElementById('ubicacionPunto').value,
                    estado: estado,
                    accion_realizada: document.getElementById('accionRealizada').value
                };
                
                puntosManager.agregar(punto);
                
                // Limpiar campos
                document.getElementById('numeroPunto').value = '';
                document.getElementById('tipoPlaga').value = '';
                document.getElementById('tipoDispositivo').value = '';
                document.getElementById('ubicacionPunto').value = '';
                document.getElementById('estadoPunto').value = '';
                document.getElementById('accionRealizada').value = '';
                
            } catch (error) {
                console.error('‚ùå Error agregando punto:', error);
                alert('Error: ' + error.message);
            }
        }
        
        /**
         * Guardar control completo
         */
        async function guardarControl() {
            try {
                // Validar wizard
                if (!wizard.validarPasoActual()) {
                    return;
                }
                
                console.log('üíæ Iniciando guardado...');
                
                // Recopilar datos del formulario
                const formData = controlManager.recopilarDatosFormulario();
                
                // Obtener productos y puntos
                const productos = productosManager.getAll();
                const puntos = puntosManager.getAll();
                const selloUrl = selloManager.getSelloUrl();
                
                // Confirmar antes de guardar
                const confirmar = confirm(
                    `¬øDesea guardar este control?\n\n` +
                    `Productos: ${productos.length}\n` +
                    `Puntos: ${puntos.length}\n` +
                    `Sello: ${selloUrl ? 'S√≠' : 'No'}`
                );
                
                if (!confirmar) return;
                
                // Preparar productos y puntos SIN control_id (se asignar√° despu√©s de crear el control)
                const productosPreparados = productosManager.getAll().map(p => ({
                    producto_id: p.producto_id,
                    cantidad_usada: p.cantidad,
                    unidad: p.unidad
                }));
                
                const puntosPreparados = puntosManager.getAll().map(p => ({
                    numero_punto: p.numero,
                    tipo_plaga: p.tipo_plaga,
                    tipo_dispositivo: p.tipo_dispositivo || null,
                    ubicacion: p.ubicacion || null,
                    estado: p.estado,
                    accion_realizada: p.accion_realizada || null
                }));
                
                // Guardar control
                const control = await controlManager.guardar(
                    formData,
                    productosPreparados,
                    puntosPreparados,
                    selloUrl
                );
                
                // Actualizar IDs en managers (ya no es necesario, pero se puede mantener para referencia)
                console.log('‚úÖ Control guardado con ID:', control.control_id);
                
                alert('‚úÖ Control guardado exitosamente');
                
                // Redirigir a la lista de controles
                window.location.href = '../controles.html';
                
            } catch (error) {
                console.error('‚ùå Error guardando control:', error);
                alert('‚ùå Error al guardar control: ' + error.message);
            }
        }
        
        /**
         * Control del men√∫ hamburguesa
         */
        const wizardToggle = document.getElementById('wizardToggle');
        const wizardMenu = document.getElementById('wizardMenu');
        const wizardOverlay = document.getElementById('wizardOverlay');
        const wizardClose = document.getElementById('wizardClose');
        
        function abrirMenu() {
            wizardMenu.classList.add('active');
            wizardOverlay.classList.add('active');
            wizardToggle.classList.add('active');
            // Agregar clase al body para controlar estilos
            document.body.classList.add('menu-open');
            // Solo bloquear scroll cuando el men√∫ est√° abierto
            document.body.style.overflow = 'hidden';
        }
        
        function cerrarMenu() {
            wizardMenu.classList.remove('active');
            wizardOverlay.classList.remove('active');
            wizardToggle.classList.remove('active');
            // Remover clase del body
            document.body.classList.remove('menu-open');
            // Restaurar scroll
            document.body.style.overflow = '';
        }
        
        wizardToggle.addEventListener('click', () => {
            if (wizardMenu.classList.contains('active')) {
                cerrarMenu();
            } else {
                abrirMenu();
            }
        });
        
        wizardClose.addEventListener('click', cerrarMenu);
        wizardOverlay.addEventListener('click', cerrarMenu);
        
        // Cerrar men√∫ al hacer clic en un paso
        document.querySelectorAll('.wizard-step').forEach(step => {
            step.addEventListener('click', () => {
                cerrarMenu();
            });
        });
        
        /**
         * Actualizar indicador de paso actual en el header
         */
        function actualizarIndicadorPaso(paso) {
            const stepNames = [
                'Informaci√≥n General',
                'Productos',
                'Puntos de Control',
                'Observaciones',
                'Sello'
            ];
            
            document.getElementById('currentStepNumber').textContent = paso;
            document.getElementById('currentStepName').textContent = stepNames[paso - 1];
        }
        
        // Interceptar cambios de paso del wizard
        const originalIrAPaso = wizard.irAPaso.bind(wizard);
        wizard.irAPaso = function(paso) {
            originalIrAPaso(paso);
            actualizarIndicadorPaso(paso);
        };
    </script>
    </div> <!-- Cierre page-wrapper -->
</body>
</html>
