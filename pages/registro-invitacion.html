<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro por Invitaci√≥n - PCP</title>
    <!-- Sistema de componentes -->
    <link rel="stylesheet" href="../css/registro-invitacion.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="../index.html" class="logo">üêõ PCP Sistema</a>
        <a href="../index.html" class="back-link">‚Üê Volver al Inicio</a>
    </nav>

    <div class="page-wrapper">
        <div class="container">
            
            <!-- Card principal -->
            <div class="card">
                <div class="card-header">
                    <h2>‚úâÔ∏è Registro por Invitaci√≥n</h2>
                    <p>Completa tu perfil para unirte a tu empresa</p>
                </div>
                
                <div class="card-body">
                    <!-- Informaci√≥n de invitaci√≥n -->
                    <div id="invitationInfo" class="card">
                        <div class="card-body">
                            <h3>‚úÖ Invitaci√≥n V√°lida</h3>
                            <div class="invitation-details">
                                <p><strong>Empresa:</strong> <span id="empresaNombre"></span></p>
                                <p><strong>Email:</strong> <span id="emailInvitado"></span></p>
                                <p><strong>Puesto Sugerido:</strong> <span id="puestoSugerido"></span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensajes -->
                    <div id="message"></div>
                    
                    <!-- Formulario -->
                    <form id="registerForm">
                        <input type="hidden" id="invitationToken" />
                        <input type="hidden" id="empresaId" />
                        
                        <div class="form-group">
                            <label for="fullName">Nombre completo *</label>
                            <input type="text" id="fullName" class="form-control" placeholder="Juan P√©rez" required />
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" class="form-control" placeholder="email@ejemplo.com" required readonly />
                            <small>Este email est√° vinculado a tu invitaci√≥n</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="puesto">Puesto de trabajo *</label>
                            <input type="text" id="puesto" class="form-control" placeholder="T√©cnico de fumigaci√≥n" required />
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Contrase√±a *</label>
                            <input type="password" id="password" class="form-control" placeholder="M√≠nimo 6 caracteres" required />
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">Confirmar contrase√±a *</label>
                            <input type="password" id="confirmPassword" class="form-control" placeholder="Repite tu contrase√±a" required />
                        </div>
                        
                        <button type="submit" id="registerBtn" class="btn btn-primary btn-lg btn-block">
                            Completar Registro
                        </button>
                    </form>
                    
                    <div class="login-link-section">
                        <p>¬øYa tienes cuenta? <a href="login.html">Inicia sesi√≥n aqu√≠</a></p>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n de Supabase (inline para evitar problemas de rutas)
        const SUPABASE_URL = "https://rrgxvwttarkcxqfekfeb.supabase.co"
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZ3h2d3R0YXJrY3hxZmVrZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTE1MjUsImV4cCI6MjA3NDkyNzUyNX0.xYEQV8ZkW9h99psdqTU2XpGicDGHs7q6M8V7lq35ryQ"
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // Funciones de autenticaci√≥n b√°sicas
        window.authUtils = {
            isLoggedIn: () => {
                // Verificar si hay sesi√≥n activa
                return false // Por ahora, para el registro
            }
        }
    </script>

    <script>
        let invitationData = null

        // Obtener token de la URL
        function getInvitationToken() {
            const urlParams = new URLSearchParams(window.location.search)
            return urlParams.get('token')
        }

        // Mostrar mensaje
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message')
            messageDiv.textContent = message
            
            // Mapear tipos a clases de alert
            const alertClass = {
                'error': 'alert-danger',
                'success': 'alert-success',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info'
            
            messageDiv.className = `alert ${alertClass}`
            messageDiv.style.display = 'block'
            
            setTimeout(() => {
                messageDiv.style.display = 'none'
            }, 5000)
        }

        // Validar invitaci√≥n (m√©todo simplificado)
        async function validateInvitation(token) {
            if (!token) {
                showMessage("Token de invitaci√≥n no encontrado en la URL", "error")
                return false
            }

            try {
                // Buscar invitaci√≥n directamente en la tabla
                const { data: invitation, error } = await supabaseClient
                    .from('invitaciones')
                    .select(`
                        *,
                        empresa:empresa_id (
                            empresa_id,
                            nombre
                        )
                    `)
                    .eq('token', token)
                    .single()

                if (error) {
                    console.error('Error buscando invitaci√≥n:', error)
                    showMessage("Invitaci√≥n no encontrada o no v√°lida", "error")
                    return false
                }

                // Verificar si est√° usada
                if (invitation.usado) {
                    showMessage("Esta invitaci√≥n ya ha sido utilizada", "error")
                    return false
                }

                // Verificar si ha expirado
                const now = new Date()
                const expiration = new Date(invitation.fecha_expiracion)
                if (expiration <= now) {
                    showMessage("Esta invitaci√≥n ha expirado. Contacta al administrador para una nueva invitaci√≥n.", "warning")
                    return false
                }

                // Invitaci√≥n v√°lida
                invitationData = {
                    empresa_id: invitation.empresa_id,
                    empresa_nombre: invitation.empresa.nombre,
                    email: invitation.email,
                    puesto_sugerido: invitation.puesto_sugerido
                }
                
                // Mostrar informaci√≥n de la invitaci√≥n
                document.getElementById('empresaNombre').textContent = invitationData.empresa_nombre
                document.getElementById('emailInvitado').textContent = invitationData.email
                document.getElementById('puestoSugerido').textContent = invitationData.puesto_sugerido || 'No especificado'
                document.getElementById('invitationInfo').style.display = 'block'
                
                // Pre-llenar el formulario
                document.getElementById('invitationToken').value = token
                document.getElementById('empresaId').value = invitationData.empresa_id
                document.getElementById('email').value = invitationData.email
                document.getElementById('puesto').value = invitationData.puesto_sugerido || ''
                
                return true

            } catch (error) {
                console.error('Error validando invitaci√≥n:', error)
                showMessage("Error de conexi√≥n validando invitaci√≥n", "error")
                return false
            }
        }

        // Manejar registro
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const formData = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                puesto: document.getElementById('puesto').value.trim(),
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirmPassword').value,
                token: document.getElementById('invitationToken').value,
                empresaId: document.getElementById('empresaId').value
            }

            // Validaciones
            if (!formData.fullName || !formData.puesto || !formData.password || !formData.confirmPassword) {
                showMessage("Por favor completa todos los campos", "error")
                return
            }

            if (formData.password.length < 6) {
                showMessage("La contrase√±a debe tener al menos 6 caracteres", "error")
                return
            }

            if (formData.password !== formData.confirmPassword) {
                showMessage("Las contrase√±as no coinciden", "error")
                return
            }

            if (formData.email !== invitationData.email) {
                showMessage("El email no coincide con la invitaci√≥n", "error")
                return
            }

            const registerBtn = document.getElementById('registerBtn')
            registerBtn.disabled = true
            registerBtn.textContent = "Registrando..."

            try {
                // Crear usuario en auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: formData.email,
                    password: formData.password,
                    options: {
                        data: {
                            full_name: formData.fullName,
                            empresa_id: formData.empresaId,
                            puesto: formData.puesto,
                            invitation_token: formData.token
                        }
                    }
                })

                if (authError) {
                    console.error('‚ùå Error en signUp:', authError)
                    showMessage("Error creando usuario: " + authError.message, "error")
                    registerBtn.disabled = false
                    registerBtn.textContent = "Registrarse"
                    return
                }

                console.log('‚úÖ Usuario creado en auth:', authData.user.id)

                // Verificar si es el primer worker de la empresa (ser√° admin autom√°ticamente)
                console.log('üîç Verificando si es el primer trabajador de la empresa...')
                const { data: existingWorkers, error: countError } = await supabaseClient
                    .from('worker')
                    .select('worker_id', { count: 'exact', head: true })
                    .eq('empresa_id', formData.empresaId)

                if (countError) {
                    console.warn('‚ö†Ô∏è Error verificando workers existentes:', countError)
                }

                const workerCount = existingWorkers?.length || 0
                const isFirstWorker = workerCount === 0
                const rolAsignado = isFirstWorker ? 'admin' : 'trabajador'

                console.log(`üìä Workers existentes: ${workerCount} ‚Üí Rol asignado: ${rolAsignado}${isFirstWorker ? ' üëë (Primer usuario = Admin)' : ''}`)

                // Crear registro en worker CON user_id
                console.log('üìù Insertando worker con datos:', {
                    user_id: authData.user.id,
                    empresa_id: formData.empresaId,
                    nombre: formData.fullName,
                    mail: formData.email,
                    puesto: formData.puesto,
                    rol: rolAsignado,
                    is_super_admin: false
                })

                const { data: workerData, error: workerError } = await supabaseClient
                    .from('worker')
                    .insert({
                        user_id: authData.user.id,
                        empresa_id: formData.empresaId,
                        nombre: formData.fullName,
                        mail: formData.email,
                        puesto: formData.puesto,
                        rol: rolAsignado,
                        is_super_admin: false
                    })
                    .select()

                if (workerError) {
                    console.error('‚ùå Error creando worker:', workerError)
                    showMessage("‚ùå Error CR√çTICO: No se pudo crear el perfil de trabajador. C√≥digo: " + workerError.code + " - " + workerError.message + ". Contacta al administrador con tu email: " + formData.email, "error")
                    registerBtn.disabled = false
                    registerBtn.textContent = "Registrarse"
                    return
                }

                console.log('‚úÖ Worker creado:', workerData)

                // Marcar invitaci√≥n como usada
                const { error: useError } = await supabaseClient
                    .from('invitaciones')
                    .update({
                        usado: true,
                        fecha_usado: new Date().toISOString()
                    })
                    .eq('token', formData.token)

                if (useError) {
                    console.error('Error marcando invitaci√≥n como usada:', useError)
                    // No es cr√≠tico, continuar
                }

                const mensajeExito = isFirstWorker 
                    ? "¬°Registro completado exitosamente! üëë Eres el primer usuario, por lo tanto eres ADMINISTRADOR de la empresa. Revisa tu email para confirmar tu cuenta."
                    : "¬°Registro completado exitosamente! Has sido registrado como trabajador. Revisa tu email para confirmar tu cuenta."

                showMessage(mensajeExito, "success")
                
                // Limpiar formulario
                document.getElementById('registerForm').reset()
                
                // Redirigir despu√©s de un tiempo
                setTimeout(() => {
                    window.location.href = "login.html"
                }, 3000)

            } catch (error) {
                console.error('Error en registro:', error)
                showMessage("Error de conexi√≥n: " + error.message, "error")
            } finally {
                registerBtn.disabled = false
                registerBtn.textContent = "Completar Registro"
            }
        })

        // Inicializar p√°gina
        window.addEventListener('load', async () => {
            // Verificar si ya est√° logueado
            if (window.authUtils && window.authUtils.isLoggedIn()) {
                showMessage("Ya tienes una sesi√≥n activa", "success")
                setTimeout(() => {
                    window.location.href = "../index.html"
                }, 2000)
                return
            }

            // Validar token de invitaci√≥n
            const token = getInvitationToken()
            await validateInvitation(token)
        })
    </script>
</body>
</html>