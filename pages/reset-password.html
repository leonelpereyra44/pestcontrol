<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer Contrase√±a - Sistema de Control de Plagas</title>
  <link rel="stylesheet" href="../css/login.css">
</head>
<body class="auth-page">
  <!-- Navbar -->
  <nav class="navbar">
    <a href="../index.html" class="logo">üêõ PCP Sistema</a>
    <a href="../index.html" class="back-link">‚Üê Volver al Inicio</a>
  </nav>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Procesando...</p>
    </div>
  </div>

  <div class="auth-wrapper">
    <div class="form-container">
      <div class="card">
        <div class="card-body">
          <!-- Icon -->
          <div class="login-icon">
            üîë
          </div>

          <!-- Title & Subtitle -->
          <h2 class="login-title">Restablecer Contrase√±a</h2>
          <p class="login-subtitle">Ingresa tu nueva contrase√±a.</p>
          
          <div id="message" class="message"></div>
          
          <form onsubmit="updatePassword(); return false;">
            <!-- Nueva Contrase√±a -->
            <div class="form-group">
              <label for="newPassword">Nueva Contrase√±a</label>
              <div class="input-with-icon">
                <span class="input-icon">üîí</span>
                <input 
                  type="password" 
                  id="newPassword" 
                  class="form-control" 
                  placeholder="M√≠nimo 6 caracteres" 
                  minlength="6"
                  required 
                />
              </div>
              <small style="color: var(--color-text-secondary); font-size: 13px; margin-top: 6px; display: block;">
                La contrase√±a debe tener al menos 6 caracteres
              </small>
            </div>
            
            <!-- Confirmar Contrase√±a -->
            <div class="form-group">
              <label for="confirmPassword">Confirmar Contrase√±a</label>
              <div class="input-with-icon">
                <span class="input-icon">üîí</span>
                <input 
                  type="password" 
                  id="confirmPassword" 
                  class="form-control" 
                  placeholder="Repite tu contrase√±a" 
                  minlength="6"
                  required 
                />
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg btn-block btn-submit" id="updateBtn">
              Actualizar Contrase√±a
            </button>
          </form>
          
          <!-- Info box -->
          <div class="info-box">
            <div class="info-box-icon">üí°</div>
            <div class="info-box-content">
              <div class="info-box-title">Consejo de Seguridad</div>
              <p class="info-box-text">
                Usa una contrase√±a segura que combine letras, n√∫meros y s√≠mbolos. No compartas tu contrase√±a con nadie.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../ts/config.js"></script>
  <script>
    const { createClient } = supabase
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = (window.APP_CONFIG || {})
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      console.error('Missing Supabase config. Aseg√∫rate de cargar ts/config.js o de generar el archivo en build.')
      alert('Error de configuraci√≥n: faltan credenciales de Supabase. Contacta al administrador.')
      throw new Error('Missing Supabase config')
    }
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message')
      messageDiv.textContent = message
      messageDiv.className = type === 'error' ? 'alert alert-danger' : 'alert alert-success'
      messageDiv.style.display = 'block'
      
      // Ocultar mensaje despu√©s de 5 segundos
      setTimeout(() => {
        messageDiv.style.display = 'none'
        messageDiv.textContent = ''
      }, 5000)
    }

    async function updatePassword() {
      const newPassword = document.getElementById('newPassword').value
      const confirmPassword = document.getElementById('confirmPassword').value
      const updateBtn = document.getElementById('updateBtn')
      const loadingOverlay = document.getElementById('loadingOverlay')

      // Validar que las contrase√±as coincidan
      if (newPassword !== confirmPassword) {
        showMessage("Las contrase√±as no coinciden", "error")
        return
      }

      // Validar longitud m√≠nima
      if (newPassword.length < 6) {
        showMessage("La contrase√±a debe tener al menos 6 caracteres", "error")
        return
      }

      try {
        // Mostrar loader
        updateBtn.classList.add('loading')
        updateBtn.disabled = true
        loadingOverlay.classList.add('active')

        const { error } = await supabaseClient.auth.updateUser({
          password: newPassword
        })

        // Ocultar loader
        loadingOverlay.classList.remove('active')
        updateBtn.classList.remove('loading')
        updateBtn.disabled = false

        if (error) {
          showMessage("Error: " + error.message, "error")
        } else {
          showMessage("‚úÖ Contrase√±a actualizada exitosamente", "success")
          
          // Redirigir al login despu√©s de 2 segundos
          setTimeout(() => {
            window.location.href = "login.html"
          }, 2000)
        }
      } catch (error) {
        // Ocultar loader en caso de error
        loadingOverlay.classList.remove('active')
        updateBtn.classList.remove('loading')
        updateBtn.disabled = false
        showMessage("Error de conexi√≥n: " + error.message, "error")
      }
    }

    // Verificar si hay una sesi√≥n de recuperaci√≥n v√°lida
    window.addEventListener('load', async () => {
      const { data } = await supabaseClient.auth.getSession()
      
      if (!data.session) {
        showMessage("‚ùå Enlace inv√°lido o expirado. Solicita uno nuevo.", "error")
        
        setTimeout(() => {
          window.location.href = "login.html"
        }, 3000)
      }
    })

    // Permitir submit con Enter
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        updatePassword()
      }
    })
  </script>
</body>
</html>
