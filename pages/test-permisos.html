<!DOCTYPE html>
<html>
<head>
    <title>Test de Permisos - Debug</title>
</head>
<body>
    <h1>Test de Diagnóstico de Permisos</h1>
    <div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../ts/auth.js"></script>
    
    <script>
        const output = document.getElementById('output')
        
        function log(message, data = null) {
            const p = document.createElement('p')
            p.innerHTML = `<strong>${message}</strong>`
            if (data) {
                p.innerHTML += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`
            }
            output.appendChild(p)
            console.log(message, data)
        }

        async function runTests() {
            log('===== INICIANDO TESTS DE DIAGNÓSTICO =====')
            
            // Test 1: ¿Está logueado?
            await new Promise(r => setTimeout(r, 1000))
            const isLoggedIn = window.authUtils?.isLoggedIn()
            log('1. ¿Usuario logueado?', isLoggedIn)
            
            if (!isLoggedIn) {
                log('❌ NO ESTÁS LOGUEADO. Ve a login primero.')
                return
            }
            
            // Test 2: Usuario actual
            const currentUser = window.authUtils.getCurrentUser()
            log('2. Usuario actual', {
                id: currentUser?.id,
                email: currentUser?.email
            })
            
            // Test 3: Obtener perfil
            log('3. Obteniendo perfil...')
            const profile = await window.authUtils.getWorkerProfile()
            log('3. Perfil obtenido', profile)
            
            if (!profile) {
                log('❌ PERFIL ES NULL - PROBLEMA AQUÍ')
                
                // Test 3.1: Intentar query directo por user_id
                log('3.1. Intentando query directo por user_id...')
                const { data: byUserId, error: errorById } = await supabaseClient
                    .from('worker')
                    .select('*')
                    .eq('user_id', currentUser.id)
                log('3.1. Resultado por user_id', { data: byUserId, error: errorById })
                
                // Test 3.2: Intentar query directo por email
                log('3.2. Intentando query directo por email...')
                const { data: byEmail, error: errorByEmail } = await supabaseClient
                    .from('worker')
                    .select('*')
                    .eq('mail', currentUser.email)
                log('3.2. Resultado por email', { data: byEmail, error: errorByEmail })
                
                return
            }
            
            // Test 4: Verificar rol
            log('4. Rol del usuario', profile.rol)
            log('4. ¿Es admin o supervisor?', ['admin', 'supervisor'].includes(profile.rol))
            
            log('===== TESTS COMPLETADOS =====')
        }
        
        window.addEventListener('load', () => {
            setTimeout(runTests, 2000)
        })
    </script>
</body>
</html>
