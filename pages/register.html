<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro - Plagas V3</title>
  <link rel="stylesheet" href="../css/auth.css">
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loader"></div>
      <div class="loading-text">
        <span class="loading-dots">Creando cuenta</span>
      </div>
    </div>
  </div>

  <div class="form-container">
    <h2>Crear Cuenta</h2>
    
    <div id="message" class="message"></div>
    
    <input type="text" id="fullName" placeholder="Nombre completo" required />
    <input type="email" id="email" placeholder="Email" required />
    
    <select id="empresa" required>
      <option value="">Selecciona el código de tu empresa...</option>
    </select>
    
    <input type="text" id="puesto" placeholder="Puesto de trabajo" required />
    
    <input type="password" id="password" placeholder="Contraseña" required />
    <div class="password-requirements">
      La contraseña debe tener al menos 6 caracteres
    </div>
    <input type="password" id="confirmPassword" placeholder="Confirmar contraseña" required />
    
    <button id="registerBtn" onclick="signUp()">Crear Cuenta</button>
    
    <div class="link">
      <p>¿Ya tienes cuenta? <a href="login.html">Inicia sesión aquí</a></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase

    const SUPABASE_URL = "https://rrgxvwttarkcxqfekfeb.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZ3h2d3R0YXJrY3hxZmVrZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTE1MjUsImV4cCI6MjA3NDkyNzUyNX0.xYEQV8ZkW9h99psdqTU2XpGicDGHs7q6M8V7lq35ryQ"

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message')
      messageDiv.textContent = message
      messageDiv.className = `message ${type}`
      messageDiv.style.display = 'block'
      
      // Ocultar mensaje después de 5 segundos
      setTimeout(() => {
        messageDiv.style.display = 'none'
      }, 5000)
    }

    function validatePassword(password) {
      if (password.length < 6) {
        return "La contraseña debe tener al menos 6 caracteres"
      }
      return null
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!emailRegex.test(email)) {
        return "Por favor ingresa un email válido"
      }
      return null
    }

    async function signUp() {
      const fullName = document.getElementById("fullName").value.trim()
      const email = document.getElementById("email").value.trim()
      const empresaId = document.getElementById("empresa").value
      const puesto = document.getElementById("puesto").value.trim()
      const password = document.getElementById("password").value
      const confirmPassword = document.getElementById("confirmPassword").value
      const registerBtn = document.getElementById("registerBtn")

      // Validar campos vacíos
      if (!fullName || !email || !empresaId || !puesto || !password || !confirmPassword) {
        showMessage("Por favor completa todos los campos", "error")
        return
      }

      // Validar email
      const emailError = validateEmail(email)
      if (emailError) {
        showMessage(emailError, "error")
        return
      }

      // Validar contraseña
      const passwordError = validatePassword(password)
      if (passwordError) {
        showMessage(passwordError, "error")
        return
      }

      // Verificar que las contraseñas coincidan
      if (password !== confirmPassword) {
        showMessage("Las contraseñas no coinciden", "error")
        return
      }

      // Obtener información de la empresa seleccionada
      const empresaSelect = document.getElementById("empresa")
      const empresaOption = empresaSelect.options[empresaSelect.selectedIndex]
      const empresaNombre = empresaOption.textContent.split(' - ')[1] // Extraer nombre después del código

      // Deshabilitar botón durante el registro
      registerBtn.disabled = true
      registerBtn.textContent = "Creando cuenta..."

      try {
        // Paso 1: Crear usuario en auth
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: fullName,
              empresa_id: empresaId,
              puesto: puesto
            }
          }
        })

        if (authError) {
          showMessage("Error creando usuario: " + authError.message, "error")
          return
        }

        // Paso 2: Crear registro en la tabla worker
        if (authData.user) {
          const { error: workerError } = await supabaseClient
            .from('worker')
            .insert({
              worker_id: authData.user.id, // Usar el UUID del usuario de auth
              empresa_id: empresaId,
              nombre: fullName,
              mail: email,
              puesto: puesto
            })

          if (workerError) {
            console.error('Error creando worker:', workerError)
            // El usuario ya se creó en auth, pero falló crear el worker
            showMessage("Usuario creado, pero hubo un problema con el perfil. Contacta al administrador.", "error")
            return
          }
        }

        showMessage(`¡Cuenta creada exitosamente en ${empresaNombre}! Revisa tu email para confirmar tu cuenta.`, "success")
        
        // Limpiar formulario
        document.getElementById("fullName").value = ""
        document.getElementById("email").value = ""
        document.getElementById("empresa").value = ""
        document.getElementById("puesto").value = ""
        document.getElementById("password").value = ""
        document.getElementById("confirmPassword").value = ""
        
        // Redirigir a login después de un tiempo
        setTimeout(() => {
          window.location.href = "login.html"
        }, 3000)

      } catch (error) {
        showMessage("Error de conexión: " + error.message, "error")
        console.error('Error completo:', error)
      } finally {
        // Rehabilitar botón
        registerBtn.disabled = false
        registerBtn.textContent = "Crear Cuenta"
      }
    }

    // Permitir registro con Enter
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        signUp()
      }
    })

    // Cargar empresas disponibles (mostrando códigos)
    async function loadEmpresas() {
      try {
        const { data: empresas, error } = await supabaseClient
          .from('empresa')
          .select('empresa_id, nombre, codigo')
          .order('codigo')

        if (error) {
          console.error('Error cargando empresas:', error)
          showMessage("Error cargando códigos de empresa disponibles", "error")
          return
        }

        const empresaSelect = document.getElementById('empresa')
        empresaSelect.innerHTML = '<option value="">Selecciona el código de tu empresa...</option>'
        
        empresas.forEach(empresa => {
          const option = document.createElement('option')
          option.value = empresa.empresa_id
          // Mostrar código - nombre en el dropdown
          option.textContent = `${empresa.codigo} - ${empresa.nombre}`
          empresaSelect.appendChild(option)
        })
      } catch (error) {
        console.error('Error cargando empresas:', error)
        showMessage("Error de conexión al cargar códigos de empresa", "error")
      }
    }

    // Verificar si el usuario ya está logueado
    window.addEventListener('load', async () => {
      const { data } = await supabaseClient.auth.getSession()
      if (data.session) {
        showMessage("Ya tienes una sesión activa", "success")
        setTimeout(() => {
          window.location.href = "../index.html"
        }, 2000)
        return
      }
      
      // Mostrar mensaje de registro por invitación
      showMessage("El registro ahora es solo por invitación. Contacta a tu administrador.", "warning")
      
      // Deshabilitar formulario
      const form = document.querySelector('form') || document.body
      form.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <h3>🔐 Registro por Invitación Únicamente</h3>
          <p>Para mantener la seguridad del sistema, el registro ahora es solo por invitación.</p>
          <p><strong>Si tienes una invitación:</strong> Usa el link que recibiste por email</p>
          <p><strong>Si necesitas acceso:</strong> Contacta al administrador de tu empresa</p>
          <div style="margin-top: 30px;">
            <a href="login.html" style="
              display: inline-block;
              padding: 12px 24px;
              background-color: #4CAF50;
              color: white;
              text-decoration: none;
              border-radius: 4px;
              margin: 10px;
            ">Ir al Login</a>
            <a href="../index.html" style="
              display: inline-block;
              padding: 12px 24px;
              background-color: #6c757d;
              color: white;
              text-decoration: none;
              border-radius: 4px;
              margin: 10px;
            ">Volver al Inicio</a>
          </div>
        </div>
      `
    })

    // Validación en tiempo real de contraseñas
    document.getElementById('confirmPassword').addEventListener('input', function() {
      const password = document.getElementById('password').value
      const confirmPassword = this.value
      
      if (confirmPassword && password !== confirmPassword) {
        this.style.borderColor = '#dc3545'
      } else {
        this.style.borderColor = '#ddd'
      }
    })
  </script>
</body>
</html>
