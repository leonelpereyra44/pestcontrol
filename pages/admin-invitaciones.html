<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Invitaciones - Admin</title>
    <!-- CSS standalone -->
    <link rel="stylesheet" href="../css/admin-invitaciones.css">
</head>
<body>
    <div class="page-wrapper">
    <div class="container">
        <!-- Header -->
        <header class="page-header">
            <div class="header-content">
                <h1 class="header-title">‚úâÔ∏è Gesti√≥n de Invitaciones</h1>
                <p style="color: var(--color-text-secondary);">Administra las invitaciones para nuevos trabajadores</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openInviteModal()">
                    ‚ûï Nueva Invitaci√≥n
                </button>
                <a href="/pages/dashboard.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </header>

        <!-- Tabla de invitaciones -->
        <div id="invitationsTable">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Cargando invitaciones...</p>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal para nueva invitaci√≥n -->
    <div id="inviteModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Nueva Invitaci√≥n</h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <form id="inviteForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="inviteEmail">Email del Invitado *</label>
                        <input type="email" id="inviteEmail" class="form-control" placeholder="usuario@ejemplo.com" required>
                    </div>
                    <div class="form-group">
                        <label for="invitePuesto">Puesto Sugerido</label>
                        <input type="text" id="invitePuesto" class="form-control" placeholder="ej: T√©cnico, Supervisor">
                        <small>Este campo es opcional</small>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Enviar Invitaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../ts/config.js"></script>
    <script>
        // Configuraci√≥n de Supabase desde ts/config.js
        const { SUPABASE_URL, SUPABASE_ANON_KEY } = (window.APP_CONFIG || {})
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Missing Supabase config. Aseg√∫rate de cargar ts/config.js o de generar el archivo en build.')
            alert('Error de configuraci√≥n: faltan credenciales de Supabase. Contacta al administrador.')
            throw new Error('Missing Supabase config')
        }
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // Funciones de autenticaci√≥n simplificadas
        window.authUtils = {
            isLoggedIn: async () => {
                const { data } = await supabaseClient.auth.getSession()
                return !!data.session
            },
            getCurrentUser: () => {
                return supabaseClient.auth.getUser().then(({ data }) => data.user)
            },
            getWorkerProfile: async () => {
                const { data: session } = await supabaseClient.auth.getSession()
                if (!session.session) return null
                
                const user = session.session.user
                
                try {
                    // Intentar por user_id primero
                    let { data: worker, error } = await supabaseClient
                        .from('worker')
                        .select(`
                            *,
                            empresa:empresa_id (
                                empresa_id,
                                nombre
                            )
                        `)
                        .eq('user_id', user.id)
                        .maybeSingle()
                    
                    // Si no encuentra por user_id, buscar por email
                    if (!worker && user.email) {
                        console.log('üîç Buscando por email...')
                        const result = await supabaseClient
                            .from('worker')
                            .select(`
                                *,
                                empresa:empresa_id (
                                    empresa_id,
                                    nombre
                                )
                            `)
                            .eq('mail', user.email)
                            .maybeSingle()
                        
                        worker = result.data
                        error = result.error
                    }
                    
                    if (error) {
                        console.error('Error obteniendo worker profile:', error)
                    }
                    
                    return worker
                } catch (error) {
                    console.error('Error obteniendo worker profile:', error)
                    return null
                }
            }
        }
    </script>

    <script>
        let currentWorkerInfo = null

        // Verificar permisos de admin
        async function checkAdminPermissions() {
            console.log('üîç Verificando permisos de admin...')
            
            if (!window.authUtils || !window.authUtils.isLoggedIn()) {
                console.log('‚ùå No est√° logueado')
                window.location.href = 'login.html'
                return false
            }

            try {
                // Obtener perfil directamente sin reintentos complejos
                const workerInfo = await window.authUtils.getWorkerProfile()
                
                console.log('üìã Worker Info obtenido:', workerInfo)
                console.log('üë§ Rol del usuario:', workerInfo?.rol)
                console.log('‚úîÔ∏è ¬øEs admin o supervisor?:', ['admin', 'supervisor'].includes(workerInfo?.rol))
                
                if (!workerInfo) {
                    console.error('‚ùå No se pudo obtener el perfil del worker')
                    alert('Error: No se pudo cargar tu perfil de usuario. Por favor, cierra sesi√≥n y vuelve a entrar.')
                    return false
                }
                
                if (!['admin', 'supervisor'].includes(workerInfo.rol)) {
                    console.error('‚ùå Acceso denegado. Rol:', workerInfo.rol)
                    alert('No tienes permisos para acceder a esta p√°gina. Tu rol: ' + workerInfo.rol)
                    window.location.href = '../index.html'
                    return false
                }

                console.log('‚úÖ Permisos verificados correctamente')
                currentWorkerInfo = workerInfo
                return true
            } catch (error) {
                console.error('‚ùå Error verificando permisos:', error)
                alert('Error verificando permisos: ' + error.message)
                return false
            }
        }

        // Cargar invitaciones
        async function loadInvitations() {
            try {
                const { data: invitations, error } = await supabaseClient
                    .from('invitaciones')
                    .select(`
                        *,
                        empresa:empresa_id(nombre),
                        invitador:invitado_por(nombre)
                    `)
                    .eq('empresa_id', currentWorkerInfo.empresa_id)
                    .order('fecha_invitacion', { ascending: false })

                if (error) {
                    console.error('Error cargando invitaciones:', error)
                    document.getElementById('invitationsTable').innerHTML = `
                        <div style="color: red;">Error cargando invitaciones: ${error.message}</div>
                    `
                    return
                }

                if (!invitations || invitations.length === 0) {
                    document.getElementById('invitationsTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úâÔ∏è</div>
                            <h3 class="empty-state-title">No hay invitaciones registradas</h3>
                            <p class="empty-state-message">Crea la primera invitaci√≥n usando el bot√≥n "Nueva Invitaci√≥n"</p>
                        </div>
                    `
                    return
                }

                // Crear tabla
                const now = new Date()
                const tableHTML = `
                    <div class="table-container">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Puesto</th>
                                    <th>Estado</th>
                                    <th>Fecha Invitaci√≥n</th>
                                    <th>Expira</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invitations.map(inv => {
                                    const expired = new Date(inv.fecha_expiracion) <= now
                                    const status = inv.usado ? 'used' : (expired ? 'expired' : 'pending')
                                    const statusText = inv.usado ? 'Usado' : (expired ? 'Expirado' : 'Pendiente')
                                    
                                    let badgeClass = 'badge-warning'
                                    if (inv.usado) badgeClass = 'badge-success'
                                    if (expired) badgeClass = 'badge-danger'
                                    
                                    return `
                                        <tr>
                                            <td><strong>${inv.email}</strong></td>
                                            <td>${inv.puesto_sugerido || '<span style="color: var(--color-text-muted);">No especificado</span>'}</td>
                                            <td><span class="badge ${badgeClass}">${statusText}</span></td>
                                            <td>${new Date(inv.fecha_invitacion).toLocaleDateString('es-ES')}</td>
                                            <td>${new Date(inv.fecha_expiracion).toLocaleDateString('es-ES')}</td>
                                            <td class="text-center">
                                                <div class="action-buttons">
                                                    ${!inv.usado && !expired ? `
                                                        <button class="btn btn-info" onclick="copyInvitationLink('${inv.token}')" title="Copiar link">
                                                            üîó
                                                        </button>
                                                    ` : ''}
                                                    <button class="btn btn-danger" onclick="deleteInvitation('${inv.id}')" title="Eliminar">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `

                document.getElementById('invitationsTable').innerHTML = tableHTML

            } catch (error) {
                console.error('Error cargando invitaciones:', error)
                document.getElementById('invitationsTable').innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error de conexi√≥n cargando invitaciones
                    </div>
                `
            }
        }

        // Generar token √∫nico
        function generateToken() {
            return 'INV-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
        }

        // Crear nueva invitaci√≥n
        async function createInvitation(email, puesto) {
            try {
                const token = generateToken()
                
                const { data, error } = await supabaseClient
                    .from('invitaciones')
                    .insert({
                        empresa_id: currentWorkerInfo.empresa_id,
                        email: email,
                        puesto_sugerido: puesto,
                        invitado_por: currentWorkerInfo.worker_id,
                        token: token,
                        fecha_expiracion: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                    })
                    .select()
                    .single()

                if (error) {
                    alert('Error creando invitaci√≥n: ' + error.message)
                    return false
                }

                // Mostrar link de invitaci√≥n
                const invitationUrl = `${window.location.origin}${window.location.pathname.replace('admin-invitaciones.html', '')}registro-invitacion.html?token=${token}`
                
                const linkModal = `
                    <div id="successModal" class="modal-overlay active">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>‚úÖ Invitaci√≥n Creada</h2>
                                <button class="modal-close" onclick="closeSuccessModal()">‚úï</button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success">
                                    <p style="margin: 0;"><strong>Email:</strong> ${email}</p>
                                    <p style="margin: var(--spacing-xs) 0 0 0;"><strong>Puesto:</strong> ${puesto || 'No especificado'}</p>
                                </div>
                                <div class="form-group">
                                    <label>Link de invitaci√≥n:</label>
                                    <textarea readonly class="form-control" style="height: 100px; font-family: monospace; font-size: var(--font-size-sm);">${invitationUrl}</textarea>
                                    <small style="color: var(--color-text-muted);">üí° Env√≠a este link al usuario para que pueda registrarse. El link expira en 7 d√≠as.</small>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button onclick="copyToClipboard('${invitationUrl}')" class="btn btn-info">
                                    üìã Copiar Link
                                </button>
                                <button onclick="closeSuccessModal()" class="btn btn-secondary">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                `
                document.body.insertAdjacentHTML('beforeend', linkModal)
                
                return true

            } catch (error) {
                console.error('Error creando invitaci√≥n:', error)
                alert('Error de conexi√≥n creando invitaci√≥n')
                return false
            }
        }

        // Funci√≥n para copiar al portapapeles
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Link copiado al portapapeles')
            }).catch(err => {
                prompt('Copia este link manualmente:', text)
            })
        }

        // Funci√≥n para cerrar el modal de √©xito
        function closeSuccessModal() {
            const modal = document.getElementById('successModal')
            if (modal) {
                modal.remove()
            }
        }

        // Copiar link de invitaci√≥n
        function copyInvitationLink(token) {
            const baseUrl = window.location.origin + window.location.pathname.replace('admin-invitaciones.html', '')
            const invitationUrl = `${baseUrl}registro-invitacion.html?token=${token}`
            
            navigator.clipboard.writeText(invitationUrl).then(() => {
                alert('Link de invitaci√≥n copiado al portapapeles')
            }).catch(err => {
                prompt('Copia este link para enviar la invitaci√≥n:', invitationUrl)
            })
        }

        // Eliminar invitaci√≥n
        async function deleteInvitation(invitationId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta invitaci√≥n?')) return

            try {
                const { error } = await supabaseClient
                    .from('invitaciones')
                    .delete()
                    .eq('id', invitationId)

                if (error) {
                    alert('Error eliminando invitaci√≥n: ' + error.message)
                    return
                }

                alert('Invitaci√≥n eliminada')
                await loadInvitations()

            } catch (error) {
                console.error('Error eliminando invitaci√≥n:', error)
                alert('Error de conexi√≥n eliminando invitaci√≥n')
            }
        }

        // Modal functions
        function openInviteModal() {
            document.getElementById('inviteModal').classList.add('active')
            document.body.classList.add('modal-open')
        }

        function closeModal() {
            document.getElementById('inviteModal').classList.remove('active')
            document.body.classList.remove('modal-open')
            document.getElementById('inviteForm').reset()
        }

        // Form submission
        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const email = document.getElementById('inviteEmail').value.trim()
            const puesto = document.getElementById('invitePuesto').value.trim()

            if (await createInvitation(email, puesto)) {
                closeModal()
                await loadInvitations()
            }
        })

        // Initialize
        window.addEventListener('load', async () => {
            // Esperar a que se inicialicen los sistemas (igual que en test-permisos.html)
            await new Promise(resolve => setTimeout(resolve, 2000))
            
            if (await checkAdminPermissions()) {
                await loadInvitations()
            }
        })
    </script>
</body>
</html>