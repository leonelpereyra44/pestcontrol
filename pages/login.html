<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Sistema de Control de Plagas</title>
  <link rel="stylesheet" href="../css/login.css">
</head>
<body class="auth-page">
  <!-- Navbar -->
  <nav class="navbar">
    <a href="../index.html" class="logo">ğŸ› PCP Sistema</a>
    <a href="../index.html" class="back-link">â† Volver al Inicio</a>
  </nav>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Verificando credenciales...</p>
    </div>
  </div>

  <div class="auth-wrapper">
    <div class="form-container">
      <div class="card">
        <div class="card-body">
          <!-- Icon -->
          <div class="login-icon">
            ğŸ”
          </div>

          <!-- Title & Subtitle -->
          <h2 class="login-title">Iniciar SesiÃ³n</h2>
          <p class="login-subtitle">Accede a tu cuenta para continuar.</p>
          
          <div id="message" class="message"></div>
          
          <form onsubmit="signIn(); return false;">
            <!-- Email -->
            <div class="form-group">
              <label for="loginEmail">Email</label>
              <div class="input-with-icon">
                <span class="input-icon">ğŸ“§</span>
                <input 
                  type="email" 
                  id="loginEmail" 
                  class="form-control" 
                  placeholder="correo@ejemplo.com" 
                  required 
                />
              </div>
            </div>
            
            <!-- Password -->
            <div class="form-group">
              <label for="loginPassword">ContraseÃ±a</label>
              <div class="input-with-icon">
                <span class="input-icon">ğŸ”’</span>
                <input 
                  type="password" 
                  id="loginPassword" 
                  class="form-control" 
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                  required 
                />
              </div>
            </div>

            <!-- Remember me + Forgot password -->
            <div class="form-extras">
              <label class="remember-me">
                <input type="checkbox" id="rememberMe">
                <span>RecuÃ©rdame</span>
              </label>
              <a href="#" class="forgot-password" onclick="openForgotPasswordModal(); return false;">Â¿Olvidaste tu contraseÃ±a?</a>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg btn-block btn-submit" id="loginBtn">
              Ingresar
            </button>
          </form>
          
          <!-- Info box -->
          <div class="info-box">
            <div class="info-box-icon">â„¹ï¸</div>
            <div class="info-box-content">
              <div class="info-box-title">Â¿No tienes cuenta?</div>
              <p class="info-box-text">
                El registro es solo por invitaciÃ³n. Contacta al administrador de tu empresa para obtener una invitaciÃ³n.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de RecuperaciÃ³n de ContraseÃ±a -->
  <div class="modal-overlay" id="forgotPasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ”‘ Recuperar ContraseÃ±a</h3>
        <button class="modal-close" onclick="closeForgotPasswordModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 20px; color: var(--color-text-secondary);">
          Ingresa tu email y te enviaremos un enlace para restablecer tu contraseÃ±a.
        </p>
        <div id="resetMessage"></div>
        <form onsubmit="sendPasswordReset(); return false;">
          <div class="form-group">
            <label for="resetEmail">Email</label>
            <div class="input-with-icon">
              <span class="input-icon">ğŸ“§</span>
              <input 
                type="email" 
                id="resetEmail" 
                class="form-control" 
                placeholder="correo@ejemplo.com" 
                required 
              />
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeForgotPasswordModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="resetBtn">
              Enviar Enlace
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase

    const SUPABASE_URL = "https://rrgxvwttarkcxqfekfeb.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZ3h2d3R0YXJrY3hxZmVrZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTE1MjUsImV4cCI6MjA3NDkyNzUyNX0.xYEQV8ZkW9h99psdqTU2XpGicDGHs7q6M8V7lq35ryQ"

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message')
      messageDiv.textContent = message
      messageDiv.className = type === 'error' ? 'alert alert-danger' : 'alert alert-success'
      messageDiv.style.display = 'block'
      
      // Ocultar mensaje despuÃ©s de 5 segundos
      setTimeout(() => {
        messageDiv.style.display = 'none'
        messageDiv.textContent = ''
      }, 5000)
    }

    function showResetMessage(message, type) {
      const messageDiv = document.getElementById('resetMessage')
      messageDiv.textContent = message
      messageDiv.className = type === 'error' ? 'alert alert-danger' : 'alert alert-success'
      messageDiv.style.display = 'block'
      
      // Ocultar mensaje despuÃ©s de 5 segundos
      setTimeout(() => {
        messageDiv.style.display = 'none'
        messageDiv.textContent = ''
      }, 5000)
    }

    // Cargar preferencia de "Recordarme" al cargar la pÃ¡gina
    window.addEventListener('load', () => {
      const savedEmail = localStorage.getItem('rememberedEmail')
      if (savedEmail) {
        document.getElementById('loginEmail').value = savedEmail
        document.getElementById('rememberMe').checked = true
      }
    })

    async function signIn() {
      const email = document.getElementById("loginEmail").value
      const password = document.getElementById("loginPassword").value
      const rememberMe = document.getElementById("rememberMe").checked
      const loginBtn = document.getElementById("loginBtn")
      const loadingOverlay = document.getElementById("loadingOverlay")

      // Validar campos
      if (!email || !password) {
        showMessage("Por favor completa todos los campos", "error")
        return
      }

      try {
        // Mostrar loader
        loginBtn.classList.add('loading')
        loginBtn.disabled = true
        loadingOverlay.classList.add('active')
        
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        })

        // Ocultar loader
        loadingOverlay.classList.remove('active')
        loginBtn.classList.remove('loading')
        loginBtn.disabled = false

        if (error) {
          showMessage("Error: " + error.message, "error")
        } else {
          // Guardar email si "Recordarme" estÃ¡ activado
          if (rememberMe) {
            localStorage.setItem('rememberedEmail', email)
          } else {
            localStorage.removeItem('rememberedEmail')
          }

          // Mensaje de bienvenida personalizado
          const userName = data.user.email.split('@')[0]
          showMessage("Â¡Bienvenido " + userName + "! ğŸ‰", "success")
          
          // Redirigir despuÃ©s de login exitoso
          setTimeout(() => {
            window.location.href = "dashboard.html"
          }, 1500)
        }
      } catch (error) {
        // Ocultar loader en caso de error
        loadingOverlay.classList.remove('active')
        loginBtn.classList.remove('loading')
        loginBtn.disabled = false
        showMessage("Error de conexiÃ³n: " + error.message, "error")
      }
    }

    // Abrir modal de recuperaciÃ³n de contraseÃ±a
    function openForgotPasswordModal() {
      document.getElementById('forgotPasswordModal').classList.add('active')
      document.getElementById('resetEmail').focus()
    }

    // Cerrar modal de recuperaciÃ³n de contraseÃ±a
    function closeForgotPasswordModal() {
      document.getElementById('forgotPasswordModal').classList.remove('active')
      document.getElementById('resetEmail').value = ''
      document.getElementById('resetMessage').style.display = 'none'
    }

    // Enviar email de recuperaciÃ³n de contraseÃ±a
    async function sendPasswordReset() {
      const email = document.getElementById('resetEmail').value
      const resetBtn = document.getElementById('resetBtn')

      if (!email) {
        showResetMessage("Por favor ingresa tu email", "error")
        return
      }

      try {
        resetBtn.disabled = true
        resetBtn.textContent = 'Enviando...'

        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + '/pages/reset-password.html'
        })

        resetBtn.disabled = false
        resetBtn.textContent = 'Enviar Enlace'

        if (error) {
          showResetMessage("Error: " + error.message, "error")
        } else {
          showResetMessage("âœ… Se ha enviado un enlace de recuperaciÃ³n a tu email", "success")
          
          // Cerrar modal despuÃ©s de 3 segundos
          setTimeout(() => {
            closeForgotPasswordModal()
          }, 3000)
        }
      } catch (error) {
        resetBtn.disabled = false
        resetBtn.textContent = 'Enviar Enlace'
        showResetMessage("Error de conexiÃ³n: " + error.message, "error")
      }
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('forgotPasswordModal').addEventListener('click', (e) => {
      if (e.target.id === 'forgotPasswordModal') {
        closeForgotPasswordModal()
      }
    })

    // Permitir login con Enter
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const modal = document.getElementById('forgotPasswordModal')
        if (modal.classList.contains('active')) {
          sendPasswordReset()
        } else {
          signIn()
        }
      }
    })

    // Verificar si el usuario ya estÃ¡ logueado
    window.addEventListener('load', async () => {
      const { data } = await supabaseClient.auth.getSession()
      if (data.session) {
        showMessage("Ya tienes una sesiÃ³n activa", "success")
        setTimeout(() => {
          window.location.href = "dashboard.html"
        }, 2000)
      }
    })
  </script>
</body>
</html>