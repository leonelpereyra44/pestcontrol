<!DOC  <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Sistema de Control de Plagas</title>
  <link rel="stylesheet" href="../css/login.css">
</head>
<body class="auth-page">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Verificando credenciales...</p>
    </div>
  </div>

  <div class="auth-wrapper">
    <div class="form-container">
      <div class="card">
        <div class="card-body">
          <!-- Icon -->
          <div class="login-icon">
            ğŸ”
          </div>

          <!-- Title & Subtitle -->
          <h2 class="login-title">Iniciar SesiÃ³n</h2>
          <p class="login-subtitle">Accede a tu cuenta para continuar.</p>
          
          <div id="message" class="message"></div>
          
          <form onsubmit="signIn(); return false;">
            <!-- Email -->
            <div class="form-group">
              <label for="loginEmail">Email</label>
              <div class="input-with-icon">
                <span class="input-icon">ğŸ“§</span>
                <input 
                  type="email" 
                  id="loginEmail" 
                  class="form-control" 
                  placeholder="correo@ejemplo.com" 
                  required 
                />
              </div>
            </div>
            
            <!-- Password -->
            <div class="form-group">
              <label for="loginPassword">ContraseÃ±a</label>
              <div class="input-with-icon">
                <span class="input-icon">ğŸ”’</span>
                <input 
                  type="password" 
                  id="loginPassword" 
                  class="form-control" 
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                  required 
                />
              </div>
            </div>

            <!-- Remember me + Forgot password -->
            <div class="form-extras">
              <label class="remember-me">
                <input type="checkbox" id="rememberMe">
                <span>RecuÃ©rdame</span>
              </label>
              <a href="#" class="forgot-password">Â¿Olvidaste tu contraseÃ±a?</a>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg btn-block btn-submit" id="loginBtn">
              Ingresar
            </button>
          </form>
          
          <!-- Info box -->
          <div class="info-box">
            <div class="info-box-icon">â„¹ï¸</div>
            <div class="info-box-content">
              <div class="info-box-title">Â¿No tienes cuenta?</div>
              <p class="info-box-text">
                El registro es solo por invitaciÃ³n. Contacta al administrador de tu empresa para obtener una invitaciÃ³n.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase

    const SUPABASE_URL = "https://rrgxvwttarkcxqfekfeb.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZ3h2d3R0YXJrY3hxZmVrZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTE1MjUsImV4cCI6MjA3NDkyNzUyNX0.xYEQV8ZkW9h99psdqTU2XpGicDGHs7q6M8V7lq35ryQ"

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message')
      messageDiv.textContent = message
      messageDiv.className = type === 'error' ? 'alert alert-danger' : 'alert alert-success'
      messageDiv.style.display = 'block'
      
      // Ocultar mensaje despuÃ©s de 5 segundos
      setTimeout(() => {
        messageDiv.style.display = 'none'
        messageDiv.textContent = ''
      }, 5000)
    }

    async function signIn() {
      const email = document.getElementById("loginEmail").value
      const password = document.getElementById("loginPassword").value
      const loginBtn = document.getElementById("loginBtn")
      const loadingOverlay = document.getElementById("loadingOverlay")

      // Validar campos
      if (!email || !password) {
        showMessage("Por favor completa todos los campos", "error")
        return
      }

      try {
        // Mostrar loader
        loginBtn.classList.add('loading')
        loginBtn.disabled = true
        loadingOverlay.classList.add('active')
        
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        })

        // Ocultar loader
        loadingOverlay.classList.remove('active')
        loginBtn.classList.remove('loading')
        loginBtn.disabled = false

        if (error) {
          showMessage("Error: " + error.message, "error")
        } else {
          // Mensaje de bienvenida personalizado
          const userName = data.user.email.split('@')[0]
          showMessage("Â¡Bienvenido " + userName + "! ğŸ‰", "success")
          
          // Redirigir despuÃ©s de login exitoso
          setTimeout(() => {
            window.location.href = "dashboard.html"
          }, 1500)
        }
      } catch (error) {
        // Ocultar loader en caso de error
        loadingOverlay.classList.remove('active')
        loginBtn.classList.remove('loading')
        loginBtn.disabled = false
        showMessage("Error de conexiÃ³n: " + error.message, "error")
      }
    }

    // Permitir login con Enter
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        signIn()
      }
    })

    // Verificar si el usuario ya estÃ¡ logueado
    window.addEventListener('load', async () => {
      const { data } = await supabaseClient.auth.getSession()
      if (data.session) {
        showMessage("Ya tienes una sesiÃ³n activa", "success")
        setTimeout(() => {
          window.location.href = "dashboard.html"
        }, 2000)
      }
    })
  </script>
</body>
</html>