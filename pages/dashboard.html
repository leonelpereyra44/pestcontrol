<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PCP</title>
    <!-- CSS standalone -->
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <div class="header">
        <h1>PCP - Sistema de Gesti√≥n</h1>
        <div class="user-info" id="userInfo">
            <div class="loading">Cargando...</div>
        </div>
    </div>

    <div class="main-content">
        <div id="authContent">
            <div class="loading">Verificando sesi√≥n...</div>
        </div>
    </div>

    <!-- Incluir Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Incluir nuestro sistema de autenticaci√≥n -->
    <script src="../ts/auth.js"></script>
    <!-- Incluir funciones multi-tenant -->
    <script src="../ts/multi-tenant.js"></script>

    <script>
        // Funci√≥n para cerrar sesi√≥n
        async function logout() {
            console.log('üî¥ Logout function called!')
            console.log('üîç window.authUtils exists?', typeof window.authUtils)
            console.log('üîç window.authUtils.logout exists?', typeof window.authUtils?.logout)
            
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                try {
                    console.log('‚úÖ User confirmed, calling authUtils.logout()...')
                    const result = await window.authUtils.logout()
                    console.log('üìä Logout result:', result)
                } catch (error) {
                    console.error('‚ùå Error during logout:', error)
                    alert('Error al cerrar sesi√≥n: ' + error.message)
                }
            } else {
                console.log('‚ùå User cancelled logout')
            }
        }

        // Hacer la funci√≥n disponible globalmente
        window.logout = logout

        // Verificar que la funci√≥n est√© disponible globalmente
        console.log('‚úÖ Logout function defined:', typeof logout)
        console.log('‚úÖ window.logout defined:', typeof window.logout)

        // Esperar a que se inicialice la autenticaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            // Esperar un poco para que se inicialice la autenticaci√≥n
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            const userInfoContainer = document.getElementById('userInfo')
            const authContent = document.getElementById('authContent')
            
            if (window.authUtils && window.authUtils.isLoggedIn()) {
                // Usuario autenticado
                const user = window.authUtils.getCurrentUser()
                
                // Obtener informaci√≥n del worker y empresa
                try {
                    const workerProfile = await window.authUtils.getWorkerProfile()
                    
                    if (workerProfile) {
                        // Mostrar informaci√≥n completa del worker y empresa
                        userInfoContainer.innerHTML = `
                            <div class="user-text">
                                <div class="user-name">${workerProfile.nombre}</div>
                                <div class="user-details">${workerProfile.empresa.nombre} - ${workerProfile.puesto}</div>
                            </div>
                            <button onclick="logout()">Cerrar Sesi√≥n</button>
                        `
                    } else {
                        // Fallback si no se encuentra el perfil del worker
                        userInfoContainer.innerHTML = `
                            <span>Bienvenido, ${user.email}</span>
                            <button onclick="logout()">Cerrar Sesi√≥n</button>
                        `
                    }
                } catch (error) {
                    console.error('Error cargando perfil:', error)
                    // Fallback b√°sico
                    userInfoContainer.innerHTML = `
                        <span>Bienvenido, ${user.email}</span>
                        <button onclick="logout()">Cerrar Sesi√≥n</button>
                    `
                }
                
                // Mostrar contenido principal
                try {
                    const workerProfile = await window.authUtils.getWorkerProfile()
                    
                    if (workerProfile) {
                        // Verificar si es super admin sin empresa
                        if (workerProfile.is_super_admin && !workerProfile.empresa_id) {
                            // Super Admin SIN empresa - Panel especial
                            userInfoContainer.innerHTML = `
                                <div class="user-text">
                                    <div class="user-name">üëë ${workerProfile.nombre}</div>
                                    <div class="user-details">Super Administrador</div>
                                </div>
                                <button onclick="logout()">Cerrar Sesi√≥n</button>
                            `
                            
                            authContent.innerHTML = `
                                <div class="welcome-card">
                                    <h2>üëë Panel de Super Administrador</h2>
                                    <div class="super-admin-banner">
                                        <h3>Bienvenido, ${workerProfile.nombre}</h3>
                                        <p>Tienes acceso total al sistema para gestionar todas las empresas</p>
                                    </div>
                                    
                                    <div class="feature-grid">
                                        <div class="feature-card primary" onclick="window.location.href='super-admin.html'">
                                            <div class="icon">üè¢</div>
                                            <h3>Gesti√≥n de Empresas</h3>
                                            <p>Ver todas las empresas, crear nuevas y generar invitaciones</p>
                                            <div class="cta-button">
                                                ‚Üí Acceder al Panel
                                            </div>
                                        </div>
                                        
                                        <div class="feature-card secondary">
                                            <div class="icon">üìä</div>
                                            <h3 style="color: #333;">Estad√≠sticas del Sistema</h3>
                                            <p style="color: #666;">Pr√≥ximamente: Dashboard con m√©tricas globales del sistema</p>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-box yellow">
                                        <p><strong>üí° Nota:</strong> Como Super Admin, no est√°s asociado a ninguna empresa espec√≠fica. Tu funci√≥n es gestionar el sistema completo y crear nuevas empresas.</p>
                                    </div>
                                </div>
                            `
                            return
                        }
                        
                        // Worker normal con empresa
                        userInfoContainer.innerHTML = `
                            <div class="user-text">
                                <div class="user-name">${workerProfile.nombre}</div>
                                <div class="user-details">${workerProfile.empresa.nombre} - ${workerProfile.puesto}</div>
                            </div>
                            <button onclick="logout()">Cerrar Sesi√≥n</button>
                        `
                        
                        authContent.innerHTML = `
                            <div class="welcome-card">
                                <h2>¬°Bienvenido al Sistema de Gesti√≥n!</h2>
                                <div class="info-box">
                                    <h3>Tu Informaci√≥n</h3>
                                    <p><strong>Nombre:</strong> ${workerProfile.nombre}</p>
                                    <p><strong>Email:</strong> ${user.email}</p>
                                    <p><strong>Empresa:</strong> ${workerProfile.empresa.nombre}</p>
                                    <p><strong>Puesto:</strong> ${workerProfile.puesto}</p>
                                </div>
                                
                                <h3>Funcionalidades disponibles:</h3>
                                <div class="mini-feature-grid">
                                    <div class="mini-feature-card feature-card success">
                                        <h4>üè¢ Gesti√≥n de Clientes</h4>
                                        <p>Administra clientes y sus plantas/ubicaciones</p>
                                        <a href="clientes.html">‚Üí Ir a Clientes</a>
                                    </div>
                                    <div class="mini-feature-card feature-card warning" onclick="window.location.href='controles.html'">
                                        <h4>üêõ Controles de Plagas</h4>
                                        <p>Registra y seguimiento de controles</p>
                                        <a href="controles.html">‚Üí Gestionar Controles</a>
                                    </div>
                                    <div class="mini-feature-card feature-card pink" onclick="window.location.href='productos.html'">
                                        <h4>üì¶ Productos</h4>
                                        <p>Gesti√≥n de inventario y productos</p>
                                        <a href="productos.html">‚Üí Gestionar Inventario</a>
                                    </div>
                                    ${workerProfile.rol === 'admin' || workerProfile.rol === 'supervisor' ? `
                                    <div class="mini-feature-card feature-card purple">
                                        <h4>üë• Gesti√≥n de Usuarios</h4>
                                        <p>Invitar nuevos trabajadores</p>
                                        <a href="admin-invitaciones.html">‚Üí Gestionar Invitaciones</a>
                                    </div>
                                    <div class="mini-feature-card feature-card info">
                                        <h4>üè¢ Informaci√≥n de Empresa</h4>
                                        <p>Logo, sellos y certificados</p>
                                        <a href="empresa-info.html">‚Üí Gestionar Documentos</a>
                                    </div>
                                    ` : ''}
                                    ${workerProfile.is_super_admin ? `
                                    <div class="mini-feature-card feature-card super-admin">
                                        <h4>üëë Super Admin Panel</h4>
                                        <p>Gesti√≥n central de todas las empresas</p>
                                        <a href="super-admin.html">‚Üí Acceder al Panel</a>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="alert-box yellow">
                                    <p><strong>üí° Nota:</strong> Todas las funcionalidades est√°n limitadas a los datos de tu empresa (${workerProfile.empresa.nombre})</p>
                                </div>
                            </div>
                        `
                    } else {
                        authContent.innerHTML = `
                            <div class="welcome-card">
                                <h2>¬°Bienvenido al Sistema de Gesti√≥n!</h2>
                                <p>Has iniciado sesi√≥n exitosamente como: <strong>${user.email}</strong></p>
                                <div class="alert-box warning">
                                    <p><strong>‚ö†Ô∏è Configuraci√≥n Pendiente:</strong> No se encontr√≥ tu perfil de trabajador. Por favor contacta al administrador para completar la configuraci√≥n de tu cuenta.</p>
                                </div>
                            </div>
                        `
                    }
                } catch (error) {
                    console.error('Error cargando perfil para dashboard:', error)
                    authContent.innerHTML = `
                        <div class="welcome-card">
                            <h2>¬°Bienvenido al Sistema de Gesti√≥n!</h2>
                            <p>Has iniciado sesi√≥n exitosamente como: <strong>${user.email}</strong></p>
                            <div class="alert-box danger">
                                <p><strong>‚ö†Ô∏è Error:</strong> Hubo un problema cargando tu informaci√≥n. Por favor intenta recargar la p√°gina.</p>
                            </div>
                        </div>
                    `
                }
            } else {
                // Usuario no autenticado
                userInfoContainer.innerHTML = `
                    <div>No autenticado</div>
                `
                
                authContent.innerHTML = `
                    <div class="login-prompt">
                        <h2>Acceso Requerido</h2>
                        <p>Para acceder al sistema de gesti√≥n, necesitas iniciar sesi√≥n o crear una cuenta.</p>
                        
                        <div style="margin-top: 2rem;">
                            <a href="login.html">Iniciar Sesi√≥n</a>
                            <a href="info-invitaciones.html">Informaci√≥n sobre Registro</a>
                        </div>
                    </div>
                `
            }
        })
    </script>
</body>
</html>