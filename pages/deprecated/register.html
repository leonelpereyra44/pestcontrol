<!DOC  <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro - Sistema de Control de Plagas</title>
  <!-- Sistema de componentes -->
  <link rel="stylesheet" href="../css/main.css">
</head>
<body class="auth-page">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Creando cuenta...</p>
    </div>
  </div>

  <div class="auth-wrapper">
    <div class="form-container">
      <div class="card">
        <div class="card-body">
          <h2 class="login-title">üìù Crear Cuenta</h2>
          
          <div id="message" style="display: none;"></div>
          
          <form onsubmit="signUp(); return false;">
            <div class="form-group">
              <label for="fullName">Nombre completo</label>
              <input type="text" id="fullName" class="form-control" placeholder="Juan P√©rez" required />
            </div>
            
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" class="form-control" placeholder="correo@ejemplo.com" required />
            </div>
            
            <div class="form-group">
              <label for="empresa">C√≥digo de empresa</label>
              <select id="empresa" class="form-control" required>
                <option value="">Selecciona el c√≥digo de tu empresa...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="puesto">Puesto de trabajo</label>
              <input type="text" id="puesto" class="form-control" placeholder="T√©cnico, Supervisor, etc." required />
            </div>
            
            <div class="form-group">
              <label for="password">Contrase√±a</label>
              <input type="password" id="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
              <small class="form-text">La contrase√±a debe tener al menos 6 caracteres</small>
            </div>
            
            <div class="form-group">
              <label for="confirmPassword">Confirmar contrase√±a</label>
              <input type="password" id="confirmPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg btn-block" id="registerBtn">
              Crear Cuenta
            </button>
          </form>
          
          <div class="link" style="margin-top: 1.5rem; text-align: center;">
            <p>¬øYa tienes cuenta? <a href="login.html" class="btn btn-ghost btn-sm">Inicia sesi√≥n aqu√≠</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase

    const SUPABASE_URL = "https://rrgxvwttarkcxqfekfeb.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZ3h2d3R0YXJrY3hxZmVrZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTE1MjUsImV4cCI6MjA3NDkyNzUyNX0.xYEQV8ZkW9h99psdqTU2XpGicDGHs7q6M8V7lq35ryQ"

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message')
      messageDiv.textContent = message
      messageDiv.className = type === 'error' ? 'alert alert-danger' : 'alert alert-success'
      messageDiv.style.display = 'block'
      
      // Ocultar mensaje despu√©s de 5 segundos
      setTimeout(() => {
        messageDiv.style.display = 'none'
      }, 5000)
    }

    function validatePassword(password) {
      if (password.length < 6) {
        return "La contrase√±a debe tener al menos 6 caracteres"
      }
      return null
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!emailRegex.test(email)) {
        return "Por favor ingresa un email v√°lido"
      }
      return null
    }

    async function signUp() {
      const fullName = document.getElementById("fullName").value.trim()
      const email = document.getElementById("email").value.trim()
      const empresaId = document.getElementById("empresa").value
      const puesto = document.getElementById("puesto").value.trim()
      const password = document.getElementById("password").value
      const confirmPassword = document.getElementById("confirmPassword").value
      const registerBtn = document.getElementById("registerBtn")

      // Validar campos vac√≠os
      if (!fullName || !email || !empresaId || !puesto || !password || !confirmPassword) {
        showMessage("Por favor completa todos los campos", "error")
        return
      }

      // Validar email
      const emailError = validateEmail(email)
      if (emailError) {
        showMessage(emailError, "error")
        return
      }

      // Validar contrase√±a
      const passwordError = validatePassword(password)
      if (passwordError) {
        showMessage(passwordError, "error")
        return
      }

      // Verificar que las contrase√±as coincidan
      if (password !== confirmPassword) {
        showMessage("Las contrase√±as no coinciden", "error")
        return
      }

      // Obtener informaci√≥n de la empresa seleccionada
      const empresaSelect = document.getElementById("empresa")
      const empresaOption = empresaSelect.options[empresaSelect.selectedIndex]
      const empresaNombre = empresaOption.textContent.split(' - ')[1] // Extraer nombre despu√©s del c√≥digo

      // Deshabilitar bot√≥n durante el registro
      registerBtn.disabled = true
      registerBtn.textContent = "Creando cuenta..."

      try {
        // Paso 1: Crear usuario en auth
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: fullName,
              empresa_id: empresaId,
              puesto: puesto
            }
          }
        })

        if (authError) {
          showMessage("Error creando usuario: " + authError.message, "error")
          return
        }

        // Paso 2: Crear registro en la tabla worker
        if (authData.user) {
          const { error: workerError } = await supabaseClient
            .from('worker')
            .insert({
              worker_id: authData.user.id, // Usar el UUID del usuario de auth
              empresa_id: empresaId,
              nombre: fullName,
              mail: email,
              puesto: puesto
            })

          if (workerError) {
            console.error('Error creando worker:', workerError)
            // El usuario ya se cre√≥ en auth, pero fall√≥ crear el worker
            showMessage("Usuario creado, pero hubo un problema con el perfil. Contacta al administrador.", "error")
            return
          }
        }

        showMessage(`¬°Cuenta creada exitosamente en ${empresaNombre}! Revisa tu email para confirmar tu cuenta.`, "success")
        
        // Limpiar formulario
        document.getElementById("fullName").value = ""
        document.getElementById("email").value = ""
        document.getElementById("empresa").value = ""
        document.getElementById("puesto").value = ""
        document.getElementById("password").value = ""
        document.getElementById("confirmPassword").value = ""
        
        // Redirigir a login despu√©s de un tiempo
        setTimeout(() => {
          window.location.href = "login.html"
        }, 3000)

      } catch (error) {
        showMessage("Error de conexi√≥n: " + error.message, "error")
        console.error('Error completo:', error)
      } finally {
        // Rehabilitar bot√≥n
        registerBtn.disabled = false
        registerBtn.textContent = "Crear Cuenta"
      }
    }

    // Permitir registro con Enter
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        signUp()
      }
    })

    // Cargar empresas disponibles (mostrando c√≥digos)
    async function loadEmpresas() {
      try {
        const { data: empresas, error } = await supabaseClient
          .from('empresa')
          .select('empresa_id, nombre, codigo')
          .order('codigo')

        if (error) {
          console.error('Error cargando empresas:', error)
          showMessage("Error cargando c√≥digos de empresa disponibles", "error")
          return
        }

        const empresaSelect = document.getElementById('empresa')
        empresaSelect.innerHTML = '<option value="">Selecciona el c√≥digo de tu empresa...</option>'
        
        empresas.forEach(empresa => {
          const option = document.createElement('option')
          option.value = empresa.empresa_id
          // Mostrar c√≥digo - nombre en el dropdown
          option.textContent = `${empresa.codigo} - ${empresa.nombre}`
          empresaSelect.appendChild(option)
        })
      } catch (error) {
        console.error('Error cargando empresas:', error)
        showMessage("Error de conexi√≥n al cargar c√≥digos de empresa", "error")
      }
    }

    // Verificar si el usuario ya est√° logueado
    window.addEventListener('load', async () => {
      const { data } = await supabaseClient.auth.getSession()
      if (data.session) {
        showMessage("Ya tienes una sesi√≥n activa", "success")
        setTimeout(() => {
          window.location.href = "../index.html"
        }, 2000)
        return
      }
      
      // Mostrar mensaje de registro por invitaci√≥n
      showMessage("El registro ahora es solo por invitaci√≥n. Contacta a tu administrador.", "warning")
      
      // Deshabilitar formulario
      const form = document.querySelector('form') || document.querySelector('.card-body')
      form.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üîê</div>
          <h3 class="empty-state-title">Registro por Invitaci√≥n √önicamente</h3>
          <p class="empty-state-message">
            Para mantener la seguridad del sistema, el registro ahora es solo por invitaci√≥n.
          </p>
          <div class="alert alert-info">
            <p><strong>Si tienes una invitaci√≥n:</strong> Usa el link que recibiste por email</p>
            <p><strong>Si necesitas acceso:</strong> Contacta al administrador de tu empresa</p>
          </div>
          <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
            <a href="login.html" class="btn btn-success">Ir al Login</a>
            <a href="../index.html" class="btn btn-secondary">Volver al Inicio</a>
          </div>
        </div>
      `
    })

    // Validaci√≥n en tiempo real de contrase√±as
    document.getElementById('confirmPassword')?.addEventListener('input', function() {
      const password = document.getElementById('password').value
      const confirmPassword = this.value
      
      if (confirmPassword && password !== confirmPassword) {
        this.classList.add('is-invalid')
      } else {
        this.classList.remove('is-invalid')
      }
    })
  </script>
</body>
</html>
