<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Gesti√≥n de Empresas</title>
    <link rel="stylesheet" href="../css/super-admin.css">
</head>
<body>
    <div class="page-wrapper">
    <div class="container">
        <!-- Header -->
        <header class="page-header">
            <div class="header-content">
                <h1 class="header-title">üëë Panel de Super Administrador</h1>
                <p class="header-subtitle">Gesti√≥n central de empresas del sistema</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="abrirModalNuevaEmpresa()">
                    ‚ûï Nueva Empresa
                </button>
                <a href="../index.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </header>

        <!-- Estad√≠sticas -->
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-content">
                    <h3 class="stat-label">Total Empresas</h3>
                    <div class="stat-value" id="statTotalEmpresas">-</div>
                </div>
            </div>
            
            <div class="stat-card stat-card-info">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <h3 class="stat-label">Total Usuarios</h3>
                    <div class="stat-value" id="statTotalUsuarios">-</div>
                </div>
            </div>
            
            <div class="stat-card stat-card-success">
                <div class="stat-icon">üè≠</div>
                <div class="stat-content">
                    <h3 class="stat-label">Total Clientes</h3>
                    <div class="stat-value" id="statTotalClientes">-</div>
                </div>
            </div>

            <div class="stat-card stat-card-warning">
                <div class="stat-icon">üìç</div>
                <div class="stat-content">
                    <h3 class="stat-label">Total Plantas</h3>
                    <div class="stat-value" id="statTotalPlantas">-</div>
                </div>
            </div>
        </div>

        <!-- B√∫squeda -->
        <div class="card">
            <div class="card-body">
                <div class="form-group" style="margin: 0;">
                    <label for="searchInput">üîç Buscar empresa</label>
                    <input 
                        type="text" 
                        id="searchInput"
                        class="form-control"
                        placeholder="Buscar por nombre o email..."
                        oninput="filtrarEmpresas()"
                    >
                </div>
            </div>
        </div>

        <!-- Tabla de Empresas -->
        <div class="table-container">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>EMPRESA</th>
                        <th class="text-center">TRABAJADORES</th>
                        <th class="text-center">CLIENTES</th>
                        <th class="text-center">PLANTAS</th>
                        <th class="text-center">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="empresasTableBody">
                    <tr>
                        <td colspan="5">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <p>Cargando empresas...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <!-- Modal para Nueva Empresa -->
    <div id="modalNuevaEmpresa" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Crear Nueva Empresa</h2>
                <button class="modal-close" onclick="cerrarModalNuevaEmpresa()">‚úï</button>
            </div>
            
            <form id="formNuevaEmpresa" onsubmit="crearEmpresa(event)">
                <div class="modal-body">
                    <h3 class="section-header">üìã Datos de la Empresa</h3>
                    
                    <div class="form-group">
                        <label for="inputEmpresaNombre">Nombre de la Empresa *</label>
                        <input 
                            type="text" 
                            id="inputEmpresaNombre" 
                            class="form-control" 
                            required
                            placeholder="Ej: Fumigaciones ABC S.A."
                        >
                    </div>

                    <h3 class="section-header section-header-spacing">üë§ Primer Administrador</h3>
                    
                    <div class="form-group">
                        <label for="inputAdminNombre">Nombre Completo *</label>
                        <input 
                            type="text" 
                            id="inputAdminNombre" 
                            class="form-control" 
                            required
                            placeholder="Juan P√©rez"
                        >
                    </div>

                    <div class="form-group">
                        <label for="inputAdminEmail">Email *</label>
                        <input 
                            type="email" 
                            id="inputAdminEmail" 
                            class="form-control" 
                            required
                            placeholder="juan.perez@empresa.com"
                        >
                        <small>Se generar√° un link de invitaci√≥n para este email</small>
                    </div>

                    <div class="form-group">
                        <label for="inputAdminPuesto">Puesto</label>
                        <input 
                            type="text" 
                            id="inputAdminPuesto" 
                            class="form-control"
                            placeholder="Gerente General"
                        >
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalNuevaEmpresa()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="btnCrearText">Crear Empresa y Generar Invitaci√≥n</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Link de Invitaci√≥n -->
    <div id="modalInvitacion" class="modal-overlay">
        <div class="modal-content modal-success">
            <div class="modal-header">
                <h2>‚úÖ Empresa Creada Exitosamente</h2>
                <button class="modal-close" onclick="cerrarModalInvitacion()">‚úï</button>
            </div>
            
            <div class="modal-body modal-body-center">
                <div class="celebration-icon">üéâ</div>
                <h3>¬°La empresa ha sido registrada!</h3>
                
                <div class="alert alert-success">
                    <p><strong>Empresa:</strong> <span id="resultEmpresaNombre"></span></p>
                    <p><strong>Admin:</strong> <span id="resultAdminNombre"></span></p>
                    <p><strong>Email:</strong> <span id="resultAdminEmail"></span></p>
                </div>

                <div class="invitation-section">
                    <h4>üîó Link de Invitaci√≥n</h4>
                    <p class="invitation-description">Env√≠a este link al administrador para que complete su registro:</p>
                    <div class="form-group">
                        <textarea id="invitationLink" readonly class="form-control" style="height: 100px;"></textarea>
                        <small class="expiration-warning">‚è∞ Este link expira en 7 d√≠as</small>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-info" onclick="copiarLink()">
                    üìã Copiar Link
                </button>
                <button class="btn btn-primary" onclick="cerrarModalInvitacion()">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = "https://rrgxvwttarkcxqfekfeb.supabase.co"
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZ3h2d3R0YXJrY3hxZmVrZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTE1MjUsImV4cCI6MjA3NDkyNzUyNX0.xYEQV8ZkW9h99psdqTU2XpGicDGHs7q6M8V7lq35ryQ"
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // Variables globales
        let currentWorker = null
        let todasEmpresas = []

        // ========== INICIALIZACI√ìN ==========

        window.addEventListener('DOMContentLoaded', async () => {
            await verificarSuperAdmin()
            await cargarEmpresas()
            await cargarEstadisticas()
        })

        // ========== VERIFICAR SUPER ADMIN ==========

        async function verificarSuperAdmin() {
            const { data: session } = await supabaseClient.auth.getSession()
            
            if (!session.session) {
                alert('‚ùå Debes iniciar sesi√≥n')
                window.location.href = '../pages/login.html'
                return
            }

            const { data: worker, error } = await supabaseClient
                .from('worker')
                .select('*')
                .eq('user_id', session.session.user.id)
                .single()

            if (error || !worker) {
                console.error('Error cargando worker:', error)
                alert('‚ùå No se pudo cargar informaci√≥n del usuario')
                window.location.href = '../index.html'
                return
            }

            if (!worker.is_super_admin) {
                alert('‚ùå No tienes permisos de Super Admin')
                window.location.href = '../index.html'
                return
            }

            currentWorker = worker
            console.log('Super Admin verificado:', worker)
        }

        // ========== CARGAR EMPRESAS ==========

        async function cargarEmpresas() {
            try {
                const { data, error } = await supabaseClient
                    .from('super_admin_dashboard')
                    .select('*')

                if (error) throw error

                todasEmpresas = data || []
                renderizarEmpresas(todasEmpresas)

            } catch (error) {
                console.error('Error cargando empresas:', error)
                document.getElementById('empresasTableBody').innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ö†Ô∏è</div>
                                <h3 class="empty-state-title">Error al cargar empresas</h3>
                                <p class="empty-state-message">${error.message}</p>
                            </div>
                        </td>
                    </tr>
                `
            }
        }

        // ========== RENDERIZAR EMPRESAS ==========

        function renderizarEmpresas(empresas) {
            const tbody = document.getElementById('empresasTableBody')
            
            if (empresas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <h3 class="empty-state-title">No hay empresas registradas</h3>
                                <p class="empty-state-message">Comienza creando la primera empresa del sistema</p>
                                <button class="btn btn-primary" onclick="abrirModalNuevaEmpresa()">
                                    ‚ûï Crear Primera Empresa
                                </button>
                            </div>
                        </td>
                    </tr>
                `
                return
            }

            tbody.innerHTML = empresas.map(e => `
                <tr>
                    <td>
                        <div class="company-info">
                            <span class="company-name">${e.empresa_nombre}</span>
                        </div>
                    </td>
                    <td class="text-center"><span class="badge badge-info">${e.total_trabajadores || 0}</span></td>
                    <td class="text-center"><span class="badge badge-success">${e.total_clientes || 0}</span></td>
                    <td class="text-center"><span class="badge badge-warning">${e.total_plantas || 0}</span></td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button class="btn-icon-sm btn-view" onclick="verDetalles('${e.empresa_id}')" title="Ver detalles">
                                üëÅÔ∏è
                            </button>
                            <button class="btn-icon-sm btn-edit" onclick="editarEmpresa('${e.empresa_id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon-sm btn-view" onclick="verUsuarios('${e.empresa_id}')" title="Ver usuarios">
                                üë•
                            </button>
                            <button class="btn-icon-sm btn-delete" onclick="eliminarEmpresa('${e.empresa_id}', '${e.empresa_nombre}')" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('')
        }

        // ========== ESTAD√çSTICAS ==========

        async function cargarEstadisticas() {
            const totalEmpresas = todasEmpresas.length
            const totalUsuarios = todasEmpresas.reduce((sum, e) => sum + (e.total_trabajadores || 0), 0)
            const totalClientes = todasEmpresas.reduce((sum, e) => sum + (e.total_clientes || 0), 0)
            const totalPlantas = todasEmpresas.reduce((sum, e) => sum + (e.total_plantas || 0), 0)

            document.getElementById('statTotalEmpresas').textContent = totalEmpresas
            document.getElementById('statTotalUsuarios').textContent = totalUsuarios
            document.getElementById('statTotalClientes').textContent = totalClientes
            document.getElementById('statTotalPlantas').textContent = totalPlantas
        }

        // ========== FILTRAR EMPRESAS ==========

        function filtrarEmpresas() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase()
            
            const empresasFiltradas = todasEmpresas.filter(e => {
                return e.empresa_nombre.toLowerCase().includes(searchTerm) ||
                       (e.admins_email && e.admins_email.toLowerCase().includes(searchTerm))
            })

            renderizarEmpresas(empresasFiltradas)
        }

        // ========== MODAL NUEVA EMPRESA ==========

        function abrirModalNuevaEmpresa() {
            document.getElementById('formNuevaEmpresa').reset()
            document.getElementById('modalNuevaEmpresa').classList.add('active')
            document.body.classList.add('modal-open')
        }

        function cerrarModalNuevaEmpresa() {
            document.getElementById('modalNuevaEmpresa').classList.remove('active')
            document.body.classList.remove('modal-open')
        }

        // ========== CREAR EMPRESA ==========

        async function crearEmpresa(event) {
            event.preventDefault()

            const empresaData = {
                nombre: document.getElementById('inputEmpresaNombre').value.trim()
            }

            const adminData = {
                nombre: document.getElementById('inputAdminNombre').value.trim(),
                email: document.getElementById('inputAdminEmail').value.trim(),
                puesto: document.getElementById('inputAdminPuesto').value.trim() || 'Administrador'
            }

            document.getElementById('btnCrearText').textContent = 'Creando...'

            try {
                // 1. Crear empresa
                const { data: empresa, error: empresaError } = await supabaseClient
                    .from('empresa')
                    .insert(empresaData)
                    .select()
                    .single()

                if (empresaError) throw empresaError

                console.log('Empresa creada:', empresa)

                // 2. Generar token de invitaci√≥n
                const token = 'INV-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
                
                const { data: invitacion, error: invError } = await supabaseClient
                    .from('invitaciones')
                    .insert({
                        empresa_id: empresa.empresa_id,
                        email: adminData.email,
                        puesto_sugerido: adminData.puesto,
                        invitado_por: currentWorker.worker_id,
                        token: token,
                        fecha_invitacion: new Date().toISOString(),
                        fecha_expiracion: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        usado: false
                    })
                    .select()
                    .single()

                if (invError) throw invError

                console.log('Invitaci√≥n creada:', invitacion)

                // 3. Mostrar resultado
                const invitationUrl = `${window.location.origin}/pages/registro-invitacion.html?token=${token}`
                
                document.getElementById('resultEmpresaNombre').textContent = empresa.nombre
                document.getElementById('resultAdminNombre').textContent = adminData.nombre
                document.getElementById('resultAdminEmail').textContent = adminData.email
                document.getElementById('invitationLink').value = invitationUrl

                cerrarModalNuevaEmpresa()
                document.getElementById('modalInvitacion').classList.add('active')
                document.body.classList.add('modal-open')

                await cargarEmpresas()
                await cargarEstadisticas()

            } catch (error) {
                console.error('Error creando empresa:', error)
                alert('‚ùå Error: ' + (error.message || JSON.stringify(error)))
            } finally {
                document.getElementById('btnCrearText').textContent = 'Crear Empresa y Generar Invitaci√≥n'
            }
        }

        // ========== COPIAR LINK ==========

        function copiarLink() {
            const linkInput = document.getElementById('invitationLink')
            linkInput.select()
            document.execCommand('copy')
            
            const btn = event.target
            const originalText = btn.textContent
            btn.textContent = '‚úÖ Copiado!'
            setTimeout(() => {
                btn.textContent = originalText
            }, 2000)
        }

        function cerrarModalInvitacion() {
            document.getElementById('modalInvitacion').classList.remove('active')
            document.body.classList.remove('modal-open')
        }

        // ========== ACCIONES DE EMPRESA ==========

        async function verDetalles(empresaId) {
            try {
                const empresa = todasEmpresas.find(e => e.empresa_id === empresaId)
                
                if (!empresa) {
                    alert('‚ùå Empresa no encontrada')
                    return
                }

                // Abrir modal con detalles
                const modalHTML = `
                    <div id="modalDetalles" class="modal-overlay active">
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="modal-header">
                                <h2>üè¢ Detalles de ${empresa.empresa_nombre}</h2>
                                <button class="modal-close" onclick="cerrarModalDetalles()">‚úï</button>
                            </div>
                            
                            <div class="modal-body">
                                <div class="details-grid">
                                    <div class="stat-card stat-card-info">
                                        <div class="stat-icon">üë•</div>
                                        <div class="stat-content">
                                            <h3 class="stat-label">Trabajadores</h3>
                                            <div class="stat-value">${empresa.total_trabajadores || 0}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card stat-card-success">
                                        <div class="stat-icon">üè≠</div>
                                        <div class="stat-content">
                                            <h3 class="stat-label">Clientes</h3>
                                            <div class="stat-value">${empresa.total_clientes || 0}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card stat-card-warning">
                                        <div class="stat-icon">üìç</div>
                                        <div class="stat-content">
                                            <h3 class="stat-label">Plantas</h3>
                                            <div class="stat-value">${empresa.total_plantas || 0}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon">‚úâÔ∏è</div>
                                        <div class="stat-content">
                                            <h3 class="stat-label">Administradores</h3>
                                            <div class="admin-emails">
                                                ${empresa.admins_email || 'Sin admins'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-box">
                                    <h3 class="section-header">Informaci√≥n de la Empresa</h3>
                                    <div class="info-row">
                                        <span class="info-label">ID:</span>
                                        <span class="info-value">${empresa.empresa_id}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Nombre:</span>
                                        <span class="info-value">${empresa.empresa_nombre}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-secondary" onclick="cerrarModalDetalles()">
                                    Cerrar
                                </button>
                                <button class="btn btn-primary" onclick="cerrarModalDetalles(); editarEmpresa('${empresaId}')">
                                    ‚úèÔ∏è Editar Empresa
                                </button>
                                <button class="btn btn-info" onclick="cerrarModalDetalles(); verUsuarios('${empresaId}')">
                                    üë• Ver Usuarios
                                </button>
                            </div>
                        </div>
                    </div>
                `
                
                document.body.insertAdjacentHTML('beforeend', modalHTML)
                
            } catch (error) {
                console.error('Error mostrando detalles:', error)
                alert('‚ùå Error al cargar detalles de la empresa')
            }
        }

        function cerrarModalDetalles() {
            const modal = document.getElementById('modalDetalles')
            if (modal) {
                modal.remove()
            }
        }

        async function editarEmpresa(empresaId) {
            try {
                const empresa = todasEmpresas.find(e => e.empresa_id === empresaId)
                
                if (!empresa) {
                    alert('‚ùå Empresa no encontrada')
                    return
                }

                // Abrir modal para editar
                const modalHTML = `
                    <div id="modalEditar" class="modal-overlay active">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>‚úèÔ∏è Editar Empresa</h2>
                                <button class="btn-close" onclick="cerrarModalDinamico('modalEditar')">‚úï</button>
                            </div>
                            
                            <form id="formEditarEmpresa" onsubmit="guardarEmpresa(event, '${empresaId}')">
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="editNombre">Nombre de la Empresa *</label>
                                        <input 
                                            type="text" 
                                            id="editNombre" 
                                            class="form-control" 
                                            required
                                            value="${empresa.empresa_nombre}"
                                        >
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="cerrarModalDinamico('modalEditar')">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <span id="btnGuardarText">üíæ Guardar Cambios</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `
                
                document.body.insertAdjacentHTML('beforeend', modalHTML)
                document.body.classList.add('modal-open')
                
            } catch (error) {
                console.error('Error abriendo editor:', error)
                alert('‚ùå Error al abrir editor de empresa')
            }
        }

        async function guardarEmpresa(event, empresaId) {
            event.preventDefault()
            
            const nuevoNombre = document.getElementById('editNombre').value.trim()
            document.getElementById('btnGuardarText').textContent = 'Guardando...'

            try {
                const { error } = await supabaseClient
                    .from('empresa')
                    .update({ nombre: nuevoNombre })
                    .eq('empresa_id', empresaId)

                if (error) throw error

                alert('‚úÖ Empresa actualizada correctamente')
                cerrarModalDinamico('modalEditar')
                
                await cargarEmpresas()
                await cargarEstadisticas()

            } catch (error) {
                console.error('Error guardando empresa:', error)
                alert('‚ùå Error: ' + (error.message || JSON.stringify(error)))
                document.getElementById('btnGuardarText').textContent = 'üíæ Guardar Cambios'
            }
        }

        async function verUsuarios(empresaId) {
            try {
                const empresa = todasEmpresas.find(e => e.empresa_id === empresaId)
                
                if (!empresa) {
                    alert('‚ùå Empresa no encontrada')
                    return
                }

                // Cargar workers de la empresa
                const { data: workers, error } = await supabaseClient
                    .from('worker')
                    .select('*')
                    .eq('empresa_id', empresaId)
                    .order('nombre')

                if (error) throw error

                // Abrir modal con lista de usuarios
                const workersHTML = workers && workers.length > 0 
                    ? workers.map(w => `
                        <tr>
                            <td><strong>${w.nombre}</strong></td>
                            <td>${w.mail}</td>
                            <td>${w.puesto || '-'}</td>
                            <td>
                                <span class="badge ${
                                    w.rol === 'admin' ? 'badge-danger' : 
                                    w.rol === 'supervisor' ? 'badge-warning' : 
                                    'badge-info'
                                }">${w.rol}</span>
                            </td>
                            <td>
                                ${w.is_super_admin ? '<span class="badge" style="background: #9b59b6; color: white;">ÔøΩ Super Admin</span>' : ''}
                            </td>
                        </tr>
                    `).join('')
                    : `<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">üë§</div><h3 class="empty-state-title">No hay usuarios registrados</h3></div></td></tr>`

                const modalHTML = `
                    <div id="modalUsuarios" class="modal-overlay active">
                        <div class="modal-content modal-lg">
                            <div class="modal-header">
                                <h2>üë• Usuarios de ${empresa.empresa_nombre}</h2>
                                <button class="btn-close" onclick="cerrarModalDinamico('modalUsuarios')">‚úï</button>
                            </div>
                            
                            <div class="modal-body">
                                <div class="alert alert-info" style="margin-bottom: var(--spacing-xl);">
                                    <p style="margin: 0;"><strong>Total de usuarios:</strong> ${workers ? workers.length : 0}</p>
                                </div>

                                <div class="table-container">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>NOMBRE</th>
                                                <th>EMAIL</th>
                                                <th>PUESTO</th>
                                                <th class="text-center">ROL</th>
                                                <th class="text-center">EXTRAS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${workersHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="cerrarModalDinamico('modalUsuarios')">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                `
                
                document.body.insertAdjacentHTML('beforeend', modalHTML)
                document.body.classList.add('modal-open')
                
            } catch (error) {
                console.error('Error cargando usuarios:', error)
                alert('‚ùå Error al cargar usuarios de la empresa')
            }
        }

        async function eliminarEmpresa(empresaId, empresaNombre) {
            const confirmacion = confirm(
                `‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar la empresa "${empresaNombre}"?\n\n` +
                `Esta acci√≥n eliminar√°:\n` +
                `‚Ä¢ Todos los trabajadores\n` +
                `‚Ä¢ Todos los clientes\n` +
                `‚Ä¢ Todas las plantas\n` +
                `‚Ä¢ Todos los productos\n` +
                `‚Ä¢ Todas las invitaciones\n\n` +
                `‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER`
            )

            if (!confirmacion) return

            const confirmacion2 = confirm(
                `‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n` +
                `Vas a ELIMINAR PERMANENTEMENTE la empresa "${empresaNombre}".\n\n` +
                `¬øEst√°s ABSOLUTAMENTE seguro?`
            )

            if (!confirmacion2) return

            try {
                console.log('Iniciando eliminaci√≥n de empresa:', empresaId)

                // Eliminar en orden: tablas dependientes primero, luego la empresa
                
                // 1. Eliminar invitaciones
                const { error: errorInvitaciones } = await supabaseClient
                    .from('invitaciones')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorInvitaciones) {
                    console.warn('Error eliminando invitaciones:', errorInvitaciones)
                }

                // 2. Eliminar trabajadores
                const { error: errorWorkers } = await supabaseClient
                    .from('worker')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorWorkers) {
                    console.warn('Error eliminando trabajadores:', errorWorkers)
                }

                // 3. Eliminar plantas (si existe la tabla)
                const { error: errorPlantas } = await supabaseClient
                    .from('plantas')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorPlantas) {
                    console.warn('Error eliminando plantas:', errorPlantas)
                }

                // 4. Eliminar clientes
                const { error: errorClientes } = await supabaseClient
                    .from('clientes')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorClientes) {
                    console.warn('Error eliminando clientes:', errorClientes)
                }

                // 5. Finalmente eliminar la empresa
                const { error: errorEmpresa } = await supabaseClient
                    .from('empresa')
                    .delete()
                    .eq('empresa_id', empresaId)

                if (errorEmpresa) {
                    console.error('Error eliminando empresa:', errorEmpresa)
                    throw errorEmpresa
                }

                console.log('‚úÖ Empresa eliminada correctamente')
                alert('‚úÖ Empresa eliminada correctamente')
                
                await cargarEmpresas()
                await cargarEstadisticas()

            } catch (error) {
                console.error('Error eliminando empresa:', error)
                alert('‚ùå Error: ' + (error.message || JSON.stringify(error)))
            }
        }

        // Cerrar modales din√°micos
        function cerrarModalDinamico(modalId) {
            const modal = document.getElementById(modalId)
            if (modal) {
                modal.remove()
                document.body.classList.remove('modal-open')
            }
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                if (event.target.id === 'modalNuevaEmpresa') {
                    cerrarModalNuevaEmpresa()
                } else if (event.target.id === 'modalInvitacion') {
                    cerrarModalInvitacion()
                } else if (event.target.id === 'modalDetalles') {
                    cerrarModalDetalles()
                } else if (event.target.id === 'modalEditar' || event.target.id === 'modalUsuarios') {
                    cerrarModalDinamico(event.target.id)
                }
            }
        }
    </script>
</body>
</html>
</html>