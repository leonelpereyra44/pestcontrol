<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Gesti√≥n de Empresas</title>
    <link rel="stylesheet" href="../css/super-admin.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üëë Panel de Super Administrador</h1>
                <p class="subtitle">Gesti√≥n central de empresas del sistema</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="abrirModalNuevaEmpresa()">
                    ‚ûï Nueva Empresa
                </button>
                <a href="../index.html" class="btn btn-back">‚Üê Dashboard</a>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-content">
                    <h3>Total Empresas</h3>
                    <div class="stat-value" id="statTotalEmpresas">-</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <h3>Total Usuarios</h3>
                    <div class="stat-value" id="statTotalUsuarios">-</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üè≠</div>
                <div class="stat-content">
                    <h3>Total Clientes</h3>
                    <div class="stat-value" id="statTotalClientes">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìç</div>
                <div class="stat-content">
                    <h3>Total Plantas</h3>
                    <div class="stat-value" id="statTotalPlantas">-</div>
                </div>
            </div>
        </div>

        <!-- B√∫squeda -->
        <div class="search-bar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Buscar empresa por nombre o email..."
                    oninput="filtrarEmpresas()"
                >
            </div>
        </div>

        <!-- Tabla de Empresas -->
        <div class="table-container">
            <table class="empresas-table">
                <thead>
                    <tr>
                        <th>EMPRESA</th>
                        <th>TRABAJADORES</th>
                        <th>CLIENTES</th>
                        <th>PLANTAS</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="empresasTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div class="loading-spinner"></div>
                            <p>Cargando empresas...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para Nueva Empresa -->
    <div id="modalNuevaEmpresa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Crear Nueva Empresa</h2>
                <button class="btn-close" onclick="cerrarModalNuevaEmpresa()">‚úï</button>
            </div>
            
            <form id="formNuevaEmpresa" onsubmit="crearEmpresa(event)">
                <div class="form-section">
                    <h3>üìã Datos de la Empresa</h3>
                    <div class="form-grid">
                        <div class="form-group form-group-full">
                            <label for="inputEmpresaNombre">Nombre de la Empresa *</label>
                            <input 
                                type="text" 
                                id="inputEmpresaNombre" 
                                class="form-control" 
                                required
                                placeholder="Ej: Fumigaciones ABC S.A."
                            >
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üë§ Primer Administrador</h3>
                    <div class="form-grid">
                        <div class="form-group form-group-full">
                            <label for="inputAdminNombre">Nombre Completo *</label>
                            <input 
                                type="text" 
                                id="inputAdminNombre" 
                                class="form-control" 
                                required
                                placeholder="Juan P√©rez"
                            >
                        </div>

                        <div class="form-group form-group-full">
                            <label for="inputAdminEmail">Email *</label>
                            <input 
                                type="email" 
                                id="inputAdminEmail" 
                                class="form-control" 
                                required
                                placeholder="juan.perez@empresa.com"
                            >
                            <small>Se generar√° un link de invitaci√≥n para este email</small>
                        </div>

                        <div class="form-group">
                            <label for="inputAdminPuesto">Puesto</label>
                            <input 
                                type="text" 
                                id="inputAdminPuesto" 
                                class="form-control"
                                placeholder="Gerente General"
                            >
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalNuevaEmpresa()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="btnCrearText">Crear Empresa y Generar Invitaci√≥n</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Link de Invitaci√≥n -->
    <div id="modalInvitacion" class="modal">
        <div class="modal-content modal-success">
            <div class="modal-header">
                <h2>‚úÖ Empresa Creada Exitosamente</h2>
                <button class="btn-close" onclick="cerrarModalInvitacion()">‚úï</button>
            </div>
            
            <div class="invitation-result">
                <div class="success-icon">üéâ</div>
                <h3>¬°La empresa ha sido registrada!</h3>
                
                <div class="empresa-info">
                    <p><strong>Empresa:</strong> <span id="resultEmpresaNombre"></span></p>
                    <p><strong>Admin:</strong> <span id="resultAdminNombre"></span></p>
                    <p><strong>Email:</strong> <span id="resultAdminEmail"></span></p>
                </div>

                <div class="invitation-section">
                    <h4>üîó Link de Invitaci√≥n</h4>
                    <p>Env√≠a este link al administrador para que complete su registro:</p>
                    <div class="link-box">
                        <input type="text" id="invitationLink" readonly class="link-input">
                        <button class="btn btn-copy" onclick="copiarLink()">üìã Copiar</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="cerrarModalInvitacion()">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = "https://rrgxvwttarkcxqfekfeb.supabase.co"
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZ3h2d3R0YXJrY3hxZmVrZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTE1MjUsImV4cCI6MjA3NDkyNzUyNX0.xYEQV8ZkW9h99psdqTU2XpGicDGHs7q6M8V7lq35ryQ"
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // Variables globales
        let currentWorker = null
        let todasEmpresas = []

        // ========== INICIALIZACI√ìN ==========

        window.addEventListener('DOMContentLoaded', async () => {
            await verificarSuperAdmin()
            await cargarEmpresas()
            await cargarEstadisticas()
        })

        // ========== VERIFICAR SUPER ADMIN ==========

        async function verificarSuperAdmin() {
            const { data: session } = await supabaseClient.auth.getSession()
            
            if (!session.session) {
                alert('‚ùå Debes iniciar sesi√≥n')
                window.location.href = '../pages/login.html'
                return
            }

            const { data: worker, error } = await supabaseClient
                .from('worker')
                .select('*')
                .eq('user_id', session.session.user.id)
                .single()

            if (error || !worker) {
                console.error('Error cargando worker:', error)
                alert('‚ùå No se pudo cargar informaci√≥n del usuario')
                window.location.href = '../index.html'
                return
            }

            if (!worker.is_super_admin) {
                alert('‚ùå No tienes permisos de Super Admin')
                window.location.href = '../index.html'
                return
            }

            currentWorker = worker
            console.log('Super Admin verificado:', worker)
        }

        // ========== CARGAR EMPRESAS ==========

        async function cargarEmpresas() {
            try {
                const { data, error } = await supabaseClient
                    .from('super_admin_dashboard')
                    .select('*')

                if (error) throw error

                todasEmpresas = data || []
                renderizarEmpresas(todasEmpresas)

            } catch (error) {
                console.error('Error cargando empresas:', error)
                document.getElementById('empresasTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #e74c3c; padding: 40px;">
                            ‚ùå Error cargando empresas: ${error.message}
                        </td>
                    </tr>
                `
            }
        }

        // ========== RENDERIZAR EMPRESAS ==========

        function renderizarEmpresas(empresas) {
            const tbody = document.getElementById('empresasTableBody')
            
            if (empresas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            No hay empresas registradas
                        </td>
                    </tr>
                `
                return
            }

            tbody.innerHTML = empresas.map(e => `
                <tr>
                    <td>
                        <strong>${e.empresa_nombre}</strong>
                    </td>
                    <td><span class="badge badge-info">${e.total_trabajadores || 0}</span></td>
                    <td><span class="badge badge-success">${e.total_clientes || 0}</span></td>
                    <td><span class="badge badge-warning">${e.total_plantas || 0}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" onclick="verDetalles('${e.empresa_id}')" title="Ver detalles">
                                üëÅÔ∏è
                            </button>
                            <button class="btn-icon btn-edit" onclick="editarEmpresa('${e.empresa_id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon btn-users" onclick="verUsuarios('${e.empresa_id}')" title="Ver usuarios">
                                üë•
                            </button>
                            <button class="btn-icon btn-delete" onclick="eliminarEmpresa('${e.empresa_id}', '${e.empresa_nombre}')" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('')
        }

        // ========== ESTAD√çSTICAS ==========

        async function cargarEstadisticas() {
            const totalEmpresas = todasEmpresas.length
            const totalUsuarios = todasEmpresas.reduce((sum, e) => sum + (e.total_trabajadores || 0), 0)
            const totalClientes = todasEmpresas.reduce((sum, e) => sum + (e.total_clientes || 0), 0)
            const totalPlantas = todasEmpresas.reduce((sum, e) => sum + (e.total_plantas || 0), 0)

            document.getElementById('statTotalEmpresas').textContent = totalEmpresas
            document.getElementById('statTotalUsuarios').textContent = totalUsuarios
            document.getElementById('statTotalClientes').textContent = totalClientes
            document.getElementById('statTotalPlantas').textContent = totalPlantas
        }

        // ========== FILTRAR EMPRESAS ==========

        function filtrarEmpresas() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase()
            
            const empresasFiltradas = todasEmpresas.filter(e => {
                return e.empresa_nombre.toLowerCase().includes(searchTerm) ||
                       (e.admins_email && e.admins_email.toLowerCase().includes(searchTerm))
            })

            renderizarEmpresas(empresasFiltradas)
        }

        // ========== MODAL NUEVA EMPRESA ==========

        function abrirModalNuevaEmpresa() {
            document.getElementById('formNuevaEmpresa').reset()
            document.getElementById('modalNuevaEmpresa').style.display = 'flex'
        }

        function cerrarModalNuevaEmpresa() {
            document.getElementById('modalNuevaEmpresa').style.display = 'none'
        }

        // ========== CREAR EMPRESA ==========

        async function crearEmpresa(event) {
            event.preventDefault()

            const empresaData = {
                nombre: document.getElementById('inputEmpresaNombre').value.trim()
            }

            const adminData = {
                nombre: document.getElementById('inputAdminNombre').value.trim(),
                email: document.getElementById('inputAdminEmail').value.trim(),
                puesto: document.getElementById('inputAdminPuesto').value.trim() || 'Administrador'
            }

            document.getElementById('btnCrearText').textContent = 'Creando...'

            try {
                // 1. Crear empresa
                const { data: empresa, error: empresaError } = await supabaseClient
                    .from('empresa')
                    .insert(empresaData)
                    .select()
                    .single()

                if (empresaError) throw empresaError

                console.log('Empresa creada:', empresa)

                // 2. Generar token de invitaci√≥n
                const token = 'INV-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
                
                const { data: invitacion, error: invError } = await supabaseClient
                    .from('invitaciones')
                    .insert({
                        empresa_id: empresa.empresa_id,
                        email: adminData.email,
                        puesto_sugerido: adminData.puesto,
                        invitado_por: currentWorker.worker_id,
                        token: token,
                        fecha_invitacion: new Date().toISOString(),
                        fecha_expiracion: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        usado: false
                    })
                    .select()
                    .single()

                if (invError) throw invError

                console.log('Invitaci√≥n creada:', invitacion)

                // 3. Mostrar resultado
                const invitationUrl = `${window.location.origin}/pages/registro-invitacion.html?token=${token}`
                
                document.getElementById('resultEmpresaNombre').textContent = empresa.nombre
                document.getElementById('resultAdminNombre').textContent = adminData.nombre
                document.getElementById('resultAdminEmail').textContent = adminData.email
                document.getElementById('invitationLink').value = invitationUrl

                cerrarModalNuevaEmpresa()
                document.getElementById('modalInvitacion').style.display = 'flex'

                await cargarEmpresas()
                await cargarEstadisticas()

            } catch (error) {
                console.error('Error creando empresa:', error)
                alert('‚ùå Error: ' + (error.message || JSON.stringify(error)))
            } finally {
                document.getElementById('btnCrearText').textContent = 'Crear Empresa y Generar Invitaci√≥n'
            }
        }

        // ========== COPIAR LINK ==========

        function copiarLink() {
            const linkInput = document.getElementById('invitationLink')
            linkInput.select()
            document.execCommand('copy')
            
            const btn = event.target
            const originalText = btn.textContent
            btn.textContent = '‚úÖ Copiado!'
            setTimeout(() => {
                btn.textContent = originalText
            }, 2000)
        }

        function cerrarModalInvitacion() {
            document.getElementById('modalInvitacion').style.display = 'none'
        }

        // ========== ACCIONES DE EMPRESA ==========

        async function verDetalles(empresaId) {
            try {
                const empresa = todasEmpresas.find(e => e.empresa_id === empresaId)
                
                if (!empresa) {
                    alert('‚ùå Empresa no encontrada')
                    return
                }

                // Abrir modal con detalles
                const modalHTML = `
                    <div id="modalDetalles" class="modal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>ÔøΩ Detalles de ${empresa.empresa_nombre}</h2>
                                <button class="btn-close" onclick="document.getElementById('modalDetalles').remove()">‚úï</button>
                            </div>
                            
                            <div style="padding: 30px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                                    <div class="stat-card">
                                        <div class="stat-icon" style="background: #3498db;">üë•</div>
                                        <div class="stat-content">
                                            <h3>Trabajadores</h3>
                                            <div class="stat-value">${empresa.total_trabajadores || 0}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon" style="background: #2ecc71;">üè≠</div>
                                        <div class="stat-content">
                                            <h3>Clientes</h3>
                                            <div class="stat-value">${empresa.total_clientes || 0}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon" style="background: #f39c12;">üìç</div>
                                        <div class="stat-content">
                                            <h3>Plantas</h3>
                                            <div class="stat-value">${empresa.total_plantas || 0}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon" style="background: #9b59b6;">‚úâÔ∏è</div>
                                        <div class="stat-content">
                                            <h3>Administradores</h3>
                                            <div class="stat-value" style="font-size: 0.8rem; word-break: break-all;">
                                                ${empresa.admins_email || 'Sin admins'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                    <h3 style="margin: 0 0 15px 0;">Informaci√≥n de la Empresa</h3>
                                    <p><strong>ID:</strong> ${empresa.empresa_id}</p>
                                    <p><strong>Nombre:</strong> ${empresa.empresa_nombre}</p>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="document.getElementById('modalDetalles').remove()">
                                    Cerrar
                                </button>
                                <button class="btn btn-primary" onclick="document.getElementById('modalDetalles').remove(); editarEmpresa('${empresaId}')">
                                    ‚úèÔ∏è Editar Empresa
                                </button>
                                <button class="btn btn-primary" onclick="document.getElementById('modalDetalles').remove(); verUsuarios('${empresaId}')">
                                    üë• Ver Usuarios
                                </button>
                            </div>
                        </div>
                    </div>
                `
                
                document.body.insertAdjacentHTML('beforeend', modalHTML)
                
            } catch (error) {
                console.error('Error mostrando detalles:', error)
                alert('‚ùå Error al cargar detalles de la empresa')
            }
        }

        async function editarEmpresa(empresaId) {
            try {
                const empresa = todasEmpresas.find(e => e.empresa_id === empresaId)
                
                if (!empresa) {
                    alert('‚ùå Empresa no encontrada')
                    return
                }

                // Abrir modal para editar
                const modalHTML = `
                    <div id="modalEditar" class="modal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>‚úèÔ∏è Editar Empresa</h2>
                                <button class="btn-close" onclick="document.getElementById('modalEditar').remove()">‚úï</button>
                            </div>
                            
                            <form id="formEditarEmpresa" onsubmit="guardarEmpresa(event, '${empresaId}')">
                                <div style="padding: 30px;">
                                    <div class="form-group">
                                        <label for="editNombre">Nombre de la Empresa *</label>
                                        <input 
                                            type="text" 
                                            id="editNombre" 
                                            class="form-control" 
                                            required
                                            value="${empresa.empresa_nombre}"
                                        >
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('modalEditar').remove()">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <span id="btnGuardarText">üíæ Guardar Cambios</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `
                
                document.body.insertAdjacentHTML('beforeend', modalHTML)
                
            } catch (error) {
                console.error('Error abriendo editor:', error)
                alert('‚ùå Error al abrir editor de empresa')
            }
        }

        async function guardarEmpresa(event, empresaId) {
            event.preventDefault()
            
            const nuevoNombre = document.getElementById('editNombre').value.trim()
            document.getElementById('btnGuardarText').textContent = 'Guardando...'

            try {
                const { error } = await supabaseClient
                    .from('empresa')
                    .update({ nombre: nuevoNombre })
                    .eq('empresa_id', empresaId)

                if (error) throw error

                alert('‚úÖ Empresa actualizada correctamente')
                document.getElementById('modalEditar').remove()
                
                await cargarEmpresas()
                await cargarEstadisticas()

            } catch (error) {
                console.error('Error guardando empresa:', error)
                alert('‚ùå Error: ' + (error.message || JSON.stringify(error)))
                document.getElementById('btnGuardarText').textContent = 'üíæ Guardar Cambios'
            }
        }

        async function verUsuarios(empresaId) {
            try {
                const empresa = todasEmpresas.find(e => e.empresa_id === empresaId)
                
                if (!empresa) {
                    alert('‚ùå Empresa no encontrada')
                    return
                }

                // Cargar workers de la empresa
                const { data: workers, error } = await supabaseClient
                    .from('worker')
                    .select('*')
                    .eq('empresa_id', empresaId)
                    .order('nombre')

                if (error) throw error

                // Abrir modal con lista de usuarios
                const workersHTML = workers && workers.length > 0 
                    ? workers.map(w => `
                        <tr>
                            <td><strong>${w.nombre}</strong></td>
                            <td>${w.mail}</td>
                            <td>${w.puesto || '-'}</td>
                            <td>
                                <span class="badge ${
                                    w.rol === 'admin' ? 'badge-danger' : 
                                    w.rol === 'supervisor' ? 'badge-warning' : 
                                    'badge-info'
                                }">${w.rol}</span>
                            </td>
                            <td>
                                ${w.is_super_admin ? '<span class="badge" style="background: #9b59b6; color: white;">ÔøΩ Super Admin</span>' : ''}
                            </td>
                        </tr>
                    `).join('')
                    : `<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No hay usuarios registrados</td></tr>`

                const modalHTML = `
                    <div id="modalUsuarios" class="modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 900px;">
                            <div class="modal-header">
                                <h2>üë• Usuarios de ${empresa.empresa_nombre}</h2>
                                <button class="btn-close" onclick="document.getElementById('modalUsuarios').remove()">‚úï</button>
                            </div>
                            
                            <div style="padding: 30px;">
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                    <p style="margin: 0;"><strong>Total de usuarios:</strong> ${workers ? workers.length : 0}</p>
                                </div>

                                <div style="overflow-x: auto;">
                                    <table class="empresas-table">
                                        <thead>
                                            <tr>
                                                <th>NOMBRE</th>
                                                <th>EMAIL</th>
                                                <th>PUESTO</th>
                                                <th>ROL</th>
                                                <th>EXTRAS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${workersHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="document.getElementById('modalUsuarios').remove()">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                `
                
                document.body.insertAdjacentHTML('beforeend', modalHTML)
                
            } catch (error) {
                console.error('Error cargando usuarios:', error)
                alert('‚ùå Error al cargar usuarios de la empresa')
            }
        }

        async function eliminarEmpresa(empresaId, empresaNombre) {
            const confirmacion = confirm(
                `‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar la empresa "${empresaNombre}"?\n\n` +
                `Esta acci√≥n eliminar√°:\n` +
                `‚Ä¢ Todos los trabajadores\n` +
                `‚Ä¢ Todos los clientes\n` +
                `‚Ä¢ Todas las plantas\n` +
                `‚Ä¢ Todos los productos\n` +
                `‚Ä¢ Todas las invitaciones\n\n` +
                `‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER`
            )

            if (!confirmacion) return

            const confirmacion2 = confirm(
                `‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n` +
                `Vas a ELIMINAR PERMANENTEMENTE la empresa "${empresaNombre}".\n\n` +
                `¬øEst√°s ABSOLUTAMENTE seguro?`
            )

            if (!confirmacion2) return

            try {
                console.log('Iniciando eliminaci√≥n de empresa:', empresaId)

                // Eliminar en orden: tablas dependientes primero, luego la empresa
                
                // 1. Eliminar invitaciones
                const { error: errorInvitaciones } = await supabaseClient
                    .from('invitaciones')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorInvitaciones) {
                    console.warn('Error eliminando invitaciones:', errorInvitaciones)
                }

                // 2. Eliminar trabajadores
                const { error: errorWorkers } = await supabaseClient
                    .from('worker')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorWorkers) {
                    console.warn('Error eliminando trabajadores:', errorWorkers)
                }

                // 3. Eliminar plantas (si existe la tabla)
                const { error: errorPlantas } = await supabaseClient
                    .from('plantas')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorPlantas) {
                    console.warn('Error eliminando plantas:', errorPlantas)
                }

                // 4. Eliminar clientes
                const { error: errorClientes } = await supabaseClient
                    .from('clientes')
                    .delete()
                    .eq('empresa_id', empresaId)
                
                if (errorClientes) {
                    console.warn('Error eliminando clientes:', errorClientes)
                }

                // 5. Finalmente eliminar la empresa
                const { error: errorEmpresa } = await supabaseClient
                    .from('empresa')
                    .delete()
                    .eq('empresa_id', empresaId)

                if (errorEmpresa) {
                    console.error('Error eliminando empresa:', errorEmpresa)
                    throw errorEmpresa
                }

                console.log('‚úÖ Empresa eliminada correctamente')
                alert('‚úÖ Empresa eliminada correctamente')
                
                await cargarEmpresas()
                await cargarEstadisticas()

            } catch (error) {
                console.error('Error eliminando empresa:', error)
                alert('‚ùå Error: ' + (error.message || JSON.stringify(error)))
            }
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none'
            }
        }
    </script>
</body>
</html>
