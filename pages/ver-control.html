<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Control - Sistema de Control de Plagas</title>
    <link rel="stylesheet" href="../css/ver-control.css">
    <!-- Bibliotecas para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="page-wrapper">
        <div class="container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-container">
                <div class="loading-spinner"></div>
                <p class="loading-text">Cargando informaci√≥n del control...</p>
            </div>

            <!-- Content (hidden initially) -->
            <div id="controlContent" style="display: none;">
                <!-- Header -->
                <div class="header">
                    <div class="header-title">
                        <h1 id="controlTitle">üìã Control de Plagas</h1>
                        <p class="header-subtitle" id="controlSubtitle"></p>
                    </div>
                    <div class="header-actions">
                        <a href="controles.html" class="btn btn-secondary">‚Üê Volver</a>
                        <button class="btn btn-primary" onclick="editarControl()">‚úèÔ∏è Editar</button>
                        <button class="btn btn-success" onclick="generarPDF()">üìÑ Generar PDF</button>
                        <button class="btn btn-danger" onclick="eliminarControl()">üóëÔ∏è Eliminar</button>
                    </div>
                </div>

                <!-- Informaci√≥n General -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìã Informaci√≥n General</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-grid" id="infoGeneral"></div>
                    </div>
                </div>

                <!-- Productos Utilizados -->
                <div class="card">
                    <div class="card-header">
                        <h2>üß™ Productos Utilizados</h2>
                    </div>
                    <div class="card-body">
                        <div id="productosContainer"></div>
                    </div>
                </div>

                <!-- Puntos de Control -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìç Puntos de Control Revisados</h2>
                    </div>
                    <div class="card-body">
                        <div id="puntosContainer"></div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìù Observaciones Generales</h2>
                    </div>
                    <div class="card-body">
                        <div id="observacionesContainer"></div>
                    </div>
                </div>

                <!-- Firma del T√©cnico -->
                <div class="card">
                    <div class="card-header">
                        <h2>‚úçÔ∏è Firma del T√©cnico</h2>
                    </div>
                    <div class="card-body">
                        <div id="selloContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../ts/auth.js"></script>
    
    <script>
        // Usar el cliente de Supabase del auth.js
        const supabase = window.supabaseClient;
        let controlData = null;
        let workerProfile = null;

        // Obtener ID del control desde URL
        const urlParams = new URLSearchParams(window.location.search);
        const controlId = urlParams.get('id');

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Iniciando visualizaci√≥n del control...');
                
                // Verificar que tenemos un ID
                if (!controlId) {
                    alert('‚ùå ID de control no especificado');
                    window.location.href = 'controles.html';
                    return;
                }

                // Esperar a que auth.js se inicialice
                await new Promise(resolve => setTimeout(resolve, 500));

                // Verificar autenticaci√≥n
                if (!window.authUtils) {
                    alert('‚ùå Sistema de autenticaci√≥n no disponible');
                    window.location.href = 'login.html';
                    return;
                }

                workerProfile = await window.authUtils.getWorkerProfile();
                
                if (!workerProfile) {
                    alert('‚ùå Debes iniciar sesi√≥n primero');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('‚úÖ Usuario autenticado:', workerProfile);

                // Cargar datos del control
                await cargarControl();

            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                alert('Error al cargar el control: ' + error.message);
                window.location.href = 'controles.html';
            }
        });

        /**
         * Cargar informaci√≥n completa del control
         */
        async function cargarControl() {
            try {
                console.log('üì• Cargando control ID:', controlId);

                // Obtener control principal con informaci√≥n relacionada
                const { data: control, error: controlError } = await supabase
                    .from('controles')
                    .select(`
                        *,
                        cliente:clientes!controles_cliente_id_fkey(cliente_id, nombre),
                        planta:plantas!controles_planta_id_fkey(planta_id, nombre),
                        tecnico:worker!controles_tecnico_id_fkey(worker_id, nombre, puesto)
                    `)
                    .eq('control_id', controlId)
                    .eq('empresa_id', workerProfile.empresa_id)
                    .single();

                if (controlError) throw controlError;
                if (!control) throw new Error('Control no encontrado');

                controlData = control;
                console.log('‚úÖ Control cargado:', control);

                // Cargar productos
                const { data: productos, error: prodError } = await supabase
                    .from('control_productos')
                    .select(`
                        *,
                        producto:productos!control_productos_producto_id_fkey(producto_id, nombre, tipo_producto, principio_activo, laboratorio, certificado, unidad_medida)
                    `)
                    .eq('control_id', controlId);

                if (prodError) throw prodError;

                // Cargar puntos
                const { data: puntos, error: puntosError } = await supabase
                    .from('control_puntos')
                    .select('*')
                    .eq('control_id', controlId)
                    .order('numero_punto', { ascending: true });

                if (puntosError) throw puntosError;

                console.log('‚úÖ Productos:', productos?.length || 0);
                console.log('‚úÖ Puntos:', puntos?.length || 0);

                // GUARDAR productos y puntos en controlData para el PDF
                controlData.productos = productos || [];
                controlData.puntos = puntos || [];

                // Renderizar todo
                renderizarControl(control, productos, puntos);

                // Ocultar loading y mostrar contenido
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('controlContent').style.display = 'block';

            } catch (error) {
                console.error('‚ùå Error cargando control:', error);
                throw error;
            }
        }

        /**
         * Renderizar informaci√≥n del control
         */
        function renderizarControl(control, productos, puntos) {
            // T√≠tulo
            document.getElementById('controlTitle').textContent = 
                `üìã Control #${control.control_id.split('-')[0]}`;
            
            document.getElementById('controlSubtitle').textContent = 
                `Control de ${control.tipo_control} - ${formatearFecha(control.fecha_control)}`;

            // Informaci√≥n general
            const infoGeneral = document.getElementById('infoGeneral');
            infoGeneral.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Cliente</span>
                    <span class="info-value">${control.cliente?.nombre || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Planta</span>
                    <span class="info-value ${!control.planta ? 'empty' : ''}">${control.planta?.nombre || 'Sin planta espec√≠fica'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">T√©cnico Responsable</span>
                    <span class="info-value">${control.tecnico?.nombre || 'N/A'}${control.tecnico?.puesto ? ' - ' + control.tecnico.puesto : ''}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Fecha del Control</span>
                    <span class="info-value">${formatearFecha(control.fecha_control)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Tipo de Control</span>
                    <span class="info-value">
                        <span class="badge badge-${control.tipo_control}">${formatearTipoControl(control.tipo_control)}</span>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Estado</span>
                    <span class="info-value">
                        <span class="badge badge-${control.estado}">${formatearEstado(control.estado)}</span>
                    </span>
                </div>
            `;

            // Productos
            renderizarProductos(productos);

            // Puntos
            renderizarPuntos(puntos);

            // Observaciones
            renderizarObservaciones(control.observaciones);

            // Sello
            renderizarSello(control.firma_tecnico);
        }

        /**
         * Renderizar tabla de productos
         */
        function renderizarProductos(productos) {
            const container = document.getElementById('productosContainer');
            
            if (!productos || productos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p class="empty-state-message">No se utilizaron productos en este control</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Unidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productos.map(p => `
                                <tr>
                                    <td><strong>${p.producto?.nombre || 'Producto desconocido'}</strong></td>
                                    <td>${p.cantidad_usada}</td>
                                    <td>${p.unidad || p.producto?.unidad_medida || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        /**
         * Renderizar tabla de puntos agrupados por tipo de plaga
         */
        function renderizarPuntos(puntos) {
            const container = document.getElementById('puntosContainer');
            
            if (!puntos || puntos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <p class="empty-state-message">No se revisaron puntos de control espec√≠ficos</p>
                    </div>
                `;
                return;
            }

            // Agrupar por tipo de plaga (normalizado a min√∫sculas)
            const grupos = {
                'roedores': [],
                'voladores': [],
                'rastreros': []
            };
            
            puntos.forEach(punto => {
                const tipoPlaga = punto.tipo_plaga.toLowerCase();
                if (grupos[tipoPlaga]) {
                    grupos[tipoPlaga].push(punto);
                }
            });
            
            // Ordenar cada grupo por n√∫mero de punto
            Object.keys(grupos).forEach(tipo => {
                grupos[tipo].sort((a, b) => a.numero_punto - b.numero_punto);
            });
            
            // Configuraci√≥n de tipos
            const tiposConfig = {
                'roedores': { icono: 'üê≠', nombre: 'Roedores' },
                'voladores': { icono: 'ü¶ü', nombre: 'Voladores' },
                'rastreros': { icono: 'üêú', nombre: 'Rastreros' }
            };
            
            let html = '';
            
            Object.keys(grupos).forEach(tipoPlaga => {
                if (grupos[tipoPlaga].length > 0) {
                    const config = tiposConfig[tipoPlaga];
                    
                    html += `
                        <div class="grupo-puntos-control">
                            <h3 class="grupo-titulo-control">${config.icono} ${config.nombre} (${grupos[tipoPlaga].length} puntos)</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Punto</th>
                                            <th>Dispositivo</th>
                                            <th>Ubicaci√≥n</th>
                                            <th>Estado</th>
                                            <th>Acci√≥n Realizada</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${grupos[tipoPlaga].map(p => `
                                            <tr>
                                                <td><strong>#${p.numero_punto}</strong></td>
                                                <td>${p.tipo_dispositivo || '-'}</td>
                                                <td>${p.ubicacion || '-'}</td>
                                                <td><span class="badge badge-${p.estado}">${formatearEstadoPunto(p.estado)}</span></td>
                                                <td>${p.accion_realizada || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        /**
         * Renderizar observaciones
         */
        function renderizarObservaciones(observaciones) {
            const container = document.getElementById('observacionesContainer');
            
            if (!observaciones || observaciones.trim() === '') {
                container.innerHTML = `
                    <div class="observaciones-text empty">
                        Sin observaciones registradas
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="observaciones-text">${observaciones}</div>
                `;
            }
        }

        /**
         * Renderizar sello del t√©cnico
         */
        function renderizarSello(selloUrl) {
            const container = document.getElementById('selloContainer');
            
            if (!selloUrl) {
                container.innerHTML = `
                    <div class="sello-container">
                        <div class="sello-placeholder">
                            <p>üë§ Sin firma/sello del t√©cnico</p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="sello-container">
                        <img src="${selloUrl}" alt="Firma del t√©cnico" class="sello-img">
                    </div>
                `;
            }
        }

        /**
         * Formatear fecha
         */
        function formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        /**
         * Formatear tipo de control
         */
        function formatearTipoControl(tipo) {
            const tipos = {
                'preventivo': 'Preventivo',
                'correctivo': 'Correctivo',
                'especial': 'Especial'
            };
            return tipos[tipo] || tipo;
        }

        /**
         * Formatear estado
         */
        function formatearEstado(estado) {
            const estados = {
                'completado': 'Completado',
                'pendiente': 'Pendiente',
                'en_progreso': 'En Progreso'
            };
            return estados[estado] || estado;
        }

        /**
         * Formatear tipo de plaga
         */
        function formatearTipoPlaga(tipo) {
            const tipos = {
                'roedores': 'Roedores',
                'voladores': 'Voladores',
                'rastreros': 'Rastreros'
            };
            return tipos[tipo] || tipo;
        }

        /**
         * Formatear estado de punto
         */
        function formatearEstadoPunto(estado) {
            const estados = {
                'ok': 'OK',
                'con_actividad': 'Con Actividad',
                'faltante': 'Faltante',
                'reemplazado': 'Reemplazado'
            };
            return estados[estado] || estado;
        }

        /**
         * Editar control
         */
        function editarControl() {
            window.location.href = `nuevo-control.html?id=${controlId}`;
        }

        /**
         * Generar PDF del control usando HTML
         */
        async function generarPDF() {
            if (!controlData) {
                alert('No hay datos del control para generar PDF');
                return;
            }

            try {
                console.log('Iniciando generaci√≥n de PDF...');
                
                // Mostrar estado de carga
                const btnGenerarPDF = event.target;
                const btnTextoOriginal = btnGenerarPDF ? btnGenerarPDF.innerHTML : null;
                if (btnGenerarPDF) {
                    btnGenerarPDF.disabled = true;
                    btnGenerarPDF.innerHTML = 'Generando PDF...';
                }

                // ===== CARGAR LOGO DE LA EMPRESA =====
                let logoBase64 = '';
                try {
                    const { data: files, error: filesError } = await supabase.storage
                        .from('empresas')
                        .list(`${workerProfile.empresa_id}/logo`);

                    if (!filesError && files && files.length > 0) {
                        const logoFile = files[0];
                        const logoPath = `${workerProfile.empresa_id}/logo/${logoFile.name}`;
                        
                        const { data: signedUrlData, error: urlError } = await supabase.storage
                            .from('empresas')
                            .createSignedUrl(logoPath, 60);

                        if (!urlError && signedUrlData?.signedUrl) {
                            logoBase64 = await urlToBase64(signedUrlData.signedUrl);
                            console.log('Logo cargado');
                        }
                    }
                } catch (error) {
                    console.warn('No se pudo cargar logo:', error);
                }

                // ===== CARGAR FIRMA DEL T√âCNICO =====
                let firmaBase64 = '';
                if (controlData.firma_tecnico) {
                    try {
                        let storagePath = controlData.firma_tecnico;
                        if (storagePath.startsWith('workers/')) {
                            storagePath = storagePath.replace('workers/', '');
                        }

                        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
                            .from('workers')
                            .createSignedUrl(storagePath, 60);

                        if (!signedUrlError && signedUrlData?.signedUrl) {
                            firmaBase64 = await urlToBase64(signedUrlData.signedUrl);
                            console.log('Firma cargada');
                        }
                    } catch (error) {
                        console.error('Error cargando firma:', error);
                    }
                }

                // ===== GENERAR HTML COMPLETO (sin firma, la agregaremos despu√©s) =====
                const htmlContent = generarHTMLParaPDF(logoBase64, null, controlData);

                // ===== CONVERTIR HTML A PDF =====
                const element = document.createElement('div');
                element.innerHTML = htmlContent;
                element.style.width = '210mm'; // A4 width
                element.style.backgroundColor = 'white';
                element.style.padding = '0';
                document.body.appendChild(element);

                // Usar html2canvas para capturar el HTML
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                document.body.removeChild(element);

                // Crear PDF con jsPDF
                const { jsPDF } = window.jspdf;
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                let position = 0;
                const pageHeight = 297; // A4 height in mm

                // Si el contenido es m√°s alto que una p√°gina, dividir en m√∫ltiples p√°ginas
                if (imgHeight > pageHeight) {
                    let heightLeft = imgHeight;
                    
                    while (heightLeft > 0) {
                        if (position > 0) {
                            pdf.addPage();
                        }
                        
                        pdf.addImage(
                            canvas.toDataURL('image/png'),
                            'PNG',
                            0,
                            position === 0 ? 0 : -position,
                            imgWidth,
                            imgHeight
                        );
                        
                        heightLeft -= pageHeight;
                        position += pageHeight;
                    }
                } else {
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                }

                // ===== AGREGAR FIRMA EN LA √öLTIMA P√ÅGINA (sin cortes) =====
                if (firmaBase64) {
                    // Crear un elemento temporal para la firma
                    const firmaElement = document.createElement('div');
                    firmaElement.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: white;">
                            <img src="${firmaBase64}" alt="Firma" style="width: 200px; height: auto; margin-bottom: 10px;" />
                            <p style="font-size: 14px; color: #333; margin: 0;">Firmado por: ${controlData.tecnico?.nombre || 'T√©cnico'}</p>
                        </div>
                    `;
                    firmaElement.style.width = '210mm';
                    firmaElement.style.backgroundColor = 'white';
                    document.body.appendChild(firmaElement);

                    // Capturar solo la firma
                    const firmaCanvas = await html2canvas(firmaElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });

                    document.body.removeChild(firmaElement);

                    // Calcular posici√≥n para la firma en la √∫ltima p√°gina
                    const firmaHeight = (firmaCanvas.height * imgWidth) / firmaCanvas.width;
                    const espacioDisponible = pageHeight - ((imgHeight % pageHeight) || pageHeight);
                    
                    // Si no hay suficiente espacio, agregar nueva p√°gina
                    if (espacioDisponible < firmaHeight + 20) {
                        pdf.addPage();
                        pdf.addImage(firmaCanvas.toDataURL('image/png'), 'PNG', 5, 20, 200, firmaHeight);
                    } else {
                        // Agregar en el espacio disponible de la √∫ltima p√°gina
                        const yPosition = (imgHeight % pageHeight) || (imgHeight - pageHeight);
                        pdf.addImage(firmaCanvas.toDataURL('image/png'), 'PNG', 5, yPosition + 10, 200, firmaHeight);
                    }
                }

                // Guardar PDF
                const fecha = controlData.fecha_control.replace(/-/g, '');
                const cliente = (controlData.cliente?.nombre || 'Control').substring(0, 15).replace(/\s+/g, '_');
                const nombreArchivo = `MIP_SanAgustin_${cliente}_${fecha}.pdf`;
                pdf.save(nombreArchivo);

                console.log('PDF generado exitosamente:', nombreArchivo);

                // Restaurar bot√≥n
                if (btnGenerarPDF && btnTextoOriginal) {
                    btnGenerarPDF.disabled = false;
                    btnGenerarPDF.innerHTML = btnTextoOriginal;
                }

            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF: ' + error.message);
                
                const btnGenerarPDF = event.target;
                if (btnGenerarPDF) {
                    btnGenerarPDF.disabled = false;
                    btnGenerarPDF.innerHTML = 'Generar PDF';
                }
            }
        }

        /**
         * Generar HTML para PDF (similar a la app actual)
         */
        function generarHTMLParaPDF(logoBase64, firmaBase64, controlData) {
            // Estilos base m√°s cercanos al PDF real
            const estiloTitulo = 'margin: 15px 0 8px 0; font-size: 14px; font-weight: bold; color: #000;';
            const estiloHeaderTabla = 'border: 0.5px solid #666; padding: 6px 8px; text-align: center; font-weight: bold; background-color: #f5f5f5; font-size: 11px;';
            const estiloCeldaTabla = 'border: 0.5px solid #666; padding: 6px 8px; text-align: center; font-size: 10px;';
            
            let html = `
                <div style="margin: 30px; padding: 20px; font-family: Arial, sans-serif; background: white;">
                    <!-- ENCABEZADO CON LOGO -->
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 30px;">
                        ${logoBase64 ? `<img src="${logoBase64}" alt="Logo" style="width: 80px; height: auto; margin-right: 20px;"/>` : ''}
                        <h1 style="margin: 0; color: #000; font-size: 20px; font-weight: bold;">Planilla de M.I.P SAN AGUSTIN</h1>
                    </div>
            `;

            // ===== TABLA EMPRESA =====
            html += `
                <h2 style="${estiloTitulo}">Empresa</h2>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr>
                        <th style="${estiloHeaderTabla}">Cliente</th>
                        <th style="${estiloHeaderTabla}">Planta</th>
                        <th style="${estiloHeaderTabla}">Fecha</th>
                    </tr>
                    <tr>
                        <td style="${estiloCeldaTabla}">${controlData.cliente?.nombre || 'N/A'}</td>
                        <td style="${estiloCeldaTabla}">${controlData.planta?.nombre || 'N/A'}</td>
                        <td style="${estiloCeldaTabla}">${formatearFecha(controlData.fecha_control)}</td>
                    </tr>
                </table>
            `;

            // ===== TABLA PRODUCTOS =====
            if (controlData.productos && controlData.productos.length > 0) {
                html += `
                    <h2 style="${estiloTitulo}">Productos</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <th style="${estiloHeaderTabla}">Producto</th>
                            <th style="${estiloHeaderTabla}">Tipo</th>
                            <th style="${estiloHeaderTabla}">PrincipioActivo</th>
                            <th style="${estiloHeaderTabla}">Laboratorio</th>
                            <th style="${estiloHeaderTabla}">Certificado</th>
                        </tr>
                `;
                
                controlData.productos.forEach(producto => {
                    html += `
                        <tr>
                            <td style="${estiloCeldaTabla}">${producto.producto?.nombre || '-'}</td>
                            <td style="${estiloCeldaTabla}">${producto.producto?.tipo_producto || '-'}</td>
                            <td style="${estiloCeldaTabla}">${producto.producto?.principio_activo || '-'}</td>
                            <td style="${estiloCeldaTabla}">${producto.producto?.laboratorio || '-'}</td>
                            <td style="${estiloCeldaTabla}">${producto.producto?.certificado || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== TABLA ROEDORES =====
            const roedores = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'roedores') : [];
            if (roedores.length > 0) {
                html += `
                    <h2 style="${estiloTitulo}">Roedores</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <th style="${estiloHeaderTabla}">Caja</th>
                            <th style="${estiloHeaderTabla}">Vivos</th>
                            <th style="${estiloHeaderTabla}">Muertos</th>
                            <th style="${estiloHeaderTabla}">TipoTrampa</th>
                            <th style="${estiloHeaderTabla}">MateriaFecal</th>
                            <th style="${estiloHeaderTabla}">ConsumoCebos</th>
                            <th style="${estiloHeaderTabla}">Reposici√≥n</th>
                            <th style="${estiloHeaderTabla}">Observaciones</th>
                        </tr>
                `;
                
                roedores.forEach(punto => {
                    let datosAdicionales = {};
                    if (punto.descripcion_actividad) {
                        try {
                            datosAdicionales = JSON.parse(punto.descripcion_actividad);
                        } catch (e) {}
                    }
                    const p = { ...punto, ...datosAdicionales };
                    
                    html += `
                        <tr>
                            <td style="${estiloCeldaTabla}">${p.caja_n || p.numero_punto || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.vivos || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.muertos || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.tipo_trampa || p.tipo_dispositivo || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.materia_fecal || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.consumo || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.reposicion || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.observaciones || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== TABLA VOLADORES =====
            const voladores = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'voladores') : [];
            if (voladores.length > 0) {
                html += `
                    <h2 style="${estiloTitulo}">Voladores</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <th style="${estiloHeaderTabla}">UV</th>
                            <th style="${estiloHeaderTabla}">Densidad</th>
                            <th style="${estiloHeaderTabla}">Reposici√≥n</th>
                            <th style="${estiloHeaderTabla}">Observaciones</th>
                        </tr>
                `;
                
                voladores.forEach(punto => {
                    let datosAdicionales = {};
                    if (punto.descripcion_actividad) {
                        try {
                            datosAdicionales = JSON.parse(punto.descripcion_actividad);
                        } catch (e) {}
                    }
                    const p = { ...punto, ...datosAdicionales };
                    
                    // Usar el campo densidad directamente (baja, media, alta)
                    const densidad = p.densidad || p.nivel_infestacion || '-';
                    
                    html += `
                        <tr>
                            <td style="${estiloCeldaTabla}">${p.caja_uv_n || p.numero_punto || '-'}</td>
                            <td style="${estiloCeldaTabla}">${densidad}</td>
                            <td style="${estiloCeldaTabla}">${p.reposicion || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.observaciones || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== TABLA RASTREROS =====
            const rastreros = controlData.puntos ? controlData.puntos.filter(p => p.tipo_plaga.toLowerCase() === 'rastreros') : [];
            if (rastreros.length > 0) {
                html += `
                    <h2 style="${estiloTitulo}">Rastreros</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <th style="${estiloHeaderTabla}">√Årea</th>
                            <th style="${estiloHeaderTabla}">Plaga</th>
                            <th style="${estiloHeaderTabla}">Nivel</th>
                            <th style="${estiloHeaderTabla}">Producto</th>
                            <th style="${estiloHeaderTabla}">Observaciones</th>
                        </tr>
                `;
                
                rastreros.forEach(punto => {
                    let datosAdicionales = {};
                    if (punto.descripcion_actividad) {
                        try {
                            datosAdicionales = JSON.parse(punto.descripcion_actividad);
                        } catch (e) {}
                    }
                    const p = { ...punto, ...datosAdicionales };
                    
                    html += `
                        <tr>
                            <td style="${estiloCeldaTabla}">${p.area || p.numero_punto || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.nombre_plaga || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.nivel_infestacion || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.producto_aplicado_nombre || '-'}</td>
                            <td style="${estiloCeldaTabla}">${p.observaciones || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `</table>`;
            }

            // ===== OBSERVACIONES =====
            if (controlData.observaciones) {
                html += `
                    <h2 style="${estiloTitulo}">Observaciones</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <th style="${estiloHeaderTabla}">Observaciones</th>
                        </tr>
                        <tr>
                            <td style="${estiloCeldaTabla} text-align: left; padding: 12px;">${controlData.observaciones}</td>
                        </tr>
                    </table>
                `;
            }

            // ===== LEYENDA R.P. y N.A. =====
            html += `
                <div style="margin-top: 20px; margin-bottom: 30px; padding: 12px; border: 0.5px solid #666; background-color: #f9f9f9;">
                    <ul style="font-size: 10px; padding-left: 20px; color: #000; margin: 5px 0; list-style-type: disc;">
                        <li><strong>R.P</strong>: Refuerzo Provisorio</li>
                        <li><strong>N.A</strong>: No Aplica</li>
                    </ul>
                </div>
            `;

            // ===== FIRMA (solo si se proporciona) =====
            if (firmaBase64) {
                html += `
                    <div style="text-align: center; margin-top: 30px; margin-bottom: 20px;">
                        <img src="${firmaBase64}" alt="Firma" style="width: 200px; height: auto;" />
                        <p style="font-size: 11px; color: #333; margin-top: 10px; font-weight: bold;">Firmado por: ${controlData.tecnico?.nombre || 'T√©cnico'}</p>
                    </div>
                `;
            }

            html += `</div>`;
            
            return html;
        }

        /**
         * Convertir URL de imagen a Base64
         */
        async function urlToBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                img.onerror = function(error) {
                    console.error('Error al cargar imagen:', error);
                    reject(error);
                };
                img.src = url;
            });
        }

        /**
         * Eliminar control
         */
        async function eliminarControl() {
            if (!confirm('‚ö†Ô∏è ¬øEst√° seguro de que desea eliminar este control?\n\nEsta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Eliminando control...');

                // Eliminar control (los productos y puntos se eliminar√°n autom√°ticamente por CASCADE)
                const { error } = await supabase
                    .from('controles')
                    .delete()
                    .eq('control_id', controlId)
                    .eq('empresa_id', workerProfile.empresa_id);

                if (error) throw error;

                alert('‚úÖ Control eliminado exitosamente');
                window.location.href = 'controles.html';

            } catch (error) {
                console.error('‚ùå Error eliminando control:', error);
                alert('Error al eliminar control: ' + error.message);
            }
        }
    </script>
</body>
</html>
